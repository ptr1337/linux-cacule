From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-18.8 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_PATCH,
	MAILING_LIST_MULTI,MENTIONS_GIT_HOSTING,SPF_HELO_NONE,SPF_PASS,USER_AGENT_GIT
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id A4F4DC433F5
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:00:57 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 7BC1E60295
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:00:57 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1351932AbhIHPCE (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 11:02:04 -0400
Received: from mail-bn8nam12on2086.outbound.protection.outlook.com ([40.107.237.86]:15393
        "EHLO NAM12-BN8-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1344637AbhIHPCA (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 11:02:00 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=aY/HY45Qe+NDsHPNmeoUcgAya5M57qAj0igAR2n0i2QtjNNX7rJ2MEd9tN5I/u+QHZHQRR+dtZe9uvZOUvHc1urqdGaPqZ3HDoMIZDpdvPBmG4qWtau8f+UQuThfPiSagoLdkcXkZ9MMY7TYnkB1HlpsFQOZVZzHcwnX+nbzva9uo8Zv7MPQeLxVaqguByjMo4P9WAySC5ORVGYN24dX91z6vyGxNfg6g9vdGDHEiVmp8P2mp0BeaBAXcWo80JCJqY4fI/vIa/ZSzNgBWWRMPPVf5cwcHwKh+P5OFAafm6br4a5/SB6hBkY212FPX+s6vWGag3IuOeDmlZzml6Jt4A==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=CmCwZ/aNLFJtzjMuekzZpewcdAy34hK9Tvkho7Ea4TM=;
 b=BOI4djodTe41XkY6Ww3t0eRe+WMwV51EGI5MyLIE85WAUOi8tRVCqVz6uU9E4utdZmQkfJfR2QNTjjhLoCPz1hpRDEgm5QAOCnWZYYUsiO7zWtPB7fWeuh9V3xqHii47w/pIdWOiUBP9vR6xcSzHqt+6mU+s9ETd0m+QIqnjax6Trw5/aBDKsITpGPjFVkZ0Sd7EyAVy/pbfXUaolV6go62QAZsX+npJhY0OZgfFaTqOpnTmBA0T4vLEqc82T1OebAMkEm5fjCP2KAyFU00vkm1pf170QeQ4UaSAA9if6m7o6MH/+43XxZcYMq0nIEL0jFbl+7rqoNTShq/KddExPg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=CmCwZ/aNLFJtzjMuekzZpewcdAy34hK9Tvkho7Ea4TM=;
 b=TuQFws7i68t9RHEQJQ+T/JVxj27etwxs25vX2yNiWIjSajQ0Ok2EJkf2N0lKwQwBoNpitFZwRuFj2J/4HTpdI7lDvPZ00rX1QfvnymAztj5nXbC+Vwm5gTf8gk/QossFP9dtB53f68wbqHF87DQYwtLb+Au1uo2XjnMQMcNjDPA=
Received: from MW4PR03CA0295.namprd03.prod.outlook.com (2603:10b6:303:b5::30)
 by DM6PR12MB2956.namprd12.prod.outlook.com (2603:10b6:5:182::10) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14; Wed, 8 Sep
 2021 15:00:50 +0000
Received: from CO1NAM11FT011.eop-nam11.prod.protection.outlook.com
 (2603:10b6:303:b5:cafe::f0) by MW4PR03CA0295.outlook.office365.com
 (2603:10b6:303:b5::30) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Wed, 8 Sep 2021 15:00:50 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CO1NAM11FT011.mail.protection.outlook.com (10.13.175.186) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 15:00:50 +0000
Received: from hr-amd.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Wed, 8 Sep 2021
 10:00:45 -0500
From:   Huang Rui <ray.huang@amd.com>
To:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        <linux-pm@vger.kernel.org>
CC:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        <linux-kernel@vger.kernel.org>, <x86@kernel.org>,
        Huang Rui <ray.huang@amd.com>
Subject: [PATCH 00/19] cpufreq: introduce a new AMD CPU frequency control mechanism
Date:   Wed, 8 Sep 2021 22:59:42 +0800
Message-ID: <20210908150001.3702552-1-ray.huang@amd.com>
X-Mailer: git-send-email 2.25.1
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Type: text/plain
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: b540a0ac-89fe-44bf-a4d4-08d972d9725b
X-MS-TrafficTypeDiagnostic: DM6PR12MB2956:
X-Microsoft-Antispam-PRVS: <DM6PR12MB295664D14149ABD1CFE7B325ECD49@DM6PR12MB2956.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:4714;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: goniq85ZIN12Q6n7fP1L7CAnK2tnwN5TWGSm+jM2/EAPjubj01nRyyQrJ3TXVPKX5ZAqqNAe0IdN8xYghN91Wyr3KlOEW5pzq/c4Nes6YzSD5MnVAeBvPUGCj5Vg7lmYilFal6p4cj2I0tJw2r2tJA57lhP97EA9noM9yB7lR/MJRXsehWAaxyxb8tKJC/V8unpmiSyIk5F9SLe8cYNQKD3WCt9CTMeEFwaYg6bCCwY1feWCuamdwfgriaqgfuM/K7r895Jot6RRzxxJukJGMPHMLyw7f5xs/tEMRvpy5pvfIKOuGnIHYbKj480FSrgAmxLo1H89EcxrgjqCzm9RwGY3r9y47EYyJmTzf8sFGpe4qp6GsgCpVp01f81NHIEAFsXbxL1V5XYgaqM6tun5E0wMPKartbtp8sTo9XWXKEt18Z7S5Mkph3siMH1TLuHmsN/iSSDeerO4xryE0ru9Xyyqc6slDQ+HwI1A4TNQrOIeigMpS8Agli7rkEqnUmtdHCAtvS3clcEsUhI/S1HOVDWD4FIoIxo2OkpqF+78dyxim+YxGBXZtzFsweioGo+8YZY6UHOQ6nwHOYPy5lKZZWq6AmuKIdwqDeRIEjFC0WxNTR6p3toqcOf0KWco4oDeErHyTh3jHQYJBo/62JCliIaOwMZPJl2D1vUWN2WF8OK260t3/qTJ6vKs4BNP4OM8qjcOpBMIUT/JjeEB1SD3eauH22hPcN3FmkpePZ2vxkTnx1M0I/vH+OpoRCjp4rgVwehVDMpiS6Cz3gzp6XKOWAe9iJ+xtLS4lmmCHxsRrZ7HkBKitd3Ov6fbHODXQGCDQqmCHnPjrf90rTq4TnDYeVpMQNtNrVB1AtBIX/jduYg=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(136003)(396003)(346002)(376002)(39860400002)(36840700001)(46966006)(5660300002)(336012)(356005)(81166007)(316002)(7696005)(70586007)(70206006)(110136005)(82310400003)(2906002)(54906003)(47076005)(1076003)(478600001)(8936002)(6666004)(8676002)(26005)(966005)(83380400001)(4326008)(186003)(36756003)(36860700001)(16526019)(426003)(2616005)(86362001)(82740400003)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 15:00:50.0102
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: b540a0ac-89fe-44bf-a4d4-08d972d9725b
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: CO1NAM11FT011.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB2956
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Hi all,

We would like to introduce a new AMD CPU frequency control mechanism as the
"amd-pstate" driver for modern AMD Zen based CPU series in Linux Kernel.
The new mechanism is based on Collaborative processor performance control
(CPPC) which is finer grain frequency management than legacy ACPI hardware
P-States. Current AMD CPU platforms are using the ACPI P-states driver to
manage CPU frequency and clocks with switching only in 3 P-states. AMD
P-States is to replace the ACPI P-states controls, allows a flexible,
low-latency interface for the Linux kernel to directly communicate the
performance hints to hardware.

"amd-pstate" leverages the Linux kernel governors such as *schedutil*,
*ondemand*, etc. to manage the performance hints which are provided by CPPC
hardware functionality. The first version for amd-pstate is to support one
of the Zen3 processors, and we will support more in future after we verify
the hardware and SBIOS functionalities.

There are two types of hardware implementations for amd-pstate: one is full
MSR support and another is shared memory support. It can use
X86_FEATURE_AMD_CPPC_EXT feature flag to distinguish the different types. 

Using the new AMD P-States method + kernel governors (*schedutil*,
*ondemand*, ...) to manage the frequency update is the most appropriate
bridge between AMD Zen based hardware processor and Linux kernel, the
processor is able to ajust to the most efficiency frequency according to
the kernel scheduler loading.

Performance Per Watt (PPW) Caculation:

The PPW caculation is referred by below paper:
https://software.intel.com/content/dam/develop/external/us/en/documents/performance-per-what-paper.pdf

Below formula is referred from below spec to measure the PPW:

(F / t) / P = F * t / (t * E) = F / E,

"F" is the number of frames per second.
"P" is power measurd in watts.
"E" is energy measured in joules.

We use the RAPL interface with "perf" tool to get the energy data of the
package power.

The data comparsions between amd-pstate and acpi-freq module are tested on
AMD Cezanne processor:

1) TBench CPU benchmark:

+---------------------------------------------------------------------+
|                                                                     |
|               TBench (Performance Per Watt)                         |
|                                                    Higher is better |
+-------------------+------------------------+------------------------+
|                   |  Performance Per Watt  |  Performance Per Watt  |
|   Kernel Module   |       (Schedutil)      |       (Ondemand)       |
|                   |  Unit: MB / (s * J)    |  Unit: MB / (s * J)    |
+-------------------+------------------------+------------------------+
|                   |                        |                        |
|    acpi-cpufreq   |         3.022          |        2.969           |
|                   |                        |                        |
+-------------------+------------------------+------------------------+
|                   |                        |                        |
|     amd-pstate    |         3.131          |        3.284           |
|                   |                        |                        |
+-------------------+------------------------+------------------------+

2) Gitsource CPU benchmark:

+---------------------------------------------------------------------+
|                                                                     |
|               Gitsource (Performance Per Watt)                      |
|                                                    Higher is better |
+-------------------+------------------------+------------------------+
|                   |  Performance Per Watt  |  Performance Per Watt  |
|   Kernel Module   |       (Schedutil)      |       (Ondemand)       |
|                   |  Unit: 1 / (s * J)     |  Unit: 1 / (s * J)     |
+-------------------+------------------------+------------------------+
|                   |                        |                        |
|    acpi-cpufreq   |     3.42172E-07        |     2.74508E-07        |
|                   |                        |                        |
+-------------------+------------------------+------------------------+
|                   |                        |                        |
|     amd-pstate    |     4.09141E-07        |     3.47610E-07        |
|                   |                        |                        |
+-------------------+------------------------+------------------------+

3) Speedometer 2.0 CPU benchmark:

+---------------------------------------------------------------------+
|                                                                     |
|               Speedometer 2.0 (Performance Per Watt)                |
|                                                    Higher is better |
+-------------------+------------------------+------------------------+
|                   |  Performance Per Watt  |  Performance Per Watt  |
|   Kernel Module   |       (Schedutil)      |       (Ondemand)       |
|                   |  Unit: 1 / (s * J)     |  Unit: 1 / (s * J)     |
+-------------------+------------------------+------------------------+
|                   |                        |                        |
|    acpi-cpufreq   |      0.116111767       |      0.110321664       |
|                   |                        |                        |
+-------------------+------------------------+------------------------+
|                   |                        |                        |
|     amd-pstate    |      0.115825281       |      0.122024299       |
|                   |                        |                        |
+-------------------+------------------------+------------------------+


According to above average data, we can see this solution has shown better
performance per watt scaling on mobile CPU benchmarks in most of cases.

These patch series depends on a "hotplug capable" CPU fix below (Only few
of CPU parts with "un-hotplug" core will encounter the issue and Mario is
working on the fix):
https://lore.kernel.org/linux-pm/20210813161842.222414-1-mario.limonciello@amd.com/

And we can see patch series in below git repo:
https://git.kernel.org/pub/scm/linux/kernel/git/rui/linux.git/log/?h=amd-pstate-dev-v1

For details introduction, please see the patch 19.

Thanks,
Ray

Huang Rui (18):
  x86/cpufreatures: add AMD CPPC extension feature flag
  x86/msr: add AMD CPPC MSR definitions
  cpufreq: amd: introduce a new amd pstate driver to support future
    processors
  cpufreq: amd: add fast switch function for amd-pstate module
  cpufreq: amd: add acpi cppc function as the backend for legacy
    processors
  cpufreq: amd: add trace for amd-pstate module
  cpufreq: amd: add boost mode support for amd-pstate
  cpufreq: amd: add amd-pstate checking support check attribute
  cpufreq: amd: add amd-pstate frequencies attributes
  cpufreq: amd: add amd-pstate performance attributes
  cpupower: add AMD P-state capability flag
  cpupower: add the function to check amd-pstate enabled
  cpupower: initial AMD P-state capability
  cpupower: add amd-pstate sysfs entries into libcpufreq
  cpupower: enable boost state support for amd-pstate module
  cpupower: add amd-pstate get data function to query the info
  cpupower: print amd-pstate information on cpupower
  Documentation: amd-pstate: add amd-pstate driver introduction

Jinzhou Su (1):
  ACPI: CPPC: add cppc enable register function

 Documentation/admin-guide/pm/amd_pstate.rst   | 377 ++++++++
 .../admin-guide/pm/working-state.rst          |   1 +
 arch/x86/include/asm/cpufeatures.h            |   1 +
 arch/x86/include/asm/msr-index.h              |  17 +
 drivers/acpi/cppc_acpi.c                      |  42 +
 drivers/cpufreq/Kconfig.x86                   |  13 +
 drivers/cpufreq/Makefile                      |   5 +
 drivers/cpufreq/amd-pstate-trace.c            |   2 +
 drivers/cpufreq/amd-pstate-trace.h            |  96 +++
 drivers/cpufreq/amd-pstate.c                  | 812 ++++++++++++++++++
 include/acpi/cppc_acpi.h                      |   5 +
 tools/power/cpupower/lib/cpufreq.c            |  44 +-
 tools/power/cpupower/lib/cpufreq.h            |  16 +
 tools/power/cpupower/utils/cpufreq-info.c     |  27 +-
 tools/power/cpupower/utils/helpers/cpuid.c    |  13 +
 tools/power/cpupower/utils/helpers/helpers.h  |   6 +
 tools/power/cpupower/utils/helpers/misc.c     |  27 +
 17 files changed, 1500 insertions(+), 4 deletions(-)
 create mode 100644 Documentation/admin-guide/pm/amd_pstate.rst
 create mode 100644 drivers/cpufreq/amd-pstate-trace.c
 create mode 100644 drivers/cpufreq/amd-pstate-trace.h
 create mode 100644 drivers/cpufreq/amd-pstate.c

-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-18.8 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,USER_AGENT_GIT
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 8B934C4332F
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:00:59 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 7168B603E7
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:00:59 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1349413AbhIHPCG (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 11:02:06 -0400
Received: from mail-dm3nam07on2043.outbound.protection.outlook.com ([40.107.95.43]:17569
        "EHLO NAM02-DM3-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1351854AbhIHPCD (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 11:02:03 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=dXbh60QFGUrdzZ3CG9JgGyfKTkmsctA4i5S4Mmjl8k/n9ClCEee6F82GwYSLuvPcIddh+hxkUGQiQhtgq6lOKBNZx6Kl+XvwfmbNi2W3FeXvlmR9cneZmjusroKH8Y32oZf2yC1bbOBPi/AGSBz6s4qzBr2Ne/+IcxlsUyvCF+HdsJdu/3qwPJc83HLS33s0wOZFDytNH5G6HdsohlvuslsmyrKkoMEUk0S7Ua//jkfcsEyC2GUfR8uvxfl9MoQK66nxd+6AX0+Eje5smpZyvL10fq+Hia0Od/Fd6fOd4eOtz6OrjodoD4+/0hSWYryt/0uQq4howDl5+o89z+ci0w==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=jpOy2ILYGeosWhLGfF2b0lYNXeK36a2GMcNcggRa9W8=;
 b=C/dkQvxyiqRUwW6wlTjFQkJXOf8vw8EBMSG/xC+Hiav769CQV2xBpia1Rtt0YB6Jtn7PsSNTmYGv02LhIqPgXsf2qWNUpHAaR+4vDtkJIGRlCIvSBZNS1s0FhIK/KktSpX9FkFDHFJk7QxBH+UmH+9jUOUEM+MJ0C0JnRHpxDXh2hS2BnsryxHfi4XNi7l5FUqitWgtiwK05ekuNpbn3FN974LqCKKNdjKCE1Dj7AAFKybsQ25mFqSU6s2ZoVupxXp2p6riFP1FlFKEYv77DqgqRfjaftI+hl31otpXC7KBHJQL9msRGzJO6dQFmIYpiD+G4kugbautltMb1u/SqKg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=jpOy2ILYGeosWhLGfF2b0lYNXeK36a2GMcNcggRa9W8=;
 b=ZdA37U2s+qHg+MbnZ0mbkvDswgWU2hUcsgmzA3Px43MVYslCtV+xy7UFirlrxsA1sxCN3lfIloS3x5//uuKFsNjoaFm9YU/JF44RjrgbF0akKDt33Xyx80jHK05knQZkqBALXI/k/mDLJG0gKjRy/KaWRwPD5zmX5yVHXJToMmk=
Received: from MW4PR03CA0286.namprd03.prod.outlook.com (2603:10b6:303:b5::21)
 by BL1PR12MB5143.namprd12.prod.outlook.com (2603:10b6:208:31b::13) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4478.20; Wed, 8 Sep
 2021 15:00:54 +0000
Received: from CO1NAM11FT011.eop-nam11.prod.protection.outlook.com
 (2603:10b6:303:b5:cafe::3d) by MW4PR03CA0286.outlook.office365.com
 (2603:10b6:303:b5::21) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Wed, 8 Sep 2021 15:00:54 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CO1NAM11FT011.mail.protection.outlook.com (10.13.175.186) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 15:00:53 +0000
Received: from hr-amd.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Wed, 8 Sep 2021
 10:00:49 -0500
From:   Huang Rui <ray.huang@amd.com>
To:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        <linux-pm@vger.kernel.org>
CC:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        <linux-kernel@vger.kernel.org>, <x86@kernel.org>,
        Huang Rui <ray.huang@amd.com>
Subject: [PATCH 01/19] x86/cpufreatures: add AMD CPPC extension feature flag
Date:   Wed, 8 Sep 2021 22:59:43 +0800
Message-ID: <20210908150001.3702552-2-ray.huang@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210908150001.3702552-1-ray.huang@amd.com>
References: <20210908150001.3702552-1-ray.huang@amd.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Type: text/plain
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: f8407e99-1bb0-4470-3212-08d972d9749c
X-MS-TrafficTypeDiagnostic: BL1PR12MB5143:
X-Microsoft-Antispam-PRVS: <BL1PR12MB5143CE96F0BED8D37F306CE6ECD49@BL1PR12MB5143.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:1079;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: sYpfS/yh6Y0C13zxJKxTya3BBkte30C0phvrBlssQs3XK6y5+t+srMGiXsHxYsimEXnVRbHQfU5kpB0fmf3rAFoX/WfWuLezTypLQc59XDntKBreZN5tfPLP2MFzCNwQ0rGwz54AJyxgOyDEK+zLFeY5QSgJ6EKIeM0tQXAQk01hu0RwwDZTDI7SD9Sm0DeeMbwd9MV/8DUskJtyDm02sh0HcCy1drlhUS4vru4SFh4PcMDuV9o2QisKTD+Yo+J8v6PYi+I42gjrkQMCX821j386pqB3eQql2EgKgEJPlUMzk9fjP2bj/1ZovyFzt/gvL0Vr0dsBncyEPI8qUYZW7fx0RxOWEeEKSo3CSHNyZAyepldYy9N3XveuOJejadUDJxc1lUDCFgw1ntD1DCH9TIhrnUTnnM7nnGIZ1gMuzzzuc9qyOESHj1ZcSUj/8LR0n2uIiUUVj+nbpBzSjfszL0MxSUZUX9VukFgTDNQa05osVaeBAfHzBkF9N2X0m0s1Ur/OJJOt7DqeoNMQ5z4TWcj5TOMA/HGSuwpHz+WQt8M5VqJnM/6YYWFFeZJh46hO+RQcCYLQqPNhMQpe6m70dHBKEgPZ6X6X8lndFAFhy/imzjt+1q0lJjOfde3qJ5dMwNI1xPUDML0rwlsU58ZoBEM9FZEFsNG9u9/0BHca0lx63dLiQQ2H6WQnAIK/yC/3emm10UYT7JnzBFJLQyso/Vt23vOfPSF2zPRflKCVjAI=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(39860400002)(136003)(346002)(396003)(376002)(36840700001)(46966006)(2906002)(1076003)(54906003)(8936002)(110136005)(356005)(186003)(36756003)(86362001)(6666004)(26005)(316002)(16526019)(4326008)(81166007)(7696005)(4744005)(5660300002)(70206006)(2616005)(8676002)(82310400003)(47076005)(426003)(336012)(478600001)(36860700001)(82740400003)(70586007)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 15:00:53.7891
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: f8407e99-1bb0-4470-3212-08d972d9749c
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: CO1NAM11FT011.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: BL1PR12MB5143
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Add Collaborative Processor Performance Control Extension feature flag
for AMD processors.

Signed-off-by: Huang Rui <ray.huang@amd.com>
---
 arch/x86/include/asm/cpufeatures.h | 1 +
 1 file changed, 1 insertion(+)

diff --git a/arch/x86/include/asm/cpufeatures.h b/arch/x86/include/asm/cpufeatures.h
index d0ce5cfd3ac1..f7aea50e3371 100644
--- a/arch/x86/include/asm/cpufeatures.h
+++ b/arch/x86/include/asm/cpufeatures.h
@@ -313,6 +313,7 @@
 #define X86_FEATURE_AMD_SSBD		(13*32+24) /* "" Speculative Store Bypass Disable */
 #define X86_FEATURE_VIRT_SSBD		(13*32+25) /* Virtualized Speculative Store Bypass Disable */
 #define X86_FEATURE_AMD_SSB_NO		(13*32+26) /* "" Speculative Store Bypass is fixed in hardware. */
+#define X86_FEATURE_AMD_CPPC_EXT	(13*32+27) /* Collaborative Processor Performance Control Extension */
 
 /* Thermal and Power Management Leaf, CPUID level 0x00000006 (EAX), word 14 */
 #define X86_FEATURE_DTHERM		(14*32+ 0) /* Digital Thermal Sensor */
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-18.8 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,USER_AGENT_GIT
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 880E2C433F5
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:33 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 6FB5C61051
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:33 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1351989AbhIHPCj (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 11:02:39 -0400
Received: from mail-mw2nam08on2077.outbound.protection.outlook.com ([40.107.101.77]:22369
        "EHLO NAM04-MW2-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1351992AbhIHPCR (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 11:02:17 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=jPfFtMwPL2S8BwNSYlWdVApMxLwAD+VM4fcOhQY6D/xjTEB/ubbw/WROKEJhcj3CxWgfBueIHMng23wLDmeTpBXU1+gX+V9yzfNYggUYkB+7GLQzTxyVr0GbKvYKHcj8GQEgBAoxgJ1vx+2nffX3FgqxJubo/bqE47CtrQux7LCTepjsQQTXQL8PIwNj7UDqJEq/cZEzGIgMK61BC1LNux0zjJd4ETxkO/SXWhYLxrs35Py1P2JuWhumPThTZfvmIavot+1nbN+oCIIgGhMtwJydXZZqX9h9jRBMUtdciP8nQS31cILkkGMUWyzUM+GNtnQkfHwC1/dj4c2tx1cwsQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=uUKPiXN0BjWmKPdmk/FZ66q/4HDuKnMNTn7hDLqR47Y=;
 b=jsv4o1ziVruwSkXKTOrY/cibQf9WBAu8XGvzlH0wVeS70nowIE90KegpuF7xr5nUDoHJgNLR7h6hp1XQPz3mk0rAaoDLdGoK0/k4zGpSwqvOPlRxE0otZ9h9tDmLEe95+ZAqNOR0ugs5zBPby1Qy9IHa6hSDYe0Aj2mrwYf4ICTKYsUNnysj78JZoa2IhLOTZ87B0NggwjqYoP22CKTxvlPdIexfsIhlF7Y2YBjFVxU0Z1KSNUJwfZzMkOo5xrkP7RHdVjEQbiQzbIpgQJqP02cYdhlPgvMR5nvT8EPYU86eekEoYZ/CjJpl8VvwlcyvVghLegz3b/cFhZZA/BSbOg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=uUKPiXN0BjWmKPdmk/FZ66q/4HDuKnMNTn7hDLqR47Y=;
 b=W78/f6aNmn2Qh4AjT66R5ctiufMZ3GdTOnnrHE0j4d38v5DtHofR2rDuI2h+gjkAWKQseOrmtMT4Sdu9rYjmFEU2KrwL5dDDz325dSIB/QAzENgZnqXqsNZcH921SlPuUJ8EhjwyagbXFXSw82ksScloByuER6IrPECM4ngTEcg=
Received: from MWHPR11CA0038.namprd11.prod.outlook.com (2603:10b6:300:115::24)
 by DM6PR12MB4203.namprd12.prod.outlook.com (2603:10b6:5:21f::21) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4478.19; Wed, 8 Sep
 2021 15:01:08 +0000
Received: from CO1NAM11FT036.eop-nam11.prod.protection.outlook.com
 (2603:10b6:300:115:cafe::e9) by MWHPR11CA0038.outlook.office365.com
 (2603:10b6:300:115::24) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Wed, 8 Sep 2021 15:01:08 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CO1NAM11FT036.mail.protection.outlook.com (10.13.174.124) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 15:01:08 +0000
Received: from hr-amd.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Wed, 8 Sep 2021
 10:00:57 -0500
From:   Huang Rui <ray.huang@amd.com>
To:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        <linux-pm@vger.kernel.org>
CC:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        <linux-kernel@vger.kernel.org>, <x86@kernel.org>,
        Huang Rui <ray.huang@amd.com>
Subject: [PATCH 03/19] ACPI: CPPC: add cppc enable register function
Date:   Wed, 8 Sep 2021 22:59:45 +0800
Message-ID: <20210908150001.3702552-4-ray.huang@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210908150001.3702552-1-ray.huang@amd.com>
References: <20210908150001.3702552-1-ray.huang@amd.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Type: text/plain
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: e77b2fe8-9366-46be-a82f-08d972d97d15
X-MS-TrafficTypeDiagnostic: DM6PR12MB4203:
X-Microsoft-Antispam-PRVS: <DM6PR12MB4203AFD86670B8C8BA682175ECD49@DM6PR12MB4203.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:4125;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: zqsj8A/X89bopYaXeEgRsj+hfNEzJ8pkcD4vhf9MV/8BcQiDJSKCFrOyD3DKsVcoMEpx/NWhP1COaIQD/+gBx/j88utC33jpPbPQ4k2pOeyOOBCEZlenXwSunF5VfDJPDCqGmNoxFN/hfD85LlSip2mGQkPEk5GfRRZF+cXa2ihJgHJPlZVekwOVe9ATjBi6VAx10SKdFaax97OniCZlJ49wM0hSCYutr/0RRd6MxbPHKOvLSFsGgmGnfJ2QJZgB3znS+vkAr8vIlco/m8ezUO0XmUWFIYnnPz2vLjNqKWjsRDFBcLWSCj0DAf9REsMWcpdY0AcgPuI7oAOSHS19x4hu+4ChklYdWwJac6+7xc4YIKyBkJVb/RLbN4SrxAFcQx/dW/itjVg+bB0MwTGJ08VD/sSqTuprUh7n8C+gHl4TN9/sp8NP+q9vUNFSRPhnNJjy35t33vAtD+KeQxTpvWd5GVS52mSD9E4CRHXwwCsVL48MKfmG9RTPbfNY6NvKmMgeueGAWrwzk7MWaevL2YyNNfvzMD+qz4AhaFPxPnnHtVShSdYMFF9pRYdHOfg8+zd7sYW2gWP2wirBrrNjz8SmwdN+DMAGiogRFeV/FQvP0BU3YV0Vvj/hKB73SuQCjHbVJ0Tr/wOLktFIjgTH+O33WUeaYg6cRY78JAP7Fz5T9//wG6fQpR845vojJkJRE46O/NzZOktltROqtOUi29i/toZ4Rg4pcvVXwGuQLBY=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(36840700001)(46966006)(2906002)(36756003)(356005)(7696005)(1076003)(54906003)(70586007)(110136005)(81166007)(6666004)(86362001)(36860700001)(8676002)(26005)(4326008)(47076005)(5660300002)(2616005)(316002)(16526019)(186003)(336012)(426003)(8936002)(83380400001)(70206006)(82310400003)(508600001)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 15:01:08.0037
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: e77b2fe8-9366-46be-a82f-08d972d97d15
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: CO1NAM11FT036.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB4203
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

From: Jinzhou Su <Jinzhou.Su@amd.com>

Export the cppc enable register function for future use.

Signed-off-by: Jinzhou Su <Jinzhou.Su@amd.com>
Signed-off-by: Huang Rui <ray.huang@amd.com>
---
 drivers/acpi/cppc_acpi.c | 42 ++++++++++++++++++++++++++++++++++++++++
 include/acpi/cppc_acpi.h |  5 +++++
 2 files changed, 47 insertions(+)

diff --git a/drivers/acpi/cppc_acpi.c b/drivers/acpi/cppc_acpi.c
index a4d4eebba1da..de4b30545215 100644
--- a/drivers/acpi/cppc_acpi.c
+++ b/drivers/acpi/cppc_acpi.c
@@ -1220,6 +1220,48 @@ int cppc_get_perf_ctrs(int cpunum, struct cppc_perf_fb_ctrs *perf_fb_ctrs)
 }
 EXPORT_SYMBOL_GPL(cppc_get_perf_ctrs);
 
+/**
+ * cppc_set_enable - Set to enable CPPC register.
+ * @cpu: CPU for which to enable CPPC register.
+ * @enable: enable field to write into share memory.
+ *
+ * Return: 0 for success, -ERRNO otherwise.
+ */
+int cppc_set_enable(int cpu, u32 enable)
+{
+	int pcc_ss_id = per_cpu(cpu_pcc_subspace_idx, cpu);
+	struct cpc_register_resource *enable_reg;
+	struct cpc_desc *cpc_desc = per_cpu(cpc_desc_ptr, cpu);
+	struct cppc_pcc_data *pcc_ss_data = NULL;
+	int ret = -1;
+
+	if (!cpc_desc) {
+		pr_debug("No CPC descriptor for CPU:%d\n", cpu);
+		return -ENODEV;
+	}
+
+	enable_reg = &cpc_desc->cpc_regs[ENABLE];
+
+	if (CPC_IN_PCC(enable_reg)) {
+
+		if (pcc_ss_id < 0)
+			return -EIO;
+
+		ret = cpc_write(cpu, enable_reg, enable);
+		if (ret)
+			return ret;
+
+		pcc_ss_data = pcc_data[pcc_ss_id];
+
+		down_write(&pcc_ss_data->pcc_lock);
+		send_pcc_cmd(pcc_ss_id, CMD_WRITE);
+		up_write(&pcc_ss_data->pcc_lock);
+	}
+
+	return ret;
+}
+EXPORT_SYMBOL_GPL(cppc_set_enable);
+
 /**
  * cppc_set_perf - Set a CPU's performance controls.
  * @cpu: CPU for which to set performance controls.
diff --git a/include/acpi/cppc_acpi.h b/include/acpi/cppc_acpi.h
index 9f4985b4d64d..3fdae40a75fc 100644
--- a/include/acpi/cppc_acpi.h
+++ b/include/acpi/cppc_acpi.h
@@ -137,6 +137,7 @@ struct cppc_cpudata {
 extern int cppc_get_desired_perf(int cpunum, u64 *desired_perf);
 extern int cppc_get_perf_ctrs(int cpu, struct cppc_perf_fb_ctrs *perf_fb_ctrs);
 extern int cppc_set_perf(int cpu, struct cppc_perf_ctrls *perf_ctrls);
+extern int cppc_set_enable(int cpu, u32 enable);
 extern int cppc_get_perf_caps(int cpu, struct cppc_perf_caps *caps);
 extern bool acpi_cpc_valid(void);
 extern int acpi_get_psd_map(unsigned int cpu, struct cppc_cpudata *cpu_data);
@@ -157,6 +158,10 @@ static inline int cppc_set_perf(int cpu, struct cppc_perf_ctrls *perf_ctrls)
 {
 	return -ENOTSUPP;
 }
+static inline int cppc_set_enable(int cpu, u32 enable)
+{
+	return -ENOTSUPP;
+}
 static inline int cppc_get_perf_caps(int cpu, struct cppc_perf_caps *caps)
 {
 	return -ENOTSUPP;
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-18.8 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,USER_AGENT_GIT
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 906DBC433F5
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:35 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 76C2461181
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:35 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1349196AbhIHPCm (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 11:02:42 -0400
Received: from mail-bn7nam10on2049.outbound.protection.outlook.com ([40.107.92.49]:63968
        "EHLO NAM10-BN7-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1351975AbhIHPCS (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 11:02:18 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=FQL5Iadum7jyMKm8Jru4H5FYwWJ5S7CDIPu/0GIhj92DtNZzqyMt1ubatTpTSm3mM3er8Tkmnm2Q0T4vrTy+PbCIKXG81Y6NFavu663jWaelJbrnzwmvSZUrPOXINMiDvuqDCVrSaZIo8H8MaUqak+M97chpESzsYRVZ2RbBOqUpXqxEt2HeWPlBB1IE4yVg4qF5RbhYqef7+ho8jufor/6MACOFcb/4m+c4rMk8HMvKlRSHJPgeGFWSyulNVISDq4w0k/JS/DYmQ8cAu78Pn01RhzGsyVWu6V9pVkH6ArJ1JG1BWRUzzKMY7QqxTEeN2grSGuj0pMwetQiWQ+7BKw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=gko91jc5e7rpbCzfGpPpjqqcyCTjDnAMnKWSe+2E4Dw=;
 b=F6KGAgBlEjoPzG6IFnLJo28Z8Qx6XzvgZ/pmut8AetcdxztGs+coht4MZm6Nhw+o5+qixQjh++QUeARVWudGvbHlBgSDyrpq+sLAdmW1cdKoFBeeeh/zJZoUF9/7BDH4Bs17kWWvqCz6F4gtr0Q52AcAcrNpWOXVkDFgQ6qTMHCPDROD/jl2NS33P+rLXTciw/cgC7j8TQ5VAbB3KkJZFYlrb7jNdrG1S6F6/0z6FQSGsJ08xz/Zr1Dv6E9BSJUxgNidINUBL+k43B8dBvMp0cXBzLjG455qQkDchwELU/wIwYvHAHlawfcUxHChYgdbuzYBwABz69bTHvLzvZw5EA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=gko91jc5e7rpbCzfGpPpjqqcyCTjDnAMnKWSe+2E4Dw=;
 b=wfyLMWlAFQUAwnY42jXX1xtlHikDBiavSAkGmy3+ueK4/CW3Nr9uSPWNIVodC5Mjm6TJ69hu+cVuch0/TSKXJyZKZH31/o0hbvG2sShtR/k4KDZoAWUl2sNHapjcxycf71n6zmxskQuWiUIUkeGTqDWdjg3zka6S8FHel9aM2QI=
Received: from MWHPR11CA0037.namprd11.prod.outlook.com (2603:10b6:300:115::23)
 by MWHPR12MB1504.namprd12.prod.outlook.com (2603:10b6:301:c::7) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14; Wed, 8 Sep
 2021 15:01:07 +0000
Received: from CO1NAM11FT036.eop-nam11.prod.protection.outlook.com
 (2603:10b6:300:115:cafe::cd) by MWHPR11CA0037.outlook.office365.com
 (2603:10b6:300:115::23) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Wed, 8 Sep 2021 15:01:07 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CO1NAM11FT036.mail.protection.outlook.com (10.13.174.124) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 15:01:07 +0000
Received: from hr-amd.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Wed, 8 Sep 2021
 10:00:53 -0500
From:   Huang Rui <ray.huang@amd.com>
To:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        <linux-pm@vger.kernel.org>
CC:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        <linux-kernel@vger.kernel.org>, <x86@kernel.org>,
        Huang Rui <ray.huang@amd.com>
Subject: [PATCH 02/19] x86/msr: add AMD CPPC MSR definitions
Date:   Wed, 8 Sep 2021 22:59:44 +0800
Message-ID: <20210908150001.3702552-3-ray.huang@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210908150001.3702552-1-ray.huang@amd.com>
References: <20210908150001.3702552-1-ray.huang@amd.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Type: text/plain
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 590a14db-34a9-4488-a22e-08d972d97caf
X-MS-TrafficTypeDiagnostic: MWHPR12MB1504:
X-Microsoft-Antispam-PRVS: <MWHPR12MB1504C5D5B9F3C6DA0DF04A4DECD49@MWHPR12MB1504.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:1107;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: yA2JjAipvYTpw6Zzy3NIMWP+UxbMRXLKy0MF84nG9SN2NE0yM3xGZBERPp2TiIZCRqcGbO8kyKCK/1i5ZQIxJrC5/eiCRuwAGjyOJSUzBVNbK5y4nZbjG5SCBdhddO5XHQhZR+FgBxT/m9sZ9NgTiljpqKW/L0f1M0EoNVhsA/r52I2OOVtXj9ciHnTXoFCmFPAVReCyXG78b594e/7HXoIRHUv1tzhJO8VuIc+EJNi2FEhX6GFfVaI4MhD+L1YiUebzrkPd4WUCevUm2/UY3pe36wfJhVXXlJcFN50Zunyj1QM1IUCLX0ciExYeclvweobpo/e8SumxzHGY5K0quY0fzUbqUWw11clS7Wv3tinHrRPVucihgtvQWvudKloT+nekpkEeXyBdj0/UrjtU1ABVIeJQXQ6jFL/gQexv61yekzmieHXQnaug17/W0/X0xUxVCB5NYsimaK8omZmUG5Ane7ImOh+R7Tq5ttHNQnu/exupusci2iwcGMtdkCALnBEQmpxCF9k5Z0X6nqfzcpCVtlHVUItsG+MLmpY02pjh058eL0yrJjeZ9eDrA6Tl57XO1Bl+X2/wE/85a0rO3lCUEGDBA4QkqJbXMPFVYB/aV8JEYKJ0YsF2ISN6PvYg13Q+CtHqSkplm9ukxUKigub2sLVsNLC6oTpmtE63uq4VqGjdCWIsDEZv6RsolYKzN4Feg/rTgbjAI/y8phuw54nfxaPEW/kxGZx2//zUYTM=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(346002)(396003)(136003)(39860400002)(376002)(46966006)(36840700001)(47076005)(4326008)(16526019)(5660300002)(186003)(8676002)(7696005)(426003)(26005)(336012)(82740400003)(316002)(110136005)(70586007)(70206006)(54906003)(81166007)(2906002)(36756003)(36860700001)(1076003)(356005)(478600001)(82310400003)(6666004)(86362001)(8936002)(2616005)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 15:01:07.3331
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 590a14db-34a9-4488-a22e-08d972d97caf
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: CO1NAM11FT036.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MWHPR12MB1504
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

AMD CPPC (Collaborative Processor Performance Control) function uses MSR
registers to manage the performance hints. So add the MSR register macro
here.

Signed-off-by: Huang Rui <ray.huang@amd.com>
---
 arch/x86/include/asm/msr-index.h | 17 +++++++++++++++++
 1 file changed, 17 insertions(+)

diff --git a/arch/x86/include/asm/msr-index.h b/arch/x86/include/asm/msr-index.h
index a7c413432b33..ce42e15cf303 100644
--- a/arch/x86/include/asm/msr-index.h
+++ b/arch/x86/include/asm/msr-index.h
@@ -486,6 +486,23 @@
 
 #define MSR_AMD64_VIRT_SPEC_CTRL	0xc001011f
 
+/* AMD Collaborative Processor Performance Control MSRs */
+#define MSR_AMD_CPPC_CAP1		0xc00102b0
+#define MSR_AMD_CPPC_ENABLE		0xc00102b1
+#define MSR_AMD_CPPC_CAP2		0xc00102b2
+#define MSR_AMD_CPPC_REQ		0xc00102b3
+#define MSR_AMD_CPPC_STATUS		0xc00102b4
+
+#define CAP1_LOWEST_PERF(x)	(((x) >> 0) & 0xff)
+#define CAP1_LOWNONLIN_PERF(x)	(((x) >> 8) & 0xff)
+#define CAP1_NOMINAL_PERF(x)	(((x) >> 16) & 0xff)
+#define CAP1_HIGHEST_PERF(x)	(((x) >> 24) & 0xff)
+
+#define REQ_MAX_PERF(x)		(((x) & 0xff) << 0)
+#define REQ_MIN_PERF(x)		(((x) & 0xff) << 8)
+#define REQ_DES_PERF(x)		(((x) & 0xff) << 16)
+#define REQ_ENERGY_PERF_PREF(x)	(((x) & 0xff) << 24)
+
 /* Fam 17h MSRs */
 #define MSR_F17H_IRPERF			0xc00000e9
 
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-18.8 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,USER_AGENT_GIT
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id CEDFEC433F5
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:37 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id B4927611AF
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:37 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1351973AbhIHPCn (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 11:02:43 -0400
Received: from mail-mw2nam10on2065.outbound.protection.outlook.com ([40.107.94.65]:47937
        "EHLO NAM10-MW2-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1351821AbhIHPCU (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 11:02:20 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=Pf/P+DEHB9VU/7HhJLrTUXzHv8vm8JwIcytCSdadstfm7BRZTAAW4ii3bkulosy6yz+JGDpRqQG3MiYsvv+zB/KgZABwT2Wkc4K1AZ0sWLiPKoeS9BDu8XN8fnRW3hm5z8MaY7F7HW8uxgtvi0DBrJxY3Wl2/UJlH+yJroAVRYDUDtdswig10EU4iRkoGHZwFpQbQvFsZy1QeQAK+B3fJapviuAWelSzIlkePNZpmk+S0OSzNGWimBkLCvUD+fb79/ZxawNUPZbiKcySIrESMNyQZaEJwgwyc0xYHavn48mRSU86j1xis82lqjnfhdMLDPrZn5e9oJR1nO86RdzRWA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=x1CTSNBpCCVRWVE+jlegtlNWM8sebgNmq9tkcGd7Hv0=;
 b=E7ndbM2I0z5M3D0eNX4/rBeN+mDJ5dmzaLoOeBs5+9LiSjwsCqNhS2eZ+9fxoKAF4oFJqwwzrJlUetEigBH4WgxSQery/fia3uAzKzMoufiicoj+xDEclylHMP8X+cX6nT9Xm6jo1mAu3yVQ9njfzNa+eqIOdHC7elSTDQpBV+qrHT+IRCoGn37im2Y8MbNaX2CGJOAYTxOCfHo5EbSwPedAd7VqAAP41o3pmZhhWQJJg05qbX9eE1BWCAOCf+isFsjnLxLkvZ0DZ2GrMnmG1br8Q/ijxPstQE5XABJsmIw8UDqhzvnZTxmYVWXtFtR5FaIZNwxRPgrNz4TqbNGGNw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=x1CTSNBpCCVRWVE+jlegtlNWM8sebgNmq9tkcGd7Hv0=;
 b=MtSWF+6N6n40xsPOS75o8SHp6V7ztqeZwmexwgV/h5cVhpir/h+m3i6+swF97ozFxSHMuMniJ9qMNLWlQOFx/YsZWRaRKTiHjkMQrK9bpiYCjuCDa9Ukbp9PgpUFlLLquvcPx1wy9uba1REzoDAD+HjTuX+D/mnjFcoeOKb6WP4=
Received: from MWHPR11CA0035.namprd11.prod.outlook.com (2603:10b6:300:115::21)
 by DM6PR12MB3577.namprd12.prod.outlook.com (2603:10b6:5:3a::26) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4478.22; Wed, 8 Sep
 2021 15:01:08 +0000
Received: from CO1NAM11FT036.eop-nam11.prod.protection.outlook.com
 (2603:10b6:300:115:cafe::43) by MWHPR11CA0035.outlook.office365.com
 (2603:10b6:300:115::21) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Wed, 8 Sep 2021 15:01:08 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CO1NAM11FT036.mail.protection.outlook.com (10.13.174.124) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 15:01:08 +0000
Received: from hr-amd.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Wed, 8 Sep 2021
 10:01:01 -0500
From:   Huang Rui <ray.huang@amd.com>
To:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        <linux-pm@vger.kernel.org>
CC:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        <linux-kernel@vger.kernel.org>, <x86@kernel.org>,
        Huang Rui <ray.huang@amd.com>
Subject: [PATCH 04/19] cpufreq: amd: introduce a new amd pstate driver to support future processors
Date:   Wed, 8 Sep 2021 22:59:46 +0800
Message-ID: <20210908150001.3702552-5-ray.huang@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210908150001.3702552-1-ray.huang@amd.com>
References: <20210908150001.3702552-1-ray.huang@amd.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Type: text/plain
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 9d178e28-10f6-4c7c-fce0-08d972d97d72
X-MS-TrafficTypeDiagnostic: DM6PR12MB3577:
X-Microsoft-Antispam-PRVS: <DM6PR12MB3577B29CC775461C25269601ECD49@DM6PR12MB3577.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:6108;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: CXdRR3c7pnoptZp0IRPEphLFapq6xue5fLY30rttIkk8JrtFnIKG+XNh8Mq8vxmCXfbD2J2SbEsTJkkt2gppUqKWwq7+7At4gX80P6M3GTiyUkKqBXk8SLGCo4TSlwh2grsusTOK6u/vm1Vl5kBtZ73SdSLk8IprTntdz74r5+rww5s9/i/DkQQCvc6gM3uVWXMRtXxZho2PII3UOn+J++hyuqyyMbmEhXmOcvFughD3AFjaaiwxB4UgTx5SmztkK2H2KcZRvol0+jukXC37etjyibUuHRNr2Rodjlgmi3ATLfLdJ8r+dGOX5yv7xmvRAssS9LUmDJLN7G86gscsKoZXSFQEL4/FrLePyiP4v1tVTxNJmXrs+Ia9D/ibFwdkFh1teLU2+CTy5ldbgTm9M4T383YWGYzOHoPQJIl4AwOcEECgzqqEZJL/iQPUZtVWuakqlmLH7NxGOeLTBbJKN8Fl3v5RIyoiDRbx5fK83bXvX1WLC6l7T5b5XIrTWT2b7XziErjK9mG+4rVQ5rLjiUCoTkspRxYkRvuCv5QdxPoGUeoN9U7jZLQfWikAF9pKCJoZmNfvHnSceTd9ikv1LcPrha39d4eb7NW2A5I4m/cUjfDOXtsYZpdT6Vig3EhPDIXb3oP6hy/gJvLL73XGMPqXpM9aheEbCDMyRvV8HmcW43D8Nvikhh0mUuubROwhUSFINFmCcHQWFJURPFHs/ELG8KlgyBoQcSZsHOQ6YyhoS3X2/cF709eDRuGUhT17ZuQeqH7Cwl4GvRtiObb04L/AU4xk67652PvHub5uVb8/QevFVFWGq3Jm1K01dFyQeomahNYG3gNAmTwaQFrGzg==
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(376002)(396003)(346002)(136003)(39860400002)(46966006)(36840700001)(5660300002)(2906002)(7696005)(82310400003)(36860700001)(316002)(110136005)(54906003)(1076003)(86362001)(4326008)(30864003)(186003)(426003)(82740400003)(16526019)(2616005)(83380400001)(336012)(70586007)(8936002)(8676002)(70206006)(6666004)(26005)(356005)(478600001)(81166007)(47076005)(966005)(36756003)(2004002)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 15:01:08.6154
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 9d178e28-10f6-4c7c-fce0-08d972d97d72
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: CO1NAM11FT036.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB3577
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

amd-pstate is the AMD CPU performance scaling driver that introduces a
new CPU frequency control mechanism on AMD Zen based CPU series in Linux
kernel. The new mechanism is based on Collaborative processor
performance control (CPPC) which is finer grain frequency management
than legacy ACPI hardware P-States. Current AMD CPU platforms are using
the ACPI P-states driver to manage CPU frequency and clocks with
switching only in 3 P-states. AMD P-States is to replace the ACPI
P-states controls, allows a flexible, low-latency interface for the
Linux kernel to directly communicate the performance hints to hardware.

"amd-pstate" leverages the Linux kernel governors such as *schedutil*,
*ondemand*, etc. to manage the performance hints which are provided by CPPC
hardware functionality. The first version for amd-pstate is to support one
of the Zen3 processors, and we will support more in future after we verify
the hardware and SBIOS functionalities.

There are two types of hardware implementations for amd-pstate: one is full
MSR support and another is shared memory support. It can use
X86_FEATURE_AMD_CPPC_EXT feature flag to distinguish the different types.

Using the new AMD P-States method + kernel governors (*schedutil*,
*ondemand*, ...) to manage the frequency update is the most appropriate
bridge between AMD Zen based hardware processor and Linux kernel, the
processor is able to ajust to the most efficiency frequency according to
the kernel scheduler loading.

Performance Per Watt (PPW) Caculation:

The PPW caculation is referred by below paper:
https://software.intel.com/content/dam/develop/external/us/en/documents/performance-per-what-paper.pdf

Below formula is referred from below spec to measure the PPW:

(F / t) / P = F * t / (t * E) = F / E,

"F" is the number of frames per second.
"P" is power measurd in watts.
"E" is energy measured in joules.

We use the RAPL interface with "perf" tool to get the energy data of the
package power.

The data comparsions between amd-pstate and acpi-freq module are tested on
AMD Cezanne processor:

1) TBench CPU benchmark:

+---------------------------------------------------------------------+
|                                                                     |
|               TBench (Performance Per Watt)                         |
|                                                    Higher is better |
+-------------------+------------------------+------------------------+
|                   |  Performance Per Watt  |  Performance Per Watt  |
|   Kernel Module   |       (Schedutil)      |       (Ondemand)       |
|                   |  Unit: MB / (s * J)    |  Unit: MB / (s * J)    |
+-------------------+------------------------+------------------------+
|                   |                        |                        |
|    acpi-cpufreq   |         3.022          |        2.969           |
|                   |                        |                        |
+-------------------+------------------------+------------------------+
|                   |                        |                        |
|     amd-pstate    |         3.131          |        3.284           |
|                   |                        |                        |
+-------------------+------------------------+------------------------+

2) Gitsource CPU benchmark:

+---------------------------------------------------------------------+
|                                                                     |
|               Gitsource (Performance Per Watt)                      |
|                                                    Higher is better |
+-------------------+------------------------+------------------------+
|                   |  Performance Per Watt  |  Performance Per Watt  |
|   Kernel Module   |       (Schedutil)      |       (Ondemand)       |
|                   |  Unit: 1 / (s * J)     |  Unit: 1 / (s * J)     |
+-------------------+------------------------+------------------------+
|                   |                        |                        |
|    acpi-cpufreq   |     3.42172E-07        |     2.74508E-07        |
|                   |                        |                        |
+-------------------+------------------------+------------------------+
|                   |                        |                        |
|     amd-pstate    |     4.09141E-07        |     3.47610E-07        |
|                   |                        |                        |
+-------------------+------------------------+------------------------+

3) Speedometer 2.0 CPU benchmark:

+---------------------------------------------------------------------+
|                                                                     |
|               Speedometer 2.0 (Performance Per Watt)                |
|                                                    Higher is better |
+-------------------+------------------------+------------------------+
|                   |  Performance Per Watt  |  Performance Per Watt  |
|   Kernel Module   |       (Schedutil)      |       (Ondemand)       |
|                   |  Unit: 1 / (s * J)     |  Unit: 1 / (s * J)     |
+-------------------+------------------------+------------------------+
|                   |                        |                        |
|    acpi-cpufreq   |      0.116111767       |      0.110321664       |
|                   |                        |                        |
+-------------------+------------------------+------------------------+
|                   |                        |                        |
|     amd-pstate    |      0.115825281       |      0.122024299       |
|                   |                        |                        |
+-------------------+------------------------+------------------------+

According to above average data, we can see this solution has shown better
performance per watt scaling on mobile CPU benchmarks in most of cases.

Signed-off-by: Huang Rui <ray.huang@amd.com>
---
 drivers/cpufreq/Kconfig.x86  |  13 +
 drivers/cpufreq/Makefile     |   1 +
 drivers/cpufreq/amd-pstate.c | 478 +++++++++++++++++++++++++++++++++++
 3 files changed, 492 insertions(+)
 create mode 100644 drivers/cpufreq/amd-pstate.c

diff --git a/drivers/cpufreq/Kconfig.x86 b/drivers/cpufreq/Kconfig.x86
index 92701a18bdd9..9cd7e338bdcd 100644
--- a/drivers/cpufreq/Kconfig.x86
+++ b/drivers/cpufreq/Kconfig.x86
@@ -34,6 +34,19 @@ config X86_PCC_CPUFREQ
 
 	  If in doubt, say N.
 
+config X86_AMD_PSTATE
+	tristate "AMD Processor P-State driver"
+	depends on X86
+	select ACPI_PROCESSOR if ACPI
+	select ACPI_CPPC_LIB if X86_64 && ACPI && SCHED_MC_PRIO
+	select CPU_FREQ_GOV_SCHEDUTIL if SMP
+	help
+	  This driver adds a CPUFreq driver which utilizes a fine grain
+	  processor performance freqency control range instead of legacy
+	  performance levels. This driver also supports newer AMD CPUs.
+
+	  If in doubt, say N.
+
 config X86_ACPI_CPUFREQ
 	tristate "ACPI Processor P-States driver"
 	depends on ACPI_PROCESSOR
diff --git a/drivers/cpufreq/Makefile b/drivers/cpufreq/Makefile
index 27d3bd7ea9d4..3d4bd7141cf8 100644
--- a/drivers/cpufreq/Makefile
+++ b/drivers/cpufreq/Makefile
@@ -24,6 +24,7 @@ obj-$(CONFIG_CPUFREQ_DT_PLATDEV)	+= cpufreq-dt-platdev.o
 # powernow-k8 can load then. ACPI is preferred to all other hardware-specific drivers.
 # speedstep-* is preferred over p4-clockmod.
 
+obj-$(CONFIG_X86_AMD_PSTATE)		+= amd-pstate.o
 obj-$(CONFIG_X86_ACPI_CPUFREQ)		+= acpi-cpufreq.o
 obj-$(CONFIG_X86_POWERNOW_K8)		+= powernow-k8.o
 obj-$(CONFIG_X86_PCC_CPUFREQ)		+= pcc-cpufreq.o
diff --git a/drivers/cpufreq/amd-pstate.c b/drivers/cpufreq/amd-pstate.c
new file mode 100644
index 000000000000..4c9c9bf1d72b
--- /dev/null
+++ b/drivers/cpufreq/amd-pstate.c
@@ -0,0 +1,478 @@
+// SPDX-License-Identifier: GPL-2.0-or-later
+/*
+ * amd-pstate.c - AMD Processor P-state Frequency Driver
+ *
+ * Copyright (C) 2021 Advanced Micro Devices, Inc. All Rights Reserved.
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along with
+ * this program; if not, write to the Free Software
+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ * Author: Huang Rui <ray.huang@amd.com>
+ */
+
+#define pr_fmt(fmt) KBUILD_MODNAME ": " fmt
+
+#include <linux/kernel.h>
+#include <linux/module.h>
+#include <linux/init.h>
+#include <linux/smp.h>
+#include <linux/sched.h>
+#include <linux/cpufreq.h>
+#include <linux/compiler.h>
+#include <linux/dmi.h>
+#include <linux/slab.h>
+#include <linux/acpi.h>
+#include <linux/io.h>
+#include <linux/delay.h>
+#include <linux/uaccess.h>
+
+#include <acpi/processor.h>
+#include <acpi/cppc_acpi.h>
+
+#include <asm/msr.h>
+#include <asm/processor.h>
+#include <asm/cpufeature.h>
+#include <asm/cpu_device_id.h>
+
+#define AMD_PSTATE_TRANSITION_LATENCY	0x20000
+#define AMD_PSTATE_TRANSITION_DELAY	500
+
+static struct cpufreq_driver amd_pstate_driver;
+
+struct amd_cpudata {
+	int	cpu;
+
+	struct freq_qos_request req[2];
+	struct cpufreq_policy *policy;
+
+	u64	cppc_req_cached;
+
+	u32	highest_perf;
+	u32	nominal_perf;
+	u32	lowest_nonlinear_perf;
+	u32	lowest_perf;
+
+	u32	max_freq;
+	u32	min_freq;
+	u32	nominal_freq;
+	u32	lowest_nonlinear_freq;
+};
+
+struct amd_pstate_perf_funcs {
+	int (*enable)(bool enable);
+	int (*init_perf)(struct amd_cpudata *cpudata);
+	void (*update_perf)(struct amd_cpudata *cpudata,
+			    u32 min_perf, u32 des_perf,
+			    u32 max_perf, bool fast_switch);
+};
+
+static inline int pstate_enable(bool enable)
+{
+	return wrmsrl_safe(MSR_AMD_CPPC_ENABLE, enable ? 1 : 0);
+}
+
+static int
+amd_pstate_enable(struct amd_pstate_perf_funcs *funcs, bool enable)
+{
+	if (!funcs)
+		return -EINVAL;
+
+	return funcs->enable(enable);
+}
+
+static int pstate_init_perf(struct amd_cpudata *cpudata)
+{
+	u64 cap1;
+
+	int ret = rdmsrl_safe_on_cpu(cpudata->cpu, MSR_AMD_CPPC_CAP1,
+				     &cap1);
+	if (ret)
+		return ret;
+
+	/* Some AMD processors has specific power features that the cppc entry
+	 * doesn't indicate the highest performance. It will introduce the
+	 * feature in following days.
+	 */
+	WRITE_ONCE(cpudata->highest_perf, amd_get_highest_perf());
+
+	WRITE_ONCE(cpudata->nominal_perf, CAP1_NOMINAL_PERF(cap1));
+	WRITE_ONCE(cpudata->lowest_nonlinear_perf, CAP1_LOWNONLIN_PERF(cap1));
+	WRITE_ONCE(cpudata->lowest_perf, CAP1_LOWEST_PERF(cap1));
+
+	return 0;
+}
+
+static int amd_pstate_init_perf(struct amd_cpudata *cpudata)
+{
+	struct amd_pstate_perf_funcs *funcs = cpufreq_get_driver_data();
+
+	if (!funcs)
+		return -EINVAL;
+
+	return funcs->init_perf(cpudata);
+}
+
+static void pstate_update_perf(struct amd_cpudata *cpudata,
+			       u32 min_perf, u32 des_perf, u32 max_perf,
+			       bool fast_switch)
+{
+	if (fast_switch)
+		wrmsrl(MSR_AMD_CPPC_REQ, READ_ONCE(cpudata->cppc_req_cached));
+	else
+		wrmsrl_on_cpu(cpudata->cpu, MSR_AMD_CPPC_REQ,
+			      READ_ONCE(cpudata->cppc_req_cached));
+}
+
+static int
+amd_pstate_update_perf(struct amd_cpudata *cpudata, u32 min_perf,
+		       u32 des_perf, u32 max_perf, bool fast_switch)
+{
+	struct amd_pstate_perf_funcs *funcs = cpufreq_get_driver_data();
+
+	if (!funcs)
+		return -EINVAL;
+
+	funcs->update_perf(cpudata, min_perf, des_perf,
+			   max_perf, fast_switch);
+
+	return 0;
+}
+
+static int
+amd_pstate_update(struct amd_cpudata *cpudata, u32 min_perf,
+		  u32 des_perf, u32 max_perf, bool fast_switch)
+{
+	u64 prev = READ_ONCE(cpudata->cppc_req_cached);
+	u64 value = prev;
+
+	value &= ~REQ_MIN_PERF(~0L);
+	value |= REQ_MIN_PERF(min_perf);
+
+	value &= ~REQ_DES_PERF(~0L);
+	value |= REQ_DES_PERF(des_perf);
+
+	value &= ~REQ_MAX_PERF(~0L);
+	value |= REQ_MAX_PERF(max_perf);
+
+	if (value == prev)
+		return 0;
+
+	WRITE_ONCE(cpudata->cppc_req_cached, value);
+
+	return amd_pstate_update_perf(cpudata, min_perf, des_perf,
+				      max_perf, fast_switch);
+}
+
+static int amd_pstate_verify(struct cpufreq_policy_data *policy)
+{
+	cpufreq_verify_within_cpu_limits(policy);
+
+	return 0;
+}
+
+static int amd_pstate_target(struct cpufreq_policy *policy,
+			     unsigned int target_freq,
+			     unsigned int relation)
+{
+	int ret;
+	struct cpufreq_freqs freqs;
+	struct amd_cpudata *cpudata = policy->driver_data;
+	unsigned long amd_max_perf, amd_min_perf, amd_des_perf,
+		      amd_cap_perf;
+
+	if (!cpudata->max_freq)
+		return -ENODEV;
+
+	amd_cap_perf = READ_ONCE(cpudata->highest_perf);
+	amd_min_perf = READ_ONCE(cpudata->lowest_nonlinear_perf);
+	amd_max_perf = amd_cap_perf;
+
+	freqs.old = policy->cur;
+	freqs.new = target_freq;
+
+	amd_des_perf = DIV_ROUND_CLOSEST(target_freq * amd_cap_perf,
+					 cpudata->max_freq);
+
+	cpufreq_freq_transition_begin(policy, &freqs);
+	ret = amd_pstate_update(cpudata, amd_min_perf, amd_des_perf,
+				amd_max_perf, false);
+	cpufreq_freq_transition_end(policy, &freqs, false);
+
+	return ret;
+}
+
+static int amd_get_min_freq(struct amd_cpudata *cpudata)
+{
+	struct cppc_perf_caps cppc_perf;
+
+	int ret = cppc_get_perf_caps(cpudata->cpu, &cppc_perf);
+	if (ret)
+		return ret;
+
+	/* Switch to khz */
+	return cppc_perf.lowest_freq * 1000;
+}
+
+static int amd_get_max_freq(struct amd_cpudata *cpudata)
+{
+	struct cppc_perf_caps cppc_perf;
+	u32 max_perf, max_freq, nominal_freq, nominal_perf;
+	u64 boost_ratio;
+
+	int ret = cppc_get_perf_caps(cpudata->cpu, &cppc_perf);
+	if (ret)
+		return ret;
+
+	nominal_freq = cppc_perf.nominal_freq;
+	nominal_perf = READ_ONCE(cpudata->nominal_perf);
+	max_perf = READ_ONCE(cpudata->highest_perf);
+
+	boost_ratio = div_u64(max_perf << SCHED_CAPACITY_SHIFT,
+			      nominal_perf);
+
+	max_freq = nominal_freq * boost_ratio >> SCHED_CAPACITY_SHIFT;
+
+	/* Switch to khz */
+	return max_freq * 1000;
+}
+
+static int amd_get_nominal_freq(struct amd_cpudata *cpudata)
+{
+	struct cppc_perf_caps cppc_perf;
+	u32 nominal_freq;
+
+	int ret = cppc_get_perf_caps(cpudata->cpu, &cppc_perf);
+	if (ret)
+		return ret;
+
+	nominal_freq = cppc_perf.nominal_freq;
+
+	/* Switch to khz */
+	return nominal_freq * 1000;
+}
+
+static int amd_get_lowest_nonlinear_freq(struct amd_cpudata *cpudata)
+{
+	struct cppc_perf_caps cppc_perf;
+	u32 lowest_nonlinear_freq, lowest_nonlinear_perf,
+	    nominal_freq, nominal_perf;
+	u64 lowest_nonlinear_ratio;
+
+	int ret = cppc_get_perf_caps(cpudata->cpu, &cppc_perf);
+	if (ret)
+		return ret;
+
+	nominal_freq = cppc_perf.nominal_freq;
+	nominal_perf = READ_ONCE(cpudata->nominal_perf);
+
+	lowest_nonlinear_perf = cppc_perf.lowest_nonlinear_perf;
+
+	lowest_nonlinear_ratio = div_u64(lowest_nonlinear_perf <<
+					 SCHED_CAPACITY_SHIFT, nominal_perf);
+
+	lowest_nonlinear_freq = nominal_freq * lowest_nonlinear_ratio >> SCHED_CAPACITY_SHIFT;
+
+	/* Switch to khz */
+	return lowest_nonlinear_freq * 1000;
+}
+
+static int amd_pstate_init_freqs_in_cpudata(struct amd_cpudata *cpudata,
+					    u32 max_freq, u32 min_freq,
+					    u32 nominal_freq,
+					    u32 lowest_nonlinear_freq)
+{
+	if (!cpudata)
+		return -EINVAL;
+
+	/* Initial processor data capability frequencies */
+	cpudata->max_freq = max_freq;
+	cpudata->min_freq = min_freq;
+	cpudata->nominal_freq = nominal_freq;
+	cpudata->lowest_nonlinear_freq = lowest_nonlinear_freq;
+
+	return 0;
+}
+
+static struct amd_pstate_perf_funcs pstate_funcs = {
+	.enable = pstate_enable,
+	.init_perf = pstate_init_perf,
+	.update_perf = pstate_update_perf,
+};
+
+static int amd_pstate_cpu_init(struct cpufreq_policy *policy)
+{
+	int min_freq, max_freq, nominal_freq, lowest_nonlinear_freq, ret;
+	unsigned int cpu = policy->cpu;
+	struct device *dev;
+	struct amd_cpudata *cpudata;
+
+	dev = get_cpu_device(policy->cpu);
+	if (!dev)
+		return -ENODEV;
+
+	cpudata = kzalloc(sizeof(*cpudata), GFP_KERNEL);
+	if (!cpudata)
+		return -ENOMEM;
+
+	cpudata->cpu = cpu;
+	cpudata->policy = policy;
+
+	ret = amd_pstate_init_perf(cpudata);
+	if (ret)
+		goto free_cpudata1;
+
+	min_freq = amd_get_min_freq(cpudata);
+	max_freq = amd_get_max_freq(cpudata);
+	nominal_freq = amd_get_nominal_freq(cpudata);
+	lowest_nonlinear_freq = amd_get_lowest_nonlinear_freq(cpudata);
+
+	if (min_freq < 0 || max_freq < 0 || min_freq > max_freq) {
+		dev_err(dev, "min_freq(%d) or max_freq(%d) value is incorrect\n",
+			min_freq, max_freq);
+		ret = -EINVAL;
+		goto free_cpudata1;
+	}
+
+	policy->cpuinfo.transition_latency = AMD_PSTATE_TRANSITION_LATENCY;
+	policy->transition_delay_us = AMD_PSTATE_TRANSITION_DELAY;
+
+	policy->min = min_freq;
+	policy->max = max_freq;
+
+	policy->cpuinfo.min_freq = min_freq;
+	policy->cpuinfo.max_freq = max_freq;
+
+	/* It will be updated by governor */
+	policy->cur = policy->cpuinfo.min_freq;
+
+	ret = freq_qos_add_request(&policy->constraints, &cpudata->req[0],
+				   FREQ_QOS_MIN, policy->cpuinfo.min_freq);
+	if (ret < 0) {
+		dev_err(dev, "Failed to add min-freq constraint (%d)\n", ret);
+		goto free_cpudata1;
+	}
+
+	ret = freq_qos_add_request(&policy->constraints, &cpudata->req[1],
+				   FREQ_QOS_MAX, policy->cpuinfo.max_freq);
+	if (ret < 0) {
+		dev_err(dev, "Failed to add max-freq constraint (%d)\n", ret);
+		goto free_cpudata2;
+	}
+
+	ret = amd_pstate_init_freqs_in_cpudata(cpudata, max_freq, min_freq,
+					       nominal_freq,
+					       lowest_nonlinear_freq);
+	if (ret) {
+		dev_err(dev, "Failed to init cpudata (%d)\n", ret);
+		goto free_cpudata3;
+	}
+
+	policy->driver_data = cpudata;
+
+	return 0;
+
+free_cpudata3:
+	freq_qos_remove_request(&cpudata->req[1]);
+free_cpudata2:
+	freq_qos_remove_request(&cpudata->req[0]);
+free_cpudata1:
+	kfree(cpudata);
+	return ret;
+}
+
+static int amd_pstate_cpu_exit(struct cpufreq_policy *policy)
+{
+	struct amd_cpudata *cpudata;
+
+	cpudata = policy->driver_data;
+
+	freq_qos_remove_request(&cpudata->req[1]);
+	freq_qos_remove_request(&cpudata->req[0]);
+	kfree(cpudata);
+
+	return 0;
+}
+
+static struct cpufreq_driver amd_pstate_driver = {
+	.flags		= CPUFREQ_CONST_LOOPS | CPUFREQ_NEED_UPDATE_LIMITS,
+	.verify		= amd_pstate_verify,
+	.target		= amd_pstate_target,
+	.init		= amd_pstate_cpu_init,
+	.exit		= amd_pstate_cpu_exit,
+	.name		= "amd-pstate",
+};
+
+static int __init amd_pstate_init(void)
+{
+	int ret;
+	struct amd_pstate_perf_funcs *funcs;
+
+	if (boot_cpu_data.x86_vendor != X86_VENDOR_AMD)
+		return -ENODEV;
+
+	if (!acpi_cpc_valid()) {
+		pr_debug("%s, the _CPC object is not present in SBIOS\n",
+			 __func__);
+		return -ENODEV;
+	}
+
+	/* don't keep reloading if cpufreq_driver exists */
+	if (cpufreq_get_current_driver())
+		return -EEXIST;
+
+	/* capability check */
+	if (!boot_cpu_has(X86_FEATURE_AMD_CPPC_EXT)) {
+		pr_debug("%s, AMD CPPC extension functionality is supported\n",
+			 __func__);
+		return -ENODEV;
+	}
+
+	funcs = &pstate_funcs;
+
+	/* enable amd pstate feature */
+	ret = amd_pstate_enable(funcs, true);
+	if (ret) {
+		pr_err("%s, failed to enable amd-pstate with return %d\n",
+		       __func__, ret);
+		return ret;
+	}
+
+	amd_pstate_driver.driver_data = funcs;
+
+	ret = cpufreq_register_driver(&amd_pstate_driver);
+	if (ret) {
+		pr_err("%s, return %d\n", __func__, ret);
+		return ret;
+	}
+
+	return 0;
+}
+
+static void __exit amd_pstate_exit(void)
+{
+	struct amd_pstate_perf_funcs *funcs;
+
+	funcs = cpufreq_get_driver_data();
+
+	cpufreq_unregister_driver(&amd_pstate_driver);
+
+	amd_pstate_enable(funcs, false);
+}
+
+module_init(amd_pstate_init);
+module_exit(amd_pstate_exit);
+
+MODULE_AUTHOR("Huang Rui <ray.huang@amd.com>");
+MODULE_DESCRIPTION("AMD Processor P-state Frequency Driver");
+MODULE_LICENSE("GPL");
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-18.8 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,USER_AGENT_GIT
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id D71FBC433EF
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:40 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id BE2A0611AF
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:40 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1352031AbhIHPCq (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 11:02:46 -0400
Received: from mail-dm6nam11on2045.outbound.protection.outlook.com ([40.107.223.45]:47520
        "EHLO NAM11-DM6-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1351981AbhIHPCZ (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 11:02:25 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=BZtyFP3YClzfHuyTZNbVOdxbdBXO4sb7W68sQdrnmY67XFd3yX+O37pDR+gWdMv0Gle/m4XVVUv5oZRay1oWTnAHTuXxSwGLB7+gCbRqwB9rD1BiGhF9ZhzDUSuWV6daEB5ofo/rycYLPsYhc2VxzUk/LPftoYV2y25tKbCFMPFBImOm777IAIae7o4eb6Dg9isEACK9pMXPktfGmWUELKX3WEPrJ6NhtqJLRahXzJf45ODh+DKciq0YqD/oQOnYiehKlBJC120OikI+ohYsYkaG/PKGx+vRO9e6hsvoqkUYY2e+Gn7GwRheAXldQR2G42WD9zDtkP/iTvqMgVkRqw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=kICpFLu37eoB4wt/Yx0uJ2udQSVOEfwp4F6L+dk7Wko=;
 b=hN1U2Sc+UocMxDv9ZXLYpvJNHFZONJ/hivRuvL/idgtaumD0Al0AFtCfbev1lML0JwYjKTVv0uTsZsVQrH5NWF/xj9N24rNK65NXdcYqdcpkILJjgtdn1y+KtyFnBRlDXjYTadhe1Hwa55RMU6gauDMevAkob6BxZCT8tVAGv2V6b5ET+jf6NrXhRAVo5T1aLV0lroCcsmYJggYPW1wNyazDLAY4P87sA8U9WZmghZ6+1pjPWHnY2eDFhGQSQtwA6dHJ71DDn8MUGAdYiJfYsIQL4812XLZEtgIogHLd3nDZIF2HByT8OPYKA6FE+qmZpSzmTdTJ62StHqTAtubhuA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=kICpFLu37eoB4wt/Yx0uJ2udQSVOEfwp4F6L+dk7Wko=;
 b=vJZH4p/7tFyh+aPFZ4blW78XaR8lKzH06ry0BoL9s4NogsKpuIahJpQ1AvVx0YP+AX9b8bTHt6whLXDwPuL8MLSHUpONDPpMk6Cgh76fSHgMrJ7DiVr5wNf2pCBGR5aW82lb9P956jzpL0hTL33zM1BXIApc7rSCsCOJOaHfdKQ=
Received: from MWHPR11CA0038.namprd11.prod.outlook.com (2603:10b6:300:115::24)
 by MWHPR1201MB0143.namprd12.prod.outlook.com (2603:10b6:301:54::16) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14; Wed, 8 Sep
 2021 15:01:11 +0000
Received: from CO1NAM11FT036.eop-nam11.prod.protection.outlook.com
 (2603:10b6:300:115:cafe::cb) by MWHPR11CA0038.outlook.office365.com
 (2603:10b6:300:115::24) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Wed, 8 Sep 2021 15:01:11 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CO1NAM11FT036.mail.protection.outlook.com (10.13.174.124) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 15:01:11 +0000
Received: from hr-amd.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Wed, 8 Sep 2021
 10:01:05 -0500
From:   Huang Rui <ray.huang@amd.com>
To:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        <linux-pm@vger.kernel.org>
CC:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        <linux-kernel@vger.kernel.org>, <x86@kernel.org>,
        Huang Rui <ray.huang@amd.com>
Subject: [PATCH 05/19] cpufreq: amd: add fast switch function for amd-pstate module
Date:   Wed, 8 Sep 2021 22:59:47 +0800
Message-ID: <20210908150001.3702552-6-ray.huang@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210908150001.3702552-1-ray.huang@amd.com>
References: <20210908150001.3702552-1-ray.huang@amd.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Type: text/plain
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 9751629c-aa0a-4fae-86d9-08d972d97f38
X-MS-TrafficTypeDiagnostic: MWHPR1201MB0143:
X-Microsoft-Antispam-PRVS: <MWHPR1201MB01436B37375DA40D6602D665ECD49@MWHPR1201MB0143.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:2803;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 9Nr+Ib6p6gSYR610owIZbVKm1+izZ6SfCGolmTGk7J3VSTHwFRBeRLzNJfbW6XBLEQAn46xABp4dv3Z+e1D3aCf7HeNZOTkoJVxvQ3e/+Esg2iYVd2czC0FJ3cuGJTVGjeRIlp0cYGqSAoUggGmUX0AwAdRw8j0YHwTjzrFrxmzcjLpjNHdGadTMqhhmaD8YqR2uB/pRHTlEbumMLezyBJmIRYktxAQBl/U96/dKRUaiXaex99En3m75t6iug5xA4r8bNlGxddvz4PEy4fphbzxunC7JW6AOciJ2zPRMkjXMhvT755rxwkvUJeqfkX0aEre9l+EdcvDd4LoFaG59YZ+ExuIZx2g7Ac9iRLwpoWKU2tj7fJWSGQ6lWd11bvo30zuohEqi02+YDsJHdgcjxT71ZW1AeyldnymP6FxFlGftF0ENVGJ3T3olqwJCW4CGTztiCkwJQoLEiCRZzzjtuFSMm7+1SSay7vE3AE2BNk1zJyPsutWSrYd+lTP8pO0krTr3vMBwOS/bZSret8DXJEanR34/p5mvb7IodDDBnHHZDKJ2SyvcqecgSNFJ9QCzZoDryX4svUxZ4YpF94CJxNQE4k6vIiJDNcMljBU8n3TbW+tvyFSbtkS15XwupX2AIbgmoSvr/RB5HPXIBAvIrPAcdrNCnGKzAOIieoDIZvdvVLBWp4uVN5j+VgZcjvnAnvVtsg4r/2ugNrHctmVWI+CBAUuPIh4sQdcLdPYlEGw=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(46966006)(36840700001)(83380400001)(36860700001)(6666004)(70206006)(70586007)(2616005)(4326008)(81166007)(36756003)(82310400003)(47076005)(16526019)(2906002)(316002)(186003)(54906003)(110136005)(7696005)(8936002)(86362001)(5660300002)(26005)(508600001)(336012)(356005)(8676002)(1076003)(426003)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 15:01:11.5847
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 9751629c-aa0a-4fae-86d9-08d972d97f38
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: CO1NAM11FT036.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MWHPR1201MB0143
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Introduce the fast switch function for amd-pstate module on the AMD
processors which support the full MSR register control. It's able to
decrease the lattency on interrupt context.

Signed-off-by: Huang Rui <ray.huang@amd.com>
---
 drivers/cpufreq/amd-pstate.c | 64 ++++++++++++++++++++++++++++++++++++
 1 file changed, 64 insertions(+)

diff --git a/drivers/cpufreq/amd-pstate.c b/drivers/cpufreq/amd-pstate.c
index 4c9c9bf1d72b..32b4f6d79783 100644
--- a/drivers/cpufreq/amd-pstate.c
+++ b/drivers/cpufreq/amd-pstate.c
@@ -212,6 +212,66 @@ static int amd_pstate_target(struct cpufreq_policy *policy,
 	return ret;
 }
 
+static void amd_pstate_adjust_perf(unsigned int cpu,
+				   unsigned long min_perf,
+				   unsigned long target_perf,
+				   unsigned long capacity)
+{
+	unsigned long amd_max_perf, amd_min_perf, amd_des_perf,
+		      amd_cap_perf, lowest_nonlinear_perf;
+	struct cpufreq_policy *policy = cpufreq_cpu_get(cpu);
+	struct amd_cpudata *cpudata = policy->driver_data;
+
+	amd_cap_perf = READ_ONCE(cpudata->highest_perf);
+	lowest_nonlinear_perf = READ_ONCE(cpudata->lowest_nonlinear_perf);
+
+	if (target_perf < capacity)
+		amd_des_perf = DIV_ROUND_UP(amd_cap_perf * target_perf,
+					    capacity);
+
+	amd_min_perf = READ_ONCE(cpudata->highest_perf);
+	if (min_perf < capacity)
+		amd_min_perf = DIV_ROUND_UP(amd_cap_perf * min_perf, capacity);
+
+	if (amd_min_perf < lowest_nonlinear_perf)
+		amd_min_perf = lowest_nonlinear_perf;
+
+	amd_max_perf = amd_cap_perf;
+	if (amd_max_perf < amd_min_perf)
+		amd_max_perf = amd_min_perf;
+
+	amd_des_perf = clamp_t(unsigned long, amd_des_perf,
+			       amd_min_perf, amd_max_perf);
+
+	amd_pstate_update(cpudata, amd_min_perf, amd_des_perf,
+			  amd_max_perf, true);
+}
+
+static unsigned int amd_pstate_fast_switch(struct cpufreq_policy *policy,
+					   unsigned int target_freq)
+{
+	u64 ratio;
+	struct amd_cpudata *cpudata = policy->driver_data;
+	unsigned long amd_max_perf, amd_min_perf, amd_des_perf, nominal_perf;
+
+	if (!cpudata->max_freq)
+		return -ENODEV;
+
+	amd_max_perf = READ_ONCE(cpudata->highest_perf);
+	amd_min_perf = READ_ONCE(cpudata->lowest_nonlinear_perf);
+
+	amd_des_perf = DIV_ROUND_UP(target_freq * amd_max_perf,
+				    cpudata->max_freq);
+
+	amd_pstate_update(cpudata, amd_min_perf, amd_des_perf,
+			  amd_max_perf, true);
+
+	nominal_perf = READ_ONCE(cpudata->nominal_perf);
+	ratio = div_u64(amd_des_perf << SCHED_CAPACITY_SHIFT, nominal_perf);
+
+	return cpudata->nominal_freq * ratio >> SCHED_CAPACITY_SHIFT;
+}
+
 static int amd_get_min_freq(struct amd_cpudata *cpudata)
 {
 	struct cppc_perf_caps cppc_perf;
@@ -356,6 +416,8 @@ static int amd_pstate_cpu_init(struct cpufreq_policy *policy)
 	/* It will be updated by governor */
 	policy->cur = policy->cpuinfo.min_freq;
 
+	policy->fast_switch_possible = true;
+
 	ret = freq_qos_add_request(&policy->constraints, &cpudata->req[0],
 				   FREQ_QOS_MIN, policy->cpuinfo.min_freq);
 	if (ret < 0) {
@@ -408,6 +470,8 @@ static struct cpufreq_driver amd_pstate_driver = {
 	.flags		= CPUFREQ_CONST_LOOPS | CPUFREQ_NEED_UPDATE_LIMITS,
 	.verify		= amd_pstate_verify,
 	.target		= amd_pstate_target,
+	.fast_switch    = amd_pstate_fast_switch,
+	.adjust_perf    = amd_pstate_adjust_perf,
 	.init		= amd_pstate_cpu_init,
 	.exit		= amd_pstate_cpu_exit,
 	.name		= "amd-pstate",
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-18.8 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,USER_AGENT_GIT
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 99B98C433FE
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:44 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 86F8D61051
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:44 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1352055AbhIHPCv (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 11:02:51 -0400
Received: from mail-co1nam11on2044.outbound.protection.outlook.com ([40.107.220.44]:25313
        "EHLO NAM11-CO1-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1352015AbhIHPCY (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 11:02:24 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=gmYtO6RmDCS2gzRVDoljBJjDizR/nC5HBlA8cvXfo9E8gWrCMNdwNkae/Ctl9nhINu4l9qbvIqgFCO99gBFeN+kyw7qw8RVMQG8N/7PDgfjq6SDkRsjkj+tSwo2HdbZlSHa05CSfj4Kr8vq2udD9hmZe7Qv0hcxe0GUAEcA4qGRLJ/n/d/lxR/FA2FCczzYx7BWaqMVylQs0r+SoV5/QZnshfhtDVabESenBiJK4pTVGr7QdnxlyPjs4KjgWVdpkbHIs9+AscOqBV5aqr1afG1UGDPRqCuS4IHGy7FgfRxl9AnzKtPRd+7RVRVCB7SSKqe6sqta4jczo7k40TrllVg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=GZD4gX9z4G98n+6E/ckRy4Stj5dZwEFnwu5IFI+QCz0=;
 b=BXg9+BuK4lCkHlvI+HHRlxD/rLUL6+/mcxvz2PKB/dLlB2VTZBf67R2inlcrHIbSjkoDIrhDUBCSGXHoqKe5AZMHqaw2wiU9opVTLZluMlNXdR2/Vgga6U/5er5l+cWFWvHRMIqlYHCrRVA+lN0uQnqwZOaHdsDEUuLEuoU7kpjcbV9BseLwmXJi4qmCHkY87KcJzsh2E74FdssCFB2DayMPnDOkRoUBrWDOZmEvTkIgblw1QJeSr92LtFfaQ6teVXGhwBWFpnp2U6UYDtFfdSWCST/lECIVJCRy891B3GoQlVtC0NfijUjeG0lcskwwBMrvKKTYEOo5Q/BBogqsVQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=GZD4gX9z4G98n+6E/ckRy4Stj5dZwEFnwu5IFI+QCz0=;
 b=lW+Vu/BfBBEkhCxh+Lz9Qcstf13pfLfli/2owPR7wfjLfyfGxlYliWkwbSKxKxLR/ggwQil+h+WdOF9l1Nt0lGdYnN1e6j26NjZrAarwdahTn0OOs6EVIZXR4LXMw1YTyzXmhYUdb9iN0B9e92dEGSIPNz6NvzEvitDpwFJAdIk=
Received: from MWHPR11CA0041.namprd11.prod.outlook.com (2603:10b6:300:115::27)
 by CH2PR12MB4860.namprd12.prod.outlook.com (2603:10b6:610:6c::17) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4478.25; Wed, 8 Sep
 2021 15:01:14 +0000
Received: from CO1NAM11FT036.eop-nam11.prod.protection.outlook.com
 (2603:10b6:300:115:cafe::74) by MWHPR11CA0041.outlook.office365.com
 (2603:10b6:300:115::27) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Wed, 8 Sep 2021 15:01:14 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CO1NAM11FT036.mail.protection.outlook.com (10.13.174.124) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 15:01:14 +0000
Received: from hr-amd.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Wed, 8 Sep 2021
 10:01:08 -0500
From:   Huang Rui <ray.huang@amd.com>
To:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        <linux-pm@vger.kernel.org>
CC:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        <linux-kernel@vger.kernel.org>, <x86@kernel.org>,
        Huang Rui <ray.huang@amd.com>
Subject: [PATCH 06/19] cpufreq: amd: add acpi cppc function as the backend for legacy processors
Date:   Wed, 8 Sep 2021 22:59:48 +0800
Message-ID: <20210908150001.3702552-7-ray.huang@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210908150001.3702552-1-ray.huang@amd.com>
References: <20210908150001.3702552-1-ray.huang@amd.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Type: text/plain
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 219fec5b-6fad-4734-3d6a-08d972d980ad
X-MS-TrafficTypeDiagnostic: CH2PR12MB4860:
X-Microsoft-Antispam-PRVS: <CH2PR12MB4860630FCC84E56179E7ECB1ECD49@CH2PR12MB4860.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:3383;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: CDaNJZnvnMbm/XMsYvBAGMi3AXlNkUJlkKevn8MhAXdFf13xXFw2Qg4BBghTh2sD20RbkJy8dLRzWexKDgYRsztQ8MUvGI1a3iVILds6JJtd2I+zzJY2Hw//tkPscEwPJ0pMn/42tCdy/NWgQmmnh+88aTzyY2mUl7/g5XhVwSqjnzQo7ywEkmhXIXa9SDrH/68cHDQrxh40IoQKpBdcCA3I93qSH3CooBKaW6BRJYnUqL2KcRx9H9NdCc50aECkEBJzJUE3q6bUrLhgYhrmiJwvsVno3muoFGj4Ycm1of2AIs+hZ9ES+1oi6P1sG4eTLG7Df1CTl81ZsDg7IPaql+pwFEjx959XfvrZzhCOEAvUPx9ScmjfoSUzdNzm4aQiL0X79RG4YUrIM+K/fCchU76KqL5tMANERzDD2tCtl4CalLNMjs7bgkQ12w5iojNmrUILd/xMAM17lg8t5DtMgFMAAddqAgk4+PdI/jHsRw3EaEmEhcPEH/Nn9RC6oFm7SaVFKVulOYhmUK81Bo5LH9PemyBeJzf4lK3aPx/IM/U/hP9fKQro3j/22tDKeRFY2/UAvUt+RHttnQcVmrqCb5HZvgslmqNzSqzy+auF4UpoupzTkUjn2puSUDhS9ApgEiEeKeyJUS0iVs1IEZZZIKN/ZiFRViDEcbDHXT9XqXQa5WV04jBlgDWhh3InmIQ6vHppqx3ldo55+oXIKTSJXtny5PU8cHSL2Cidc/BTBu4=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(36840700001)(46966006)(47076005)(70206006)(316002)(8676002)(7696005)(81166007)(54906003)(336012)(356005)(8936002)(426003)(110136005)(83380400001)(2616005)(4326008)(86362001)(508600001)(36756003)(186003)(5660300002)(1076003)(16526019)(26005)(2906002)(70586007)(82310400003)(6666004)(36860700001)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 15:01:14.0303
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 219fec5b-6fad-4734-3d6a-08d972d980ad
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: CO1NAM11FT036.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: CH2PR12MB4860
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

In some old Zen based processors, they are using the shared memory that
exposed from ACPI SBIOS.

Signed-off-by: Jinzhou Su <Jinzhou.Su@amd.com>
Signed-off-by: Huang Rui <ray.huang@amd.com>
---
 drivers/cpufreq/amd-pstate.c | 63 ++++++++++++++++++++++++++++++++----
 1 file changed, 57 insertions(+), 6 deletions(-)

diff --git a/drivers/cpufreq/amd-pstate.c b/drivers/cpufreq/amd-pstate.c
index 32b4f6d79783..a46cd5dd9f7c 100644
--- a/drivers/cpufreq/amd-pstate.c
+++ b/drivers/cpufreq/amd-pstate.c
@@ -82,6 +82,19 @@ static inline int pstate_enable(bool enable)
 	return wrmsrl_safe(MSR_AMD_CPPC_ENABLE, enable ? 1 : 0);
 }
 
+static int cppc_enable(bool enable)
+{
+	int cpu, ret = 0;
+
+	for_each_online_cpu(cpu) {
+		ret = cppc_set_enable(cpu, enable ? 1 : 0);
+		if (ret)
+			return ret;
+	}
+
+	return ret;
+}
+
 static int
 amd_pstate_enable(struct amd_pstate_perf_funcs *funcs, bool enable)
 {
@@ -113,6 +126,24 @@ static int pstate_init_perf(struct amd_cpudata *cpudata)
 	return 0;
 }
 
+static int cppc_init_perf(struct amd_cpudata *cpudata)
+{
+	struct cppc_perf_caps cppc_perf;
+
+	int ret = cppc_get_perf_caps(cpudata->cpu, &cppc_perf);
+	if (ret)
+		return ret;
+
+	WRITE_ONCE(cpudata->highest_perf, amd_get_highest_perf());
+
+	WRITE_ONCE(cpudata->nominal_perf, cppc_perf.nominal_perf);
+	WRITE_ONCE(cpudata->lowest_nonlinear_perf,
+		   cppc_perf.lowest_nonlinear_perf);
+	WRITE_ONCE(cpudata->lowest_perf, cppc_perf.lowest_perf);
+
+	return 0;
+}
+
 static int amd_pstate_init_perf(struct amd_cpudata *cpudata)
 {
 	struct amd_pstate_perf_funcs *funcs = cpufreq_get_driver_data();
@@ -134,6 +165,19 @@ static void pstate_update_perf(struct amd_cpudata *cpudata,
 			      READ_ONCE(cpudata->cppc_req_cached));
 }
 
+static void cppc_update_perf(struct amd_cpudata *cpudata,
+			     u32 min_perf, u32 des_perf,
+			     u32 max_perf, bool fast_switch)
+{
+	struct cppc_perf_ctrls perf_ctrls;
+
+	perf_ctrls.max_perf = max_perf;
+	perf_ctrls.min_perf = min_perf;
+	perf_ctrls.desired_perf = des_perf;
+
+	cppc_set_perf(cpudata->cpu, &perf_ctrls);
+}
+
 static int
 amd_pstate_update_perf(struct amd_cpudata *cpudata, u32 min_perf,
 		       u32 des_perf, u32 max_perf, bool fast_switch)
@@ -370,6 +414,12 @@ static struct amd_pstate_perf_funcs pstate_funcs = {
 	.update_perf = pstate_update_perf,
 };
 
+static struct amd_pstate_perf_funcs cppc_funcs = {
+	.enable = cppc_enable,
+	.init_perf = cppc_init_perf,
+	.update_perf = cppc_update_perf,
+};
+
 static int amd_pstate_cpu_init(struct cpufreq_policy *policy)
 {
 	int min_freq, max_freq, nominal_freq, lowest_nonlinear_freq, ret;
@@ -416,7 +466,8 @@ static int amd_pstate_cpu_init(struct cpufreq_policy *policy)
 	/* It will be updated by governor */
 	policy->cur = policy->cpuinfo.min_freq;
 
-	policy->fast_switch_possible = true;
+	if (boot_cpu_has(X86_FEATURE_AMD_CPPC_EXT))
+		policy->fast_switch_possible = true;
 
 	ret = freq_qos_add_request(&policy->constraints, &cpudata->req[0],
 				   FREQ_QOS_MIN, policy->cpuinfo.min_freq);
@@ -471,7 +522,6 @@ static struct cpufreq_driver amd_pstate_driver = {
 	.verify		= amd_pstate_verify,
 	.target		= amd_pstate_target,
 	.fast_switch    = amd_pstate_fast_switch,
-	.adjust_perf    = amd_pstate_adjust_perf,
 	.init		= amd_pstate_cpu_init,
 	.exit		= amd_pstate_cpu_exit,
 	.name		= "amd-pstate",
@@ -496,14 +546,15 @@ static int __init amd_pstate_init(void)
 		return -EEXIST;
 
 	/* capability check */
-	if (!boot_cpu_has(X86_FEATURE_AMD_CPPC_EXT)) {
+	if (boot_cpu_has(X86_FEATURE_AMD_CPPC_EXT)) {
 		pr_debug("%s, AMD CPPC extension functionality is supported\n",
 			 __func__);
-		return -ENODEV;
+		funcs = &pstate_funcs;
+		amd_pstate_driver.adjust_perf = amd_pstate_adjust_perf;
+	} else {
+		funcs = &cppc_funcs;
 	}
 
-	funcs = &pstate_funcs;
-
 	/* enable amd pstate feature */
 	ret = amd_pstate_enable(funcs, true);
 	if (ret) {
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-18.8 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,USER_AGENT_GIT
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 4293EC433EF
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:46 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 2F41161179
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:46 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1352066AbhIHPCw (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 11:02:52 -0400
Received: from mail-dm6nam11on2067.outbound.protection.outlook.com ([40.107.223.67]:22880
        "EHLO NAM11-DM6-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1352028AbhIHPC1 (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 11:02:27 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=l1Psp6lPRCpVsDKtE/HCN2+EmQ8Rzr1QZrBQNaitHSfYOXAxYmhIo2DymvoNR4ILH1O0oza5TG7bCcAF6kHMI0xEydpPRHUOEDnlb13ZBydzaGQWQyUL/AszpSvcTUJTKkykFZdoUgkfUY/c4crsWn40f0+LicQMIaZgUPCvXy/f0xIG3l7uIrjTI1ibRQhR69wui4UIr72IAD6h9gwYjs11kR6v0Jj7d3dqZ8p2va2TAFFWoaqUaQpxEgvcvuQi5xSZKRVfgqXCr6SjSrIFViA6KOLFBiIR4tmoZad1jES/twpprvgbWyJeGvDmj4QtdpNnuOREcVfLqUejchgsdg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=+MMaxpoA1pj2VeOMvmf+vhiHZubtbC+jmD+2ab7dzMw=;
 b=Z4CQKR0g2jglvfZbxG02QOvnp2mOcSSSWTVm5nkTtsfaqgRoIBZdd5ydeoNPFQ/Vrh5yWs+xaumVhrlq0j8IeRR2zyXZP6AYXE/0LeWSnQe5MRipGwiNPp33uZuOsunwr9gc7765+4EGho0+eOBYz8faRWTwmEcWVrqNddEyx2wDawyckHaB4GociMXjqLb0JVwpAs1p1vTlAiKzwgjMskV/s12lnhUCImHEzEGu2/bpWjv0uxFaPJ4Rsr2w33wtgvM4weT64gp9Jk5ba5FesAyOxEUH2bHXJWbgIFFoBxMreG+W2D06f9BTwVM73J8UDLNVkDt2npuvYz+O34816g==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=+MMaxpoA1pj2VeOMvmf+vhiHZubtbC+jmD+2ab7dzMw=;
 b=48hLxwtudvXY0JHzMSVbhB7Z037J14s7OWM1YDq5zdmy5fveiHyX2Walh5FpcDIXulQseT8ANFZM9va2XKtBkvQJqPnuNfjwIcBT+MqQuuV87x9miy6D/beyCJFq8c0YtdpJpgAZuhAOeQVct6FYoXrHipJGcEdrgQQbKZipgVc=
Received: from MWHPR11CA0037.namprd11.prod.outlook.com (2603:10b6:300:115::23)
 by DM6PR12MB2764.namprd12.prod.outlook.com (2603:10b6:5:4a::30) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4478.24; Wed, 8 Sep
 2021 15:01:17 +0000
Received: from CO1NAM11FT036.eop-nam11.prod.protection.outlook.com
 (2603:10b6:300:115:cafe::ca) by MWHPR11CA0037.outlook.office365.com
 (2603:10b6:300:115::23) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Wed, 8 Sep 2021 15:01:17 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CO1NAM11FT036.mail.protection.outlook.com (10.13.174.124) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 15:01:17 +0000
Received: from hr-amd.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Wed, 8 Sep 2021
 10:01:12 -0500
From:   Huang Rui <ray.huang@amd.com>
To:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        <linux-pm@vger.kernel.org>
CC:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        <linux-kernel@vger.kernel.org>, <x86@kernel.org>,
        Huang Rui <ray.huang@amd.com>
Subject: [PATCH 07/19] cpufreq: amd: add trace for amd-pstate module
Date:   Wed, 8 Sep 2021 22:59:49 +0800
Message-ID: <20210908150001.3702552-8-ray.huang@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210908150001.3702552-1-ray.huang@amd.com>
References: <20210908150001.3702552-1-ray.huang@amd.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Type: text/plain
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 9edc7ddf-d191-42c8-d58c-08d972d982a0
X-MS-TrafficTypeDiagnostic: DM6PR12MB2764:
X-Microsoft-Antispam-PRVS: <DM6PR12MB27640B05C6915F8B5FF16B58ECD49@DM6PR12MB2764.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:9508;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: hXd8Mc6kegzy5iogNlL0Uqw97i3z6/4cIN9JjJpa/VFQrTyyiNUYcCWnLK7Zwmff7+Hz0Gyq6PbBDltvmMVdKhrW9uN0JUriTnpTd5YUtzpOz4xz/yPSlzZ8zzkKNegIYRuEn6ty/pKGdH1qV99MI/bwf8Xn6sEg61IWZYqFlIUjg4blY9pH/dVGHWGlJik28p0r4B+2nERgYcjkZkTjD3boEWJcw4+GaA+JfW/iKeCSQoavWzDUUwmyu5rmG2+2ZMGYpxrqNy6L0QglGUNiDXJ0SuuKXCcrf15Wc2/BQQaKiTu51KcE0xhJ3YKR7ymZHQSeWwZk25jjrb22z7iEPWZQo8m9zUlzn0emi0JxCiCB0B4s3xnkrF8A4rFtwvxEuVDNWV2Ub4dtIUDBtITuvchNPIqoWlzA/hafNubcd9/bxN2azMQu0BGr6isGxUu/JW4bMoTNXLuKpBD2DXaa7qeo76/gVGsIMFPY1oNi0nqi4xfNb5pdtkVylHMOQky3I0nHGpGda+9JeScfox3nHZvFUwlR+R8XOjVO7ee0nruxZid09CAhs6XHljnmCXaWU2UwP+WwMKZeg/L8aqu4vipYoc1PdUTHWHZWvTi5WWpFL71DB5TMCdZy8HGrgwLKpb2CEKwncJ4MMnmBR1rICZBcf1ybqQTzI0eOruschkGTAi58+jp3ctgH/RTmc1ITMtdjUImVO1VvZqSm89oL5qLfGMCMa8Xi9p3+0Vr7mPARO5izEJRNWvixK0sU/JgO
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(376002)(346002)(136003)(396003)(39860400002)(46966006)(36840700001)(82310400003)(8676002)(70586007)(4326008)(186003)(5660300002)(36860700001)(336012)(70206006)(86362001)(2906002)(2616005)(83380400001)(8936002)(426003)(6666004)(47076005)(16526019)(36756003)(316002)(82740400003)(26005)(1076003)(110136005)(7696005)(54906003)(81166007)(478600001)(356005)(2004002)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 15:01:17.3034
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 9edc7ddf-d191-42c8-d58c-08d972d982a0
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: CO1NAM11FT036.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB2764
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Add trace event to monitor the performance value changes which is
controlled by cpu governors.

Signed-off-by: Huang Rui <ray.huang@amd.com>
---
 drivers/cpufreq/Makefile           |  6 +-
 drivers/cpufreq/amd-pstate-trace.c |  2 +
 drivers/cpufreq/amd-pstate-trace.h | 96 ++++++++++++++++++++++++++++++
 drivers/cpufreq/amd-pstate.c       | 19 ++++--
 4 files changed, 118 insertions(+), 5 deletions(-)
 create mode 100644 drivers/cpufreq/amd-pstate-trace.c
 create mode 100644 drivers/cpufreq/amd-pstate-trace.h

diff --git a/drivers/cpufreq/Makefile b/drivers/cpufreq/Makefile
index 3d4bd7141cf8..c1909475eaf9 100644
--- a/drivers/cpufreq/Makefile
+++ b/drivers/cpufreq/Makefile
@@ -17,6 +17,10 @@ obj-$(CONFIG_CPU_FREQ_GOV_ATTR_SET)	+= cpufreq_governor_attr_set.o
 obj-$(CONFIG_CPUFREQ_DT)		+= cpufreq-dt.o
 obj-$(CONFIG_CPUFREQ_DT_PLATDEV)	+= cpufreq-dt-platdev.o
 
+# Traces
+CFLAGS_amd-pstate-trace.o               := -I$(src)
+amd_pstate-y				:= amd-pstate.o amd-pstate-trace.o
+
 ##################################################################################
 # x86 drivers.
 # Link order matters. K8 is preferred to ACPI because of firmware bugs in early
@@ -24,7 +28,7 @@ obj-$(CONFIG_CPUFREQ_DT_PLATDEV)	+= cpufreq-dt-platdev.o
 # powernow-k8 can load then. ACPI is preferred to all other hardware-specific drivers.
 # speedstep-* is preferred over p4-clockmod.
 
-obj-$(CONFIG_X86_AMD_PSTATE)		+= amd-pstate.o
+obj-$(CONFIG_X86_AMD_PSTATE)		+= amd_pstate.o
 obj-$(CONFIG_X86_ACPI_CPUFREQ)		+= acpi-cpufreq.o
 obj-$(CONFIG_X86_POWERNOW_K8)		+= powernow-k8.o
 obj-$(CONFIG_X86_PCC_CPUFREQ)		+= pcc-cpufreq.o
diff --git a/drivers/cpufreq/amd-pstate-trace.c b/drivers/cpufreq/amd-pstate-trace.c
new file mode 100644
index 000000000000..891b696dcd69
--- /dev/null
+++ b/drivers/cpufreq/amd-pstate-trace.c
@@ -0,0 +1,2 @@
+#define CREATE_TRACE_POINTS
+#include "amd-pstate-trace.h"
diff --git a/drivers/cpufreq/amd-pstate-trace.h b/drivers/cpufreq/amd-pstate-trace.h
new file mode 100644
index 000000000000..50c85e150f30
--- /dev/null
+++ b/drivers/cpufreq/amd-pstate-trace.h
@@ -0,0 +1,96 @@
+/* SPDX-License-Identifier: GPL-2.0 */
+/*
+ * amd-pstate-trace.h - AMD Processor P-state Frequency Driver Tracer
+ *
+ * Copyright (C) 2021 Advanced Micro Devices, Inc. All Rights Reserved.
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License along with
+ * this program; if not, write to the Free Software
+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
+ *
+ * Author: Huang Rui <ray.huang@amd.com>
+ */
+
+#if !defined(_AMD_PSTATE_TRACE_H) || defined(TRACE_HEADER_MULTI_READ)
+#define _AMD_PSTATE_TRACE_H
+
+#include <linux/cpufreq.h>
+#include <linux/tracepoint.h>
+#include <linux/trace_events.h>
+
+#undef TRACE_SYSTEM
+#define TRACE_SYSTEM amd_cpu
+
+#undef TRACE_INCLUDE_FILE
+#define TRACE_INCLUDE_FILE amd-pstate-trace
+
+#define TPS(x)  tracepoint_string(x)
+
+TRACE_EVENT(amd_pstate_perf,
+
+	TP_PROTO(unsigned long min_perf,
+		 unsigned long target_perf,
+		 unsigned long capacity,
+		 unsigned int cpu_id,
+		 u64 prev,
+		 u64 value,
+		 int type
+		 ),
+
+	TP_ARGS(min_perf,
+		target_perf,
+		capacity,
+		cpu_id,
+		prev,
+		value,
+		type
+		),
+
+	TP_STRUCT__entry(
+		__field(unsigned long, min_perf)
+		__field(unsigned long, target_perf)
+		__field(unsigned long, capacity)
+		__field(unsigned int, cpu_id)
+		__field(u64, prev)
+		__field(u64, value)
+		__field(int, type)
+		),
+
+	TP_fast_assign(
+		__entry->min_perf = min_perf;
+		__entry->target_perf = target_perf;
+		__entry->capacity = capacity;
+		__entry->cpu_id = cpu_id;
+		__entry->prev = prev;
+		__entry->value = value;
+		__entry->type = type;
+		),
+
+	TP_printk("amd_min_perf=%lu amd_des_perf=%lu amd_max_perf=%lu cpu_id=%u prev=0x%llx value=0x%llx type=0x%d",
+		  (unsigned long)__entry->min_perf,
+		  (unsigned long)__entry->target_perf,
+		  (unsigned long)__entry->capacity,
+		  (unsigned int)__entry->cpu_id,
+		  (u64)__entry->prev,
+		  (u64)__entry->value,
+		  (int)__entry->type
+		 )
+);
+
+#endif /* _AMD_PSTATE_TRACE_H */
+
+/* This part must be outside protection */
+#undef TRACE_INCLUDE_PATH
+#define TRACE_INCLUDE_PATH .
+
+#include <trace/define_trace.h>
diff --git a/drivers/cpufreq/amd-pstate.c b/drivers/cpufreq/amd-pstate.c
index a46cd5dd9f7c..ea965a122431 100644
--- a/drivers/cpufreq/amd-pstate.c
+++ b/drivers/cpufreq/amd-pstate.c
@@ -44,10 +44,18 @@
 #include <asm/processor.h>
 #include <asm/cpufeature.h>
 #include <asm/cpu_device_id.h>
+#include "amd-pstate-trace.h"
 
 #define AMD_PSTATE_TRANSITION_LATENCY	0x20000
 #define AMD_PSTATE_TRANSITION_DELAY	500
 
+enum switch_type
+{
+	AMD_TARGET = 0,
+	AMD_ADJUST_PERF,
+	AMD_FAST_SWITCH,
+};
+
 static struct cpufreq_driver amd_pstate_driver;
 
 struct amd_cpudata {
@@ -195,7 +203,8 @@ amd_pstate_update_perf(struct amd_cpudata *cpudata, u32 min_perf,
 
 static int
 amd_pstate_update(struct amd_cpudata *cpudata, u32 min_perf,
-		  u32 des_perf, u32 max_perf, bool fast_switch)
+		  u32 des_perf, u32 max_perf, bool fast_switch,
+		  enum switch_type type)
 {
 	u64 prev = READ_ONCE(cpudata->cppc_req_cached);
 	u64 value = prev;
@@ -209,6 +218,8 @@ amd_pstate_update(struct amd_cpudata *cpudata, u32 min_perf,
 	value &= ~REQ_MAX_PERF(~0L);
 	value |= REQ_MAX_PERF(max_perf);
 
+	trace_amd_pstate_perf(min_perf, des_perf, max_perf,
+			      cpudata->cpu, prev, value, type);
 	if (value == prev)
 		return 0;
 
@@ -250,7 +261,7 @@ static int amd_pstate_target(struct cpufreq_policy *policy,
 
 	cpufreq_freq_transition_begin(policy, &freqs);
 	ret = amd_pstate_update(cpudata, amd_min_perf, amd_des_perf,
-				amd_max_perf, false);
+				amd_max_perf, false, AMD_TARGET);
 	cpufreq_freq_transition_end(policy, &freqs, false);
 
 	return ret;
@@ -288,7 +299,7 @@ static void amd_pstate_adjust_perf(unsigned int cpu,
 			       amd_min_perf, amd_max_perf);
 
 	amd_pstate_update(cpudata, amd_min_perf, amd_des_perf,
-			  amd_max_perf, true);
+			  amd_max_perf, true, AMD_ADJUST_PERF);
 }
 
 static unsigned int amd_pstate_fast_switch(struct cpufreq_policy *policy,
@@ -308,7 +319,7 @@ static unsigned int amd_pstate_fast_switch(struct cpufreq_policy *policy,
 				    cpudata->max_freq);
 
 	amd_pstate_update(cpudata, amd_min_perf, amd_des_perf,
-			  amd_max_perf, true);
+			  amd_max_perf, true, AMD_FAST_SWITCH);
 
 	nominal_perf = READ_ONCE(cpudata->nominal_perf);
 	ratio = div_u64(amd_des_perf << SCHED_CAPACITY_SHIFT, nominal_perf);
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-18.8 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,USER_AGENT_GIT
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 4301AC433F5
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:48 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 30006611C5
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:48 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1352071AbhIHPCy (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 11:02:54 -0400
Received: from mail-mw2nam10on2042.outbound.protection.outlook.com ([40.107.94.42]:4395
        "EHLO NAM10-MW2-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1351854AbhIHPCb (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 11:02:31 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=fupqjP/mw28qanmL+4GBkOLMk6ynaRiZhzC6nWpQrUyNT3N4zVQI5XALeDee040VEZ0eCUm7/MTYAG2xXbbO9mFo47whSYFhN+Twr4BP/RnYT21CuweAsSpcS7xg+Zte7lznCidGnnRgXMsGl+VF4GonPr0IANDvmQ0xctTvmYR5BkYtriuhpalLggz/4EZwHhLZ86Lvqi1O0wfihlWZTR+1oeP5jRa7HK9Kc9tfeh/ffDyilRdK5AbQjtBqQhPer40n7naEED6y8EMkOA4FcTXpwux6Ns1MIr9ozBMC0VqIbBcK0DY1y0YFt8lP+1KL849pdeUQU0y8Sv/ie08urg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=0Sts+f19HSD1eDbCMpFPpFVWoJBFJa0nO5rBOh8C4B8=;
 b=HvdbMgRET60LJQMtcsdDyk7r5AqhTzBJT/W1aCHnkffoyDfDtTz06p5779pt/xZ5ZyB2N9RCgANEFqkmQ5xLGCX5nCPvG39SwCCqJm2aHJpIZew2KyWtAXJzvPUILKFtvDa5x3/Td0auZqnlvtU+M1y/lKY9PCj9NhJHz9NioNMXFZwD2M7LpD+HEGF3HHF1IHPlffpHX6ZL1VZhKNNK/LB2sDno35P13IQC+dmG4NMWwNKLHHjz/hxhry1R3zHo2rY6QM7ToieLGDhYR5GOVuaLH1amHZKuAuwTuqSphZCUwtgfr8UXM2AFxbpokDKTyvPCxu0W06PGZ9wyZNxKLw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=0Sts+f19HSD1eDbCMpFPpFVWoJBFJa0nO5rBOh8C4B8=;
 b=mBgH2WbPkSzeqQSeX1MxhX9pL2YOZ0VqPxsZofSIOkZ2stbYFO3RLMd9gs/dnEjqtvsP6CK2qPy/+3nzcl5GDz79c5Zu/wYTHg1VIqP4coA6ykqTcwOAiXewTYzR4J45NUmfAhF70BGYhVj+AakBSm7OnQMT36mmUPSEq93pEg8=
Received: from MWHPR11CA0039.namprd11.prod.outlook.com (2603:10b6:300:115::25)
 by DM6PR12MB3547.namprd12.prod.outlook.com (2603:10b6:5:18a::20) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4478.22; Wed, 8 Sep
 2021 15:01:21 +0000
Received: from CO1NAM11FT036.eop-nam11.prod.protection.outlook.com
 (2603:10b6:300:115:cafe::bf) by MWHPR11CA0039.outlook.office365.com
 (2603:10b6:300:115::25) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Wed, 8 Sep 2021 15:01:21 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CO1NAM11FT036.mail.protection.outlook.com (10.13.174.124) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 15:01:21 +0000
Received: from hr-amd.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Wed, 8 Sep 2021
 10:01:16 -0500
From:   Huang Rui <ray.huang@amd.com>
To:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        <linux-pm@vger.kernel.org>
CC:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        <linux-kernel@vger.kernel.org>, <x86@kernel.org>,
        Huang Rui <ray.huang@amd.com>
Subject: [PATCH 08/19] cpufreq: amd: add boost mode support for amd-pstate
Date:   Wed, 8 Sep 2021 22:59:50 +0800
Message-ID: <20210908150001.3702552-9-ray.huang@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210908150001.3702552-1-ray.huang@amd.com>
References: <20210908150001.3702552-1-ray.huang@amd.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Type: text/plain
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 9d094a05-79d9-420b-4e7d-08d972d984df
X-MS-TrafficTypeDiagnostic: DM6PR12MB3547:
X-Microsoft-Antispam-PRVS: <DM6PR12MB3547FD1C2073D7CA5FF4A938ECD49@DM6PR12MB3547.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:5516;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: IRQ9bnCY6wBiOTmbgM7szG5rlcVWFcNaWz23cwQ4QfELfeRQQTuP1ypZVoyFdCgsBTY0dNdrNeuQiYVyCHLCPhmoQi4/6kREeDTwECto6rQQLydg8phXywVOg5hE1etab2dsH0fkwpMyAKlDtz3/53NiAABK1mDE1WbztJYvXIxx1FysZF9CgzfNT37EEZsvaxjlna1YYy5r9CDmQuWnLurcnkBBZ15R4kVe1GDLvFHbacvGildUqg/Zk3uh1qBQbzYG4DyIrLTbYH73zfo5Z11n+ZYGroSC0gF4MjUBjgxAnOWzNpHuBmp8aTXY2RF4rV3EtMlbonBlPiBb6T5phgvHRXNcdDYNuvALn0Sc866dNWH6F8gXyl3GopabYLH3+huXiSfFUik9KwtdA89nxbYHNtWRBI8i/EZG8Fp63Fdk6Uor/0FzVnIcrCwOtj6qJYNHgsmULMJ5m+WVnfQextRau/XbB1f9KGG1Bp/AGvH6nUJskTPfa8nReq6ZDMYK9AoQm2uzWFcoQYj6cKwZwBbmSqkUGdUnO1sbvaKoJG5L+fy9XluXxYgD6Fi3xlM3fL2wyWKRwuB1X8yHuHxUxsEJcv+80Y+DLpm3zb7AxoNTK4Zsc5+KIekp6u3rtn6Rem/E4Cb82Yhu745fw8I6eJw8g0Za46ys+ZkKeiMHVOWVpoDbTLlc/YExvPDe+11Pxp7ng5VvhP8f5ZE2m1NSuC60KofGq//tUQenNznsu5w=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(39860400002)(396003)(136003)(376002)(346002)(36840700001)(46966006)(316002)(47076005)(54906003)(4326008)(110136005)(5660300002)(83380400001)(6666004)(26005)(7696005)(478600001)(70206006)(70586007)(82310400003)(16526019)(186003)(82740400003)(86362001)(356005)(81166007)(336012)(426003)(2616005)(1076003)(2906002)(36756003)(8676002)(8936002)(36860700001)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 15:01:21.0673
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 9d094a05-79d9-420b-4e7d-08d972d984df
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: CO1NAM11FT036.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB3547
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

If the sbios supports the boost mode of amd-pstate, let's switch to
boost enabled by default.

Signed-off-by: Huang Rui <ray.huang@amd.com>
---
 drivers/cpufreq/amd-pstate.c | 50 ++++++++++++++++++++++++++++++++++++
 1 file changed, 50 insertions(+)

diff --git a/drivers/cpufreq/amd-pstate.c b/drivers/cpufreq/amd-pstate.c
index ea965a122431..67a9a117f524 100644
--- a/drivers/cpufreq/amd-pstate.c
+++ b/drivers/cpufreq/amd-pstate.c
@@ -75,6 +75,8 @@ struct amd_cpudata {
 	u32	min_freq;
 	u32	nominal_freq;
 	u32	lowest_nonlinear_freq;
+
+	bool	boost_supported;
 };
 
 struct amd_pstate_perf_funcs {
@@ -229,6 +231,19 @@ amd_pstate_update(struct amd_cpudata *cpudata, u32 min_perf,
 				      max_perf, fast_switch);
 }
 
+static bool amd_pstate_boost_supported(struct amd_cpudata *cpudata)
+{
+	u32 highest_perf, nominal_perf;
+
+	highest_perf = READ_ONCE(cpudata->highest_perf);
+	nominal_perf = READ_ONCE(cpudata->nominal_perf);
+
+	if (highest_perf > nominal_perf)
+		return true;
+
+	return false;
+}
+
 static int amd_pstate_verify(struct cpufreq_policy_data *policy)
 {
 	cpufreq_verify_within_cpu_limits(policy);
@@ -402,6 +417,37 @@ static int amd_get_lowest_nonlinear_freq(struct amd_cpudata *cpudata)
 	return lowest_nonlinear_freq * 1000;
 }
 
+static int amd_pstate_set_boost(struct cpufreq_policy *policy, int state)
+{
+	struct amd_cpudata *cpudata = policy->driver_data;
+	int ret;
+
+	if (!cpudata->boost_supported) {
+		pr_err("Boost mode is not supported by this processor or SBIOS\n");
+		return -EINVAL;
+	}
+
+	if (state)
+		policy->cpuinfo.max_freq = cpudata->max_freq;
+	else
+		policy->cpuinfo.max_freq = cpudata->nominal_freq;
+
+	policy->max = policy->cpuinfo.max_freq;
+
+	ret = freq_qos_update_request(&cpudata->req[1],
+				      policy->cpuinfo.max_freq);
+	if (ret < 0)
+		return ret;
+
+	return 0;
+}
+
+static void amd_pstate_boost_init(struct amd_cpudata *cpudata)
+{
+	cpudata->boost_supported = true;
+	amd_pstate_driver.boost_enabled = true;
+}
+
 static int amd_pstate_init_freqs_in_cpudata(struct amd_cpudata *cpudata,
 					    u32 max_freq, u32 min_freq,
 					    u32 nominal_freq,
@@ -504,6 +550,9 @@ static int amd_pstate_cpu_init(struct cpufreq_policy *policy)
 
 	policy->driver_data = cpudata;
 
+	if (amd_pstate_boost_supported(cpudata))
+		amd_pstate_boost_init(cpudata);
+
 	return 0;
 
 free_cpudata3:
@@ -535,6 +584,7 @@ static struct cpufreq_driver amd_pstate_driver = {
 	.fast_switch    = amd_pstate_fast_switch,
 	.init		= amd_pstate_cpu_init,
 	.exit		= amd_pstate_cpu_exit,
+	.set_boost	= amd_pstate_set_boost,
 	.name		= "amd-pstate",
 };
 
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-18.8 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,USER_AGENT_GIT
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 75DEBC433EF
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:50 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 5DF5A611C5
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:50 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1352092AbhIHPC4 (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 11:02:56 -0400
Received: from mail-dm6nam08on2078.outbound.protection.outlook.com ([40.107.102.78]:62240
        "EHLO NAM04-DM6-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1352046AbhIHPCs (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 11:02:48 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=XrJO9kE+JlkZdrZhg+wvQJ5pPY6UdlGCWpjtKh+0Vl5DUtg9DVnIEo9HUp4Y5pYA3UHt2iKWK61CT/mv2iFOKj5OpZqur3F9VPlly2HbT8DrsvfrPzm4mzraq6e9TCt9zaAEHLxc0tTv3d+UjRCGr5Ct1+Qw1Wxl+P9z/Sw+pqE/fJXkHalLLm7M/HzHcD5XrWKUkAKAb9m5+TTVK/R9CS3M5i4of/CvGeL4SmrM2eXqvzTuu2QmFokmAkMjUO9M7P1ephU7tjaYZGrDIaOPJdFhuveScqiUW7YC/Ysst0+gNTxd5V47TZKZrAPvVuLzv4LG0dup8uwz6IYRfoAWAg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=pv4oq08kf3tAlLw7OGigFu4eeqHnwr1cI0XJnv+bU+M=;
 b=Sd1RaphKf3cr43AHoHE3WIGcSsfx9nV+HL5Rf33xhmkZQReqbZhD07s8E+ja6tX2eQUdAbAAGR9kI1lz+NUCSG3Dqejo83uRAbsWgBvIB0hKcPtgd3q3TpBEMOZ06CY2fmr710JkSOsXMERGK95aLAyhie3JloMCe3H1A0QsnkvK4YMSAxCaBPB6LuwdtDU9m5SEq4Fxh5VEqtooEENqAHS8F6hZGRag5O+Rfn67r27/ye462jT8CgUUwfdhWsM8EI/D+2BAGeNvZk7wALhsJzIHRy9jWr7wV+fIR2zUoxMXFdukLnIZrBg6Y4pXRhem3bfpPALIT0QVPAsfRx2dXQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=pv4oq08kf3tAlLw7OGigFu4eeqHnwr1cI0XJnv+bU+M=;
 b=tYnN0pCGw7Bh6kP6OajJeSBOldt0gILAYq/L1y2E5hlBWQQGBU9OhBlwfa4V10nH7X1Khl8qxtvbK0PNzlwsM1CfWOuvM2KW7Vbli19XZLdMH6qyruqtPhGg0EopI6IDvEus2HK4DqfFoxOmr2DetE0YMRaK3dn48vcihbdBfVs=
Received: from MWHPR10CA0018.namprd10.prod.outlook.com (2603:10b6:301::28) by
 SJ0PR12MB5405.namprd12.prod.outlook.com (2603:10b6:a03:3af::11) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14; Wed, 8 Sep
 2021 15:01:33 +0000
Received: from CO1NAM11FT057.eop-nam11.prod.protection.outlook.com
 (2603:10b6:301:0:cafe::cb) by MWHPR10CA0018.outlook.office365.com
 (2603:10b6:301::28) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.16 via Frontend
 Transport; Wed, 8 Sep 2021 15:01:33 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CO1NAM11FT057.mail.protection.outlook.com (10.13.174.205) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 15:01:32 +0000
Received: from hr-amd.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Wed, 8 Sep 2021
 10:01:23 -0500
From:   Huang Rui <ray.huang@amd.com>
To:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        <linux-pm@vger.kernel.org>
CC:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        <linux-kernel@vger.kernel.org>, <x86@kernel.org>,
        Huang Rui <ray.huang@amd.com>
Subject: [PATCH 10/19] cpufreq: amd: add amd-pstate frequencies attributes
Date:   Wed, 8 Sep 2021 22:59:52 +0800
Message-ID: <20210908150001.3702552-11-ray.huang@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210908150001.3702552-1-ray.huang@amd.com>
References: <20210908150001.3702552-1-ray.huang@amd.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Type: text/plain
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: f9dabfd4-399a-4e9f-ff88-08d972d98bf2
X-MS-TrafficTypeDiagnostic: SJ0PR12MB5405:
X-Microsoft-Antispam-PRVS: <SJ0PR12MB5405EE849CBE5534082BEB27ECD49@SJ0PR12MB5405.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:497;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 8S+HLIRajyTSN1U6YMJa7dk9yJaq1l4aCdCXoRULHxnM+wNQPs3H1iG0bUz1U0o6UoRzLOpMoxab4FVjOGkxaEoDW7kVbElalLhnnges7vljzjsWIBhETrejgxB8TBCCIdIGBH/+QXURHtpVz1bPvh9GU9l/J3tJ5AJOEMdfNvScMDO9oe/V67h2Z/NJA99ifOODU311FblQeq5dqOrb5XSEwPRBvW/9KLqbmf0HDUlamMeBFz18+IPEttgD2IlhjMofe55iJUyK/fr9x5IZVPm+DHO7AQ1GJokulYN6cQ0R4OhjExFOVwQ151jrYeqnBfgQ5jVGmJGk2uef3HN055uIi+RkfsY/++DSQdNatIh/P/WZQEoCck5p+85/edm8iGWVHISXbXlfm5eDHUVt9uJXRlq6A+jZrBeSpFZRb0C9Ol/CH1TTmy7CppS6iTccqFyTq2/c04SPeMrO2X7BD+NqQF4BYzNvYDKF7JXuuujyBoEUerurXsKM53tLicDBphtUH4wj/GjI4bQNCE/j4li2RakUbW/M0FcrMdmUl5RAKlS1gNivR7J0zBrJOwBquB63RgTC5JI9dmpQxxaNvingrdqeJuBtxVIel5CPpadnQTitDjcNzaBWM0XTvsR2PxJ/gFDrZueozi8BCvrj0qMhSAihMEbOspkH6YFTNuunqs6BsO1Pl5BsslyXxW5nz1pwqtFMXWVlMisz28PIHzvS6CI/GWezPYjGrniIEsE=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(136003)(396003)(376002)(346002)(39860400002)(46966006)(36840700001)(26005)(36860700001)(47076005)(426003)(2616005)(1076003)(4326008)(82740400003)(70586007)(82310400003)(5660300002)(86362001)(186003)(83380400001)(336012)(81166007)(70206006)(478600001)(8936002)(6666004)(7696005)(8676002)(2906002)(110136005)(356005)(54906003)(36756003)(316002)(16526019)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 15:01:32.9524
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: f9dabfd4-399a-4e9f-ff88-08d972d98bf2
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: CO1NAM11FT057.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SJ0PR12MB5405
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Introduce sysfs attributes to get the different level processor
frequencies.

Signed-off-by: Huang Rui <ray.huang@amd.com>
---
 drivers/cpufreq/amd-pstate.c | 80 +++++++++++++++++++++++++++++++++++-
 1 file changed, 79 insertions(+), 1 deletion(-)

diff --git a/drivers/cpufreq/amd-pstate.c b/drivers/cpufreq/amd-pstate.c
index 48dedd5af101..3c727a22cb69 100644
--- a/drivers/cpufreq/amd-pstate.c
+++ b/drivers/cpufreq/amd-pstate.c
@@ -577,16 +577,94 @@ static int amd_pstate_cpu_exit(struct cpufreq_policy *policy)
 	return 0;
 }
 
-static ssize_t show_is_amd_pstate_enabled(struct cpufreq_policy *policy,
+/* Sysfs attributes */
+
+static ssize_t show_amd_pstate_max_freq(struct cpufreq_policy *policy,
 					char *buf)
+{
+	int ret = 0, max_freq;
+	struct amd_cpudata *cpudata;
+
+	cpudata = policy->driver_data;
+
+	max_freq = amd_get_max_freq(cpudata);
+	if (max_freq < 0)
+		return max_freq;
+
+	ret += sprintf(&buf[ret], "%u\n", max_freq);
+
+	return ret;
+}
+
+static ssize_t show_amd_pstate_nominal_freq(struct cpufreq_policy *policy,
+					    char *buf)
+{
+	int ret = 0, nominal_freq;
+	struct amd_cpudata *cpudata;
+
+	cpudata = policy->driver_data;
+
+	nominal_freq = amd_get_nominal_freq(cpudata);
+	if (nominal_freq < 0)
+		return nominal_freq;
+
+	ret += sprintf(&buf[ret], "%u\n", nominal_freq);
+
+	return ret;
+}
+
+static ssize_t
+show_amd_pstate_lowest_nonlinear_freq(struct cpufreq_policy *policy, char *buf)
+{
+	int ret = 0, freq;
+	struct amd_cpudata *cpudata;
+
+	cpudata = policy->driver_data;
+
+	freq = amd_get_lowest_nonlinear_freq(cpudata);
+	if (freq < 0)
+		return freq;
+
+	ret += sprintf(&buf[ret], "%u\n", freq);
+
+	return ret;
+}
+
+static ssize_t show_amd_pstate_min_freq(struct cpufreq_policy *policy, char *buf)
+{
+	int ret = 0;
+	int freq;
+	struct amd_cpudata *cpudata;
+
+	cpudata = policy->driver_data;
+
+	freq = amd_get_min_freq(cpudata);
+	if (freq < 0)
+		return freq;
+
+	ret += sprintf(&buf[ret], "%u\n", freq);
+
+	return ret;
+}
+
+static ssize_t show_is_amd_pstate_enabled(struct cpufreq_policy *policy,
+					  char *buf)
 {
 	return sprintf(&buf[0], "%d\n", acpi_cpc_valid() ?  1 : 0);
 }
 
 cpufreq_freq_attr_ro(is_amd_pstate_enabled);
+cpufreq_freq_attr_ro(amd_pstate_max_freq);
+cpufreq_freq_attr_ro(amd_pstate_nominal_freq);
+cpufreq_freq_attr_ro(amd_pstate_lowest_nonlinear_freq);
+cpufreq_freq_attr_ro(amd_pstate_min_freq);
 
 static struct freq_attr *amd_pstate_attr[] = {
 	&is_amd_pstate_enabled,
+	&amd_pstate_max_freq,
+	&amd_pstate_nominal_freq,
+	&amd_pstate_lowest_nonlinear_freq,
+	&amd_pstate_min_freq,
 	NULL,
 };
 
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-15.9 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	UNWANTED_LANGUAGE_BODY,USER_AGENT_GIT autolearn=unavailable
	autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id B35B8C433FE
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:51 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id A173D61206
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:51 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1352105AbhIHPC6 (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 11:02:58 -0400
Received: from mail-mw2nam12on2076.outbound.protection.outlook.com ([40.107.244.76]:64824
        "EHLO NAM12-MW2-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1352051AbhIHPCt (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 11:02:49 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=XqoxlOOT2snvMVXTBxGpuMBRzTkMjduiXjZhsw950FhK8RtT8MVoQUMq8eCO6JT22lCfmkMOuKGK4dCXMWDefUeZq36sS94XnnwLccmv+KrXlQdU+TEF0HiiWikNH6pb8UK75774+bhBoIbiXb09yqI3/KTkuLhxtupHuXCPG8rCJ3fhr0L8RZZRmlbXlFrAP6HPaLBe+Z3K74xVbPGBp39vx7zahNvP0Eq3HOR+jpF2l92hUATNDPHTx+mNXkGl5cWoua6oO9GKstkFSDNsSlprFG/ZmEr0QmeeWA/Gt/dgmeuvIYNBwI36Qpn65a8kbdMiEFlnd0B5QueyJJ+yug==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=MNtlu/gAPeM+OZYCS5Pth5+YYeRlT2bwsxIlrI6SDBY=;
 b=BrVMQVwg0QYUxtezL/NeJ7wvgE48kQQAWzk3kIXPuLHCQMXJLIH/2e3OUZQptpWgIyBQy/QVDT5HvTMIx5DbURGasmRqm/vIfPCnwcTx4iL7CH9+rgXMYNweYssULjKVLAVHnb3u7EdadyYLDxVUBTQpZwmugnyjU0O5w0W9ZxJUtSJPILCC30BWjaKRUnBVhqyFBfpsUa384O8ObZJR6VZOZzFYL2GL4jxcqXQP3VniNzyH69jQt+09DKGpDmwghzmfYKM2BdMzB5wSG9237tOV2KRZOG0UbTzab1rY1gsOMQoqmsLSJDpdYIiUNdLCACx1c7SUSmF+4AUo6jcVcw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=MNtlu/gAPeM+OZYCS5Pth5+YYeRlT2bwsxIlrI6SDBY=;
 b=xIsY91GvP59IT5mj1djAgalhw4VpX79J/g0X1I9xCdrOAxOgOBbnUQD6L1wLDAV3kS0zeZfFlG41TVcBnWxI9zbz7v/9ra+19cP3NjAa4NoQn/2TkxiFIuZCLIWgohIhq1kBaT5iEVHN7CPWPQrAhjf/e5apCsq3uFCzmH1oNnY=
Received: from MWHPR10CA0015.namprd10.prod.outlook.com (2603:10b6:301::25) by
 DM6PR12MB4268.namprd12.prod.outlook.com (2603:10b6:5:223::15) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.20.4478.20; Wed, 8 Sep 2021 15:01:37 +0000
Received: from CO1NAM11FT057.eop-nam11.prod.protection.outlook.com
 (2603:10b6:301:0:cafe::79) by MWHPR10CA0015.outlook.office365.com
 (2603:10b6:301::25) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Wed, 8 Sep 2021 15:01:37 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CO1NAM11FT057.mail.protection.outlook.com (10.13.174.205) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 15:01:37 +0000
Received: from hr-amd.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Wed, 8 Sep 2021
 10:01:27 -0500
From:   Huang Rui <ray.huang@amd.com>
To:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        <linux-pm@vger.kernel.org>
CC:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        <linux-kernel@vger.kernel.org>, <x86@kernel.org>,
        Huang Rui <ray.huang@amd.com>
Subject: [PATCH 11/19] cpufreq: amd: add amd-pstate performance attributes
Date:   Wed, 8 Sep 2021 22:59:53 +0800
Message-ID: <20210908150001.3702552-12-ray.huang@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210908150001.3702552-1-ray.huang@amd.com>
References: <20210908150001.3702552-1-ray.huang@amd.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Type: text/plain
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 14e447a9-6261-4e6d-3a7f-08d972d98e6f
X-MS-TrafficTypeDiagnostic: DM6PR12MB4268:
X-Microsoft-Antispam-PRVS: <DM6PR12MB4268AF2EF4F2A4D9392C9B3AECD49@DM6PR12MB4268.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:411;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: UIRfA/fu+SltCDeNkIH6T1jwc7NSGWKqhjGsD6qxOCl8+4TR/K3Gp3/ryYLl7NIct2MkA2LKoRtA3ILWxZA41scqzMfp6TsMHpfEyK8BuBBx8loU8N9z2ih8YgVsLv7DZ/7+G8iadL5faBz4F2kn5gGvcmm4YsjavXQt65V9fR+68dap76eW1X3MotXybyFgLSG7+805NRnw2HKNIEm5NZ3A4XTjvYIT9Hy2zvmERFVsaUN+Wm3lpuF3z0JKcqezR8G/P9Pl/qrfMj9KSbIMP9Kc8r94UV1KCthG7zIWx6+WHCd9S0tmUlkuZ7vfqlxEok9qHTLDx8pG59X8Vc97DvA3WC+IZH+Nknclh8P7o+cHmNNA+L2CcTNSjXzKyCKukNOMREeCa2xjjVzMWLX6N/lO8PRdmF+hbyQx1zUqTMb/XyUkp0XxSgR2TR/i61kYfkH3k01zaeHOqnew8i/Rn9sugpZbd6u+mTXxgxVu+bik92SZANf6zVRGK00uPDV6NwoZ36PF66DL/WAob7UaKtfR+GQsA84fJneoohhAgZs6bctfC4RQ/0yOBmMmsNujzliZJxn+Aznm1vFpqFsNokWyogOvg9hLqcARrhK7O6TnoLVj+wEUrL407fxGcT2HShCIIDS8RE6w5oII9t1c154EEZ5wBXzLKFROV2SGl3aq56ilTcwSDX4Cl59IveqeR3fOdMl/PhwCw1ayKqxHxfHF9D8haD0SJWZSp3uRpBY=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(346002)(136003)(396003)(39860400002)(376002)(46966006)(36840700001)(83380400001)(36756003)(81166007)(356005)(6666004)(426003)(47076005)(8936002)(4326008)(1076003)(5660300002)(82740400003)(36860700001)(2906002)(336012)(70586007)(316002)(70206006)(54906003)(7696005)(110136005)(26005)(478600001)(2616005)(186003)(16526019)(86362001)(82310400003)(8676002)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 15:01:37.1220
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 14e447a9-6261-4e6d-3a7f-08d972d98e6f
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: CO1NAM11FT057.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB4268
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Introduce sysfs attributes to get the different level amd-pstate
performances.

Signed-off-by: Huang Rui <ray.huang@amd.com>
---
 drivers/cpufreq/amd-pstate.c | 66 ++++++++++++++++++++++++++++++++++++
 1 file changed, 66 insertions(+)

diff --git a/drivers/cpufreq/amd-pstate.c b/drivers/cpufreq/amd-pstate.c
index 3c727a22cb69..9c60388d45ed 100644
--- a/drivers/cpufreq/amd-pstate.c
+++ b/drivers/cpufreq/amd-pstate.c
@@ -647,6 +647,62 @@ static ssize_t show_amd_pstate_min_freq(struct cpufreq_policy *policy, char *buf
 	return ret;
 }
 
+static ssize_t
+show_amd_pstate_highest_perf(struct cpufreq_policy *policy, char *buf)
+{
+	int ret = 0;
+	u32 perf;
+	struct amd_cpudata *cpudata = policy->driver_data;
+
+	perf = READ_ONCE(cpudata->highest_perf);
+
+	ret += sprintf(&buf[ret], "%u\n", perf);
+
+	return ret;
+}
+
+static ssize_t
+show_amd_pstate_nominal_perf(struct cpufreq_policy *policy, char *buf)
+{
+	int ret = 0;
+	u32 perf;
+	struct amd_cpudata *cpudata = policy->driver_data;
+
+	perf = READ_ONCE(cpudata->nominal_perf);
+
+	ret += sprintf(&buf[ret], "%u\n", perf);
+
+	return ret;
+}
+
+static ssize_t
+show_amd_pstate_lowest_nonlinear_perf(struct cpufreq_policy *policy, char *buf)
+{
+	int ret = 0;
+	u32 perf;
+	struct amd_cpudata *cpudata = policy->driver_data;
+
+	perf = READ_ONCE(cpudata->lowest_nonlinear_perf);
+
+	ret += sprintf(&buf[ret], "%u\n", perf);
+
+	return ret;
+}
+
+static ssize_t
+show_amd_pstate_lowest_perf(struct cpufreq_policy *policy, char *buf)
+{
+	int ret = 0;
+	u32 perf;
+	struct amd_cpudata *cpudata = policy->driver_data;
+
+	perf = READ_ONCE(cpudata->lowest_perf);
+
+	ret += sprintf(&buf[ret], "%u\n", perf);
+
+	return ret;
+}
+
 static ssize_t show_is_amd_pstate_enabled(struct cpufreq_policy *policy,
 					  char *buf)
 {
@@ -654,17 +710,27 @@ static ssize_t show_is_amd_pstate_enabled(struct cpufreq_policy *policy,
 }
 
 cpufreq_freq_attr_ro(is_amd_pstate_enabled);
+
 cpufreq_freq_attr_ro(amd_pstate_max_freq);
 cpufreq_freq_attr_ro(amd_pstate_nominal_freq);
 cpufreq_freq_attr_ro(amd_pstate_lowest_nonlinear_freq);
 cpufreq_freq_attr_ro(amd_pstate_min_freq);
 
+cpufreq_freq_attr_ro(amd_pstate_highest_perf);
+cpufreq_freq_attr_ro(amd_pstate_nominal_perf);
+cpufreq_freq_attr_ro(amd_pstate_lowest_nonlinear_perf);
+cpufreq_freq_attr_ro(amd_pstate_lowest_perf);
+
 static struct freq_attr *amd_pstate_attr[] = {
 	&is_amd_pstate_enabled,
 	&amd_pstate_max_freq,
 	&amd_pstate_nominal_freq,
 	&amd_pstate_lowest_nonlinear_freq,
 	&amd_pstate_min_freq,
+	&amd_pstate_highest_perf,
+	&amd_pstate_nominal_perf,
+	&amd_pstate_lowest_nonlinear_perf,
+	&amd_pstate_lowest_perf,
 	NULL,
 };
 
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-18.8 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,USER_AGENT_GIT
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 2CA15C433EF
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:54 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 16C6061051
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:54 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1352113AbhIHPDA (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 11:03:00 -0400
Received: from mail-dm3nam07on2063.outbound.protection.outlook.com ([40.107.95.63]:44640
        "EHLO NAM02-DM3-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1351868AbhIHPCs (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 11:02:48 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=mx1XrqjOyNwe6MsYtOcCA3rFftSQxLjc7qzuWCMuGgDQVWrOiIYFpgnkhX6mjey+RuuGUcm0NsgbB1U2ihTxTyzC627SJMbJPsAR5DfhZYi6OwmbD9V7UliFtmzUh6tcwEPDng9yZru/qv9aY9tSjxzKIXAPHbZEvwx11Oz8YAqld9ovYlm8X39xKrWTNrUCr2Bwa6S0dW9GvXmWtO+2KcG4gNno9GWnkJ7i108J1nJvMQnTPcRt/4prorpFVEsNx7TG/XMiGMwE0ARnxl2GsQIqfnacLEP9pGsFr1DOtqX6w0VvpgLrIehJQPlhZLVxs9MpyD3bP0T6ejxwuJq8Ag==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=DxYicm56pYRNbYHA0LVxuxUV8cxXlRe46LHD4NMrx/E=;
 b=gSP3OMWFDKCUtUt1KXAFzDcLHDY+VpGUBQrOlb4py+DDro2RZhL/yUMSbmQsVRLAtDY4TLSmaU/4ldSJcaTRo/2lPGLZYOMm7FjmO8baezUBj+S6fu/+RjNQv3peAOmVax7AeWfqqXiP5BNCTUttXPgi5bHcknZdroDTe9bywW9DSDDeiTQmn1mxmFgPJZeGRumvbfnv8LIBWQtrZydhtU9MaN4/SQ9/25rFUWQ7jiD5a12IDYNAd0qqYBH2/FpLaxmfwswrZNXhggSYhKm1J5Hls1q6Kn0NgcYpduE9XLuW3gQvCMMnxkui60WxeDcBPYtJ78wTZe7srxTNlPKYCw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=DxYicm56pYRNbYHA0LVxuxUV8cxXlRe46LHD4NMrx/E=;
 b=YlGdDJTexOr9xpZ92kczdvDgJBGQPdO3qVFm/HVrqhHu7wh0jDPHgHEO/rdM/nSSspHJCbAc3XQ1dZHycNWEPPDapJXmDFKbUTW+czUHhNx9RLrdL7YvZHdO5BZUDf66hpeVw5bmLtIE2Y9fgEBdx7C1Oh0yzINBi7Bf1PeGod0=
Received: from MWHPR10CA0017.namprd10.prod.outlook.com (2603:10b6:301::27) by
 MWHPR12MB1487.namprd12.prod.outlook.com (2603:10b6:301:3::9) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.20.4500.14; Wed, 8 Sep 2021 15:01:32 +0000
Received: from CO1NAM11FT057.eop-nam11.prod.protection.outlook.com
 (2603:10b6:301:0:cafe::ff) by MWHPR10CA0017.outlook.office365.com
 (2603:10b6:301::27) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Wed, 8 Sep 2021 15:01:32 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CO1NAM11FT057.mail.protection.outlook.com (10.13.174.205) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 15:01:32 +0000
Received: from hr-amd.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Wed, 8 Sep 2021
 10:01:20 -0500
From:   Huang Rui <ray.huang@amd.com>
To:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        <linux-pm@vger.kernel.org>
CC:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        <linux-kernel@vger.kernel.org>, <x86@kernel.org>,
        Huang Rui <ray.huang@amd.com>
Subject: [PATCH 09/19] cpufreq: amd: add amd-pstate checking support check attribute
Date:   Wed, 8 Sep 2021 22:59:51 +0800
Message-ID: <20210908150001.3702552-10-ray.huang@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210908150001.3702552-1-ray.huang@amd.com>
References: <20210908150001.3702552-1-ray.huang@amd.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Type: text/plain
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: c2d8abba-6be8-4114-35ea-08d972d98b95
X-MS-TrafficTypeDiagnostic: MWHPR12MB1487:
X-Microsoft-Antispam-PRVS: <MWHPR12MB14871EF4BC004A35B4B69805ECD49@MWHPR12MB1487.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:541;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: KCcM4NisxY06vO3FwcUSs9IGFV5pLduZVASogN40cP9LLS9LqlIw3gXBOBCO8SVIrbzO1ZJCRFVLHpP9tjDssHRi2m2c9p1mN6X/vslnKSFutE/Qz38XukZwViVXLCZ8wB5GYlKWN/ZW6sC89GSYmSAYAxX0IWiNfM7/vAIaHo2KPOtCeXx9BPJU4B6cCe9A8lYJ0ogb3P1MRnB1Ow8ZtL9a+e02G02NZ0G3QnCI2vc1LAr+R2qxgzz36Dc3l6BZQhCztUb/mj5CqFDH30uSHgPkimnHR4WD2xH+1+7XtbdIao4w6Zx/3uG9aBfkXEAXPmwpf6fYlCUstjPwEFVu7vgz0soKN5gHWixd/LE+BSzVoZ34QERXZNEl+5y2yHiDhbjxjj4p8Pqc3sMfXNqIF26BfUW3GoI9oWc+2n9kwixHwMltFrWjjusWLlpW5xyhIJhG3gEw2UEYNd1YA0x63HaqF7ZYvgOITaZjPK+lMuneVnXaLjtOWtS1Z+nWEs/DLVwKU/qswzJBYgLB6d7hjC6NrBMs1Zwa94re7wmNURot8tNJ/Z0EUIjsP/9ZFSU+XlYQJTAGeuqNBq1HVVClhBLmsSogIDurICC8LEBwEdredxuSupmHzOKqIS7ptW0GAXyFeUtaeISyQ5zbriUaTzQiGSkNtp5jv97sbLzSmS6FuWK9oHp3tqczAH1Or4rbwiIZXWZzT/s5NB9KfFZ45BVhSO57lfuqBxWJeFl/YE4=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(346002)(136003)(376002)(39860400002)(396003)(36840700001)(46966006)(16526019)(186003)(70586007)(86362001)(5660300002)(478600001)(82310400003)(8676002)(70206006)(36756003)(82740400003)(110136005)(8936002)(316002)(356005)(336012)(7696005)(1076003)(81166007)(47076005)(2906002)(54906003)(6666004)(26005)(83380400001)(426003)(36860700001)(2616005)(4326008)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 15:01:32.3368
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: c2d8abba-6be8-4114-35ea-08d972d98b95
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: CO1NAM11FT057.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MWHPR12MB1487
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

The amd-pstate hardware support check will be needed by cpupower to know
whether amd-pstate is enabled and supported.

Signed-off-by: Huang Rui <ray.huang@amd.com>
---
 drivers/cpufreq/amd-pstate.c | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git a/drivers/cpufreq/amd-pstate.c b/drivers/cpufreq/amd-pstate.c
index 67a9a117f524..48dedd5af101 100644
--- a/drivers/cpufreq/amd-pstate.c
+++ b/drivers/cpufreq/amd-pstate.c
@@ -577,6 +577,19 @@ static int amd_pstate_cpu_exit(struct cpufreq_policy *policy)
 	return 0;
 }
 
+static ssize_t show_is_amd_pstate_enabled(struct cpufreq_policy *policy,
+					char *buf)
+{
+	return sprintf(&buf[0], "%d\n", acpi_cpc_valid() ?  1 : 0);
+}
+
+cpufreq_freq_attr_ro(is_amd_pstate_enabled);
+
+static struct freq_attr *amd_pstate_attr[] = {
+	&is_amd_pstate_enabled,
+	NULL,
+};
+
 static struct cpufreq_driver amd_pstate_driver = {
 	.flags		= CPUFREQ_CONST_LOOPS | CPUFREQ_NEED_UPDATE_LIMITS,
 	.verify		= amd_pstate_verify,
@@ -586,6 +599,7 @@ static struct cpufreq_driver amd_pstate_driver = {
 	.exit		= amd_pstate_cpu_exit,
 	.set_boost	= amd_pstate_set_boost,
 	.name		= "amd-pstate",
+	.attr		= amd_pstate_attr,
 };
 
 static int __init amd_pstate_init(void)
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-18.8 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,USER_AGENT_GIT
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id B4B05C433FE
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:56 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 9E179611C5
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:56 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1352120AbhIHPDD (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 11:03:03 -0400
Received: from mail-dm6nam12on2087.outbound.protection.outlook.com ([40.107.243.87]:23649
        "EHLO NAM12-DM6-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1351927AbhIHPCu (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 11:02:50 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=K4Q0fv58RfnDb87PDSBRl8hDR7bn+6a8lPkfa3C0Q/KWknxRPSNwFa3flGEChk2pig2qEdzwmaXyDFLRcdQu9x8M2Xn1lygExpwD6s3/CkP1r8BvZzAEIORhsmTvNVk9kPka9Gn7eliKdtII7vJIePV0r8btPlHY4C0lToAEmcsutkVPjVBenG8PHF/KgmTpJn5zpp3HZvKIhWoY6+nqi2elz5Im0I71LKA8sppYAgiwRRlkF0ApY9V4MIC7uuUbX7ruJCtuItLi7NYJyM2bKMxMXZTJaAUAZmkY3sr2de7UwtvquQ6v2eHpujr9vfIc270fHR6yZI4cKG/SB1XjZQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=ps07KAkkEcOIick636gTJ37A8LHbpf86ddMPvpS07Ec=;
 b=mM8r0L/klMJma5EeFOeY4Efg0lpHomFiT8lBxXscHgHBFqKBT/j5Nx+1bQd/Oit03UbOrMGzPvenQHdqt5vNFtPM4S52CtT6we3qwYE3d/lahlyCKmxobQ4X3cDP+rvc1uAvKefAkP15T5txq/a552mQwOtxRvmDkOEoL63cR1qpr8Y4Fz6LwOd0pqKjeXa4mem3RIZ0Usidq/u18267lHcELBNeLudcHM0MI2PJaFDZK+5slZKrk5mu5X09MxkmdUimcic0iUwT7aD8L1LyiFLDolOjwxL47r6CHrjWPiX5S6/rm15/WdZDmW0bNE5rFVJAPd8KsO2++WLGlLh6Vw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=ps07KAkkEcOIick636gTJ37A8LHbpf86ddMPvpS07Ec=;
 b=l5F/gbRrOY/Cuvk04VUMfHTE3GqAiZhAjYv460HPP56wSLlBh889rrwnslYugCamUYaKkuIL0FLNB11mSlTguxxZj4QEimLdW2iHu+SG4XqJidpN03rgDOOSdLCxaAui/fhN8RE579jV83j6UHRCi/Zsl2UNTSvWvVNiz2Mm+0g=
Received: from MWHPR10CA0004.namprd10.prod.outlook.com (2603:10b6:301::14) by
 BN6PR1201MB2464.namprd12.prod.outlook.com (2603:10b6:404:ae::22) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4478.25; Wed, 8 Sep
 2021 15:01:40 +0000
Received: from CO1NAM11FT057.eop-nam11.prod.protection.outlook.com
 (2603:10b6:301:0:cafe::1c) by MWHPR10CA0004.outlook.office365.com
 (2603:10b6:301::14) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Wed, 8 Sep 2021 15:01:39 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CO1NAM11FT057.mail.protection.outlook.com (10.13.174.205) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 15:01:39 +0000
Received: from hr-amd.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Wed, 8 Sep 2021
 10:01:31 -0500
From:   Huang Rui <ray.huang@amd.com>
To:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        <linux-pm@vger.kernel.org>
CC:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        <linux-kernel@vger.kernel.org>, <x86@kernel.org>,
        Huang Rui <ray.huang@amd.com>
Subject: [PATCH 12/19] cpupower: add AMD P-state capability flag
Date:   Wed, 8 Sep 2021 22:59:54 +0800
Message-ID: <20210908150001.3702552-13-ray.huang@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210908150001.3702552-1-ray.huang@amd.com>
References: <20210908150001.3702552-1-ray.huang@amd.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Type: text/plain
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 923acf10-1857-4dea-a615-08d972d98fea
X-MS-TrafficTypeDiagnostic: BN6PR1201MB2464:
X-Microsoft-Antispam-PRVS: <BN6PR1201MB2464656535EC8DC22A40A04DECD49@BN6PR1201MB2464.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:1265;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: pW3DuM9Xxis40mIBQn4MyR+e114fqIrIgAyJEJRAFXRyG7qOvd4B9bgj+WLEwFPMYgXtUVgDVso1XNfsBLa/G0bsHLiqs0UWP8m2qRBiPIcvfEN044mYYVJwWTcCJ7zneyHQO2vzqZ+9wwgP9cVCzKJ/AiaDuQB02PctQQkLFC/3tGiyyxPNqQuMxDoBgxfLFgfoo8oLyrfuQQ7zysiEZAtd62Y2RGDj7ypnvIyysJkZ7A2szK5aYKV6BegSALSY3s/HzazfvfeZOyxCYB3uFaOxHV0f7Zb7kIuyCAuLko1lmyS45GMVwSORmuNiWyFhCNGPqRPFe9bm/QSv/1mp/spK6i8NVK2HjIcMnLKuwQeA/vTngWO4bqJK2C0hxSwi1+Pdkf+dD7wBGAD6k1yK7r8G3ut//cDv2NwKotXo7VX4jmIoL/Och4fYxtw3A6PtsFKC5ZZ+3SXdKV0/cm6AVaA4fMImLcaF3QX/WbBSbR+WAzgPPgLIGGkbMKAcLVXbSVAE/TrmUpA10zZ4H4JpAvi68IbIIMF+TArZetB5y0gWvcdfNrFgspsckWqXnV6O6mGbhpblEVc8vP0vKvIT7JCsEhyhIkuZs/VZn0h29Qjy7cV70f80e4kCKV+IfYMr/ENimbu4zpEc4P3XCp8ITbEu3ylJml36s50mv9hvdJ6O0o1y4HBA6Vav1Q113QPl33t2sc/DRWMXbQHvWBXJOh/fIlYJYY9IWYdSqDblJTU=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(376002)(396003)(346002)(39860400002)(136003)(36840700001)(46966006)(4744005)(8676002)(110136005)(54906003)(2906002)(186003)(82740400003)(426003)(2616005)(316002)(5660300002)(70586007)(36860700001)(7696005)(336012)(86362001)(82310400003)(1076003)(8936002)(36756003)(478600001)(6666004)(26005)(356005)(81166007)(4326008)(70206006)(16526019)(47076005)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 15:01:39.6076
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 923acf10-1857-4dea-a615-08d972d98fea
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: CO1NAM11FT057.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: BN6PR1201MB2464
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Add AMD P-state capability flag in cpupower to indicate AMD new P-state
kernel module support on Ryzen processors.

Signed-off-by: Huang Rui <ray.huang@amd.com>
---
 tools/power/cpupower/utils/helpers/helpers.h | 1 +
 1 file changed, 1 insertion(+)

diff --git a/tools/power/cpupower/utils/helpers/helpers.h b/tools/power/cpupower/utils/helpers/helpers.h
index 33ffacee7fcb..b4813efdfb00 100644
--- a/tools/power/cpupower/utils/helpers/helpers.h
+++ b/tools/power/cpupower/utils/helpers/helpers.h
@@ -73,6 +73,7 @@ enum cpupower_cpu_vendor {X86_VENDOR_UNKNOWN = 0, X86_VENDOR_INTEL,
 #define CPUPOWER_CAP_AMD_HW_PSTATE	0x00000100
 #define CPUPOWER_CAP_AMD_PSTATEDEF	0x00000200
 #define CPUPOWER_CAP_AMD_CPB_MSR	0x00000400
+#define CPUPOWER_CAP_AMD_PSTATE		0x00000800
 
 #define CPUPOWER_AMD_CPBDIS		0x02000000
 
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-18.8 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,USER_AGENT_GIT
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id C94E9C433F5
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:58 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id B619F611C8
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:01:58 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1351854AbhIHPDF (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 11:03:05 -0400
Received: from mail-bn8nam11on2058.outbound.protection.outlook.com ([40.107.236.58]:57760
        "EHLO NAM11-BN8-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1351981AbhIHPCu (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 11:02:50 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=OIqY9vFJvbScoEtyQocYD2SN6iRqUeSPZoHn+GEzJmoof/lwydleSSc/oTb/6ByMI1gYYKegx5kZynL9V0Icq1d+xDaA/dTwex/3gKxPN9pTi2eZGwUbneb1gNLk3ePPA0C8UeS3qi/68y8z7HI9wmGIM/nYZ6kbTM2vqkbzTdtDRzZQNSF9XE7tr1u0VNY9t7I1D3Y3SR+EAL524j+4wXIWGfNoYeTc2DLHzwT2fQIsiMVSv5uBUJRYOWL12dJ9MK88EvlI9MkLgbdbOLO8VSsHxMO4ubk1qKXOuIpkF+a+XzTlEdRVz206ocnkar1tT7SHJuOOkrpkTPuzkBBIkg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=ccvgLGXMmqJ33bBs2A5cCQooNFOumTwff+lvc6oq7AU=;
 b=fFM39dwTAHUTq+0Y1AdwCNw8wQT5B+prUIJlYlm9mYe3B/PXWDS8REalcgke3LwmHv1tmxx6KyIkNEo06DdU0+/67RNpPavyw8O7kIf4b3yi22D0NAJCSnNIPglcbreV2ozlf9ECGb2FNtku/9Lzs2RnIvkIQCChRoXO9kID9JyumbJTm6pMaHtpzH1YLmLjUmxtNU0UYINfH3es0ewI37keAQy+J+rMaWgGB4btRavpx13j0FIzviprD+3BGDg66dTlD43d7N8e7F9zXCi9NNRVMi8PS4rTANfz2LY7zuoxvisr4I1U6G8oRaM40JngUSPoLYAIHDZiF5aeCZ75/w==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=ccvgLGXMmqJ33bBs2A5cCQooNFOumTwff+lvc6oq7AU=;
 b=4LHlLQKQMGkcH2KtT4PXHrelUFBS85OZUB/mpGU0Y803TS3nBiwHC24IMhgyTMKMVnpt+2nideR4Y03hvE4HlrV6NQZhH3wQGOpd+p6P1E+ZCODEcP+ZkH354V9yzp0Vp1GbVF77G1rcYt4jsh/ei/u/t9qX8Nk39cKmgPs4FOs=
Received: from MWHPR10CA0005.namprd10.prod.outlook.com (2603:10b6:301::15) by
 BL1PR12MB5157.namprd12.prod.outlook.com (2603:10b6:208:308::15) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4478.21; Wed, 8 Sep
 2021 15:01:41 +0000
Received: from CO1NAM11FT057.eop-nam11.prod.protection.outlook.com
 (2603:10b6:301:0:cafe::52) by MWHPR10CA0005.outlook.office365.com
 (2603:10b6:301::15) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Wed, 8 Sep 2021 15:01:40 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CO1NAM11FT057.mail.protection.outlook.com (10.13.174.205) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 15:01:40 +0000
Received: from hr-amd.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Wed, 8 Sep 2021
 10:01:35 -0500
From:   Huang Rui <ray.huang@amd.com>
To:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        <linux-pm@vger.kernel.org>
CC:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        <linux-kernel@vger.kernel.org>, <x86@kernel.org>,
        Huang Rui <ray.huang@amd.com>
Subject: [PATCH 13/19] cpupower: add the function to check amd-pstate enabled
Date:   Wed, 8 Sep 2021 22:59:55 +0800
Message-ID: <20210908150001.3702552-14-ray.huang@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210908150001.3702552-1-ray.huang@amd.com>
References: <20210908150001.3702552-1-ray.huang@amd.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Type: text/plain
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 9de47605-7254-4efa-5d1f-08d972d99059
X-MS-TrafficTypeDiagnostic: BL1PR12MB5157:
X-Microsoft-Antispam-PRVS: <BL1PR12MB51574F10342CDD9990E87F9CECD49@BL1PR12MB5157.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:626;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: zRa5wpkVX2HhFF3y7vmWOgs6gXdVJblk//GnuuuJ1pac1Q7fFysD4LN5J9rIZkGhrJLUYqViPjHeYykT61Q8iDih7v4Q+SKHP54uuwoKJKYeZPTKe/4EFkv3WvY4J8xlvGgESxKDrt+p/etiqRkrtq0bGBLHg3ZhuMUYrqGmIkD0b5eJo/voqmLxd4r3ivlrjipSJHgqb7GZb2xIRSv0yLTslMQYxVCXeHV1nH5mK/1kOAWhUNDNEU1N5XYXVCZ5GgchneeN8WxynLcaxdlLYs+WtWXaFKMym5DJH7KlVxP3SSW8v1+XJhF31Nc9DyDKQVIc/XdDMiP/hA1ahZR94tMx/A3m6Ra+bgKnWqB7DBaWNG6UVUsDNOuTdCOZNvl9/3Hc6WUeU+Y/D/j1wCzxghERV759XsCDESlixYQSBqYg96/vmwGCSkxGwWhgsgZqWFugQcZyS/Vbc3phHnvA15V13kylq/RCZIw1zkzTG31Zm4Kxlu2EtPOxpZ6HkPobPMh78gP9bkrON48gTUMuL1qlH0sBpCHwvZaw10+UaWozLxuzGr0eHQsptTVJU9BWGBuM051NA7B6NVpRc+BKfOzeFLhwB8dAhEGfjoAGZa8WCujnajAxcTJEa4+lWJspjphI8SFWOpKVruMgp+FdH0dvwOE6JB/2xL/SGYbQT9RMt/e1WRJrmczLYgg8wxxnlHgK3CeN4OztuCQDWYi5jPgNaiMVLL4V0RXn9Hyko5A=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(376002)(39860400002)(136003)(346002)(396003)(36840700001)(46966006)(82740400003)(356005)(81166007)(4326008)(186003)(426003)(1076003)(70586007)(36756003)(2616005)(36860700001)(86362001)(47076005)(6666004)(2906002)(5660300002)(26005)(478600001)(8676002)(8936002)(16526019)(7696005)(70206006)(110136005)(316002)(336012)(82310400003)(54906003)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 15:01:40.3352
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 9de47605-7254-4efa-5d1f-08d972d99059
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: CO1NAM11FT057.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: BL1PR12MB5157
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Introduce the cpupower_amd_pstate_enabled() to check whether the kernel
mode enables amd-pstate.

Signed-off-by: Huang Rui <ray.huang@amd.com>
---
 tools/power/cpupower/utils/helpers/helpers.h |  5 +++++
 tools/power/cpupower/utils/helpers/misc.c    | 20 ++++++++++++++++++++
 2 files changed, 25 insertions(+)

diff --git a/tools/power/cpupower/utils/helpers/helpers.h b/tools/power/cpupower/utils/helpers/helpers.h
index b4813efdfb00..eb43c14d1728 100644
--- a/tools/power/cpupower/utils/helpers/helpers.h
+++ b/tools/power/cpupower/utils/helpers/helpers.h
@@ -136,6 +136,11 @@ extern int decode_pstates(unsigned int cpu, int boost_states,
 
 extern int cpufreq_has_boost_support(unsigned int cpu, int *support,
 				     int *active, int * states);
+
+/* AMD PSTATE enabling **************************/
+
+extern unsigned long cpupower_amd_pstate_enabled(unsigned int cpu);
+
 /*
  * CPUID functions returning a single datum
  */
diff --git a/tools/power/cpupower/utils/helpers/misc.c b/tools/power/cpupower/utils/helpers/misc.c
index fc6e34511721..07d80775fb68 100644
--- a/tools/power/cpupower/utils/helpers/misc.c
+++ b/tools/power/cpupower/utils/helpers/misc.c
@@ -83,6 +83,26 @@ int cpupower_intel_set_perf_bias(unsigned int cpu, unsigned int val)
 	return 0;
 }
 
+unsigned long cpupower_amd_pstate_enabled(unsigned int cpu)
+{
+	char linebuf[MAX_LINE_LEN];
+	char path[SYSFS_PATH_MAX];
+	unsigned long val;
+	char *endp;
+
+	snprintf(path, sizeof(path),
+		 PATH_TO_CPU "cpu%u/cpufreq/is_amd_pstate_enabled", cpu);
+
+	if (cpupower_read_sysfs(path, linebuf, MAX_LINE_LEN) == 0)
+		return 0;
+
+	val = strtoul(linebuf, &endp, 0);
+	if (endp == linebuf || errno == ERANGE)
+		return 0;
+
+	return val;
+}
+
 #endif /* #if defined(__i386__) || defined(__x86_64__) */
 
 /* get_cpustate
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-18.8 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,USER_AGENT_GIT
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 04DAAC433EF
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:02:07 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id D8B91611F0
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:02:06 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1352138AbhIHPDI (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 11:03:08 -0400
Received: from mail-bn8nam12on2076.outbound.protection.outlook.com ([40.107.237.76]:28379
        "EHLO NAM12-BN8-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1352081AbhIHPCz (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 11:02:55 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=k6lcW1rf0UHbDX082z7nuLZp04kFqO6CfZC/4fWQotRhwJw7P2pT+Pnr5JXtpjkZPuaQ+3ERVdFxyZyQb1b2Przv4N/5qX+hvNRvtn9g/Qxh4957lAo3Q67iIrtM86P41rsfmqC/m0miBgxKNhyK+RO+2J7UF+Rnw0sUCsqbUx640dKgE2vvqvt0l/bkhPvoCrLaedSUJFc8s6V2kcHO7x/2gL8uk5jjTmUvhIGln6tjgCVF0UK8A+2ot3fkXt9akVarUBj1SmZmd06TBBrDICcmIKJHy30pp1z6ZDgBDMSWeZ4VM4zkjoCofxKj9uBxu24dSGvzTM6l2uDYsJ4AUA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=4P6buCND4/eYrdEV1Ipo5MG22unD1BHrlk9UEtasDvI=;
 b=TriToQaKVOHOfqc1CBmAeMp6OsaYWdnc7LRitsY2sDFicCVbE5sw9G5Q396T2IJpzEldJvxgv0r5lHanrw3tWTIRLcREVqsU6HIMS4dE/sRuCxxxfqGxlIpuWYe3uEb6EVOPWteh4m8Y//jNAMz1iD5vQVVAicTJqhxX/4jsaVQ73yHbHMv10bHsk3FdeBxYLixEGTZMOQEdl1FDNwxL5esY7zJxVeBBzpTruSAVOZstWtW3tCffQ0N6rTag/CCPiel/+aPZzdp+BABl87vaU4Ayfteqp0c10JEkqkXdm+99OnznTUDNE1lswTiQKJgxIo/GHEoXOpWhTHz00nowLw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=4P6buCND4/eYrdEV1Ipo5MG22unD1BHrlk9UEtasDvI=;
 b=zN8GgXMZXrCucImOV3Cia/7tB7WLUufEazuVgRLrxjfi9EXiLYzcb7VejrD/y6taimeQKy11nh+4lWxtb+llRajymwWfQePbWM/+8X1y2P1n0LKuhXJ2PYcXynWLUE8qu4u5v+pOHvS6aagcvP7bTu++SIj5zAjl9fOxdF81XyY=
Received: from MWHPR10CA0007.namprd10.prod.outlook.com (2603:10b6:301::17) by
 CY4PR1201MB0197.namprd12.prod.outlook.com (2603:10b6:910:23::11) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4478.22; Wed, 8 Sep
 2021 15:01:43 +0000
Received: from CO1NAM11FT057.eop-nam11.prod.protection.outlook.com
 (2603:10b6:301:0:cafe::9e) by MWHPR10CA0007.outlook.office365.com
 (2603:10b6:301::17) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Wed, 8 Sep 2021 15:01:43 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CO1NAM11FT057.mail.protection.outlook.com (10.13.174.205) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 15:01:43 +0000
Received: from hr-amd.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Wed, 8 Sep 2021
 10:01:38 -0500
From:   Huang Rui <ray.huang@amd.com>
To:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        <linux-pm@vger.kernel.org>
CC:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        <linux-kernel@vger.kernel.org>, <x86@kernel.org>,
        Huang Rui <ray.huang@amd.com>
Subject: [PATCH 14/19] cpupower: initial AMD P-state capability
Date:   Wed, 8 Sep 2021 22:59:56 +0800
Message-ID: <20210908150001.3702552-15-ray.huang@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210908150001.3702552-1-ray.huang@amd.com>
References: <20210908150001.3702552-1-ray.huang@amd.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Type: text/plain
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 85eaf7aa-657a-4c01-e62b-08d972d9925b
X-MS-TrafficTypeDiagnostic: CY4PR1201MB0197:
X-Microsoft-Antispam-PRVS: <CY4PR1201MB01978C34AAEC29A174E9B354ECD49@CY4PR1201MB0197.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:1284;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: h9WnuQe2mnfDfoKUmvUeWvlYN/fWc1wB0Akz33KZrPMo/Mu+ur2Y12gOmIbG2EIgnQ3A/hMING/KOvLp6okVUoSTYo9TbcMuPiQsSsKPBvAu/1cupKedlxAdpj+tw5JL5gUGtYFLtfNADez/ND1/ac3d9BTcQAKk4F2smcLB8MGG88PASA6wj6YcG8w6xLRnz+PtSsDeo+2wr9d+aSNSb223KsknUDaH2pYdzO1tq2oAwEyo+FTQ/PJ6Mh22QZT8t1T4G3A4rS6hkz5VRERxCTsRvuJXXJqKAGdMF7tI+lAa2LgIWlkK5whRyyb2TCmjifG3VZsH9foWgQcBMyDcK1omoTeBN66kKcYt1GfxfyM6mWfH1Y2/W5p9XgSeOFnQ7IDDaW61cPU2g8swxWL/zIwTW7YsPSTeQ5Zff85/v1rh+5Q3xWaJ1BDkH/ul4p9yl55FMz9pOEMBKi8vwSfFMYvNjnbolpYlFBYeTvMbC7Gy/KDNCsqpHYEzfsRiIkE2+bc38bbQOtBKPZAnpxTHhoNPy2I8udc3VUmDZtcnkMjkS/MWFYvfzpkKAOfSWypXYsv2LYzAOxjEQLGQyNk/NSwbN28hG6NfmDDSFqTi/XdMAatvPV7KsGhlHw2UiANlAOc8Woqqc3QscWH8CfV8S59clVJPM0jPwcd7TaYI9HLS6TO3x6D6sXH89V9mX+5Yj7gqiFR6elivoTTQK5C+YcaW+/EwJDfCPwDo3BXlCVE=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(136003)(376002)(346002)(39860400002)(396003)(36840700001)(46966006)(86362001)(7696005)(336012)(478600001)(81166007)(82740400003)(6666004)(356005)(5660300002)(47076005)(1076003)(316002)(2906002)(54906003)(110136005)(36860700001)(4326008)(82310400003)(2616005)(36756003)(70586007)(70206006)(16526019)(8936002)(186003)(8676002)(426003)(26005)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 15:01:43.7072
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 85eaf7aa-657a-4c01-e62b-08d972d9925b
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: CO1NAM11FT057.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: CY4PR1201MB0197
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

If kernel enables AMD P-state, cpupower won't need to respond ACPI
hardware P-states function anymore.

Signed-off-by: Huang Rui <ray.huang@amd.com>
---
 tools/power/cpupower/utils/helpers/cpuid.c | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/tools/power/cpupower/utils/helpers/cpuid.c b/tools/power/cpupower/utils/helpers/cpuid.c
index 72eb43593180..78218c54acca 100644
--- a/tools/power/cpupower/utils/helpers/cpuid.c
+++ b/tools/power/cpupower/utils/helpers/cpuid.c
@@ -149,6 +149,19 @@ int get_cpu_info(struct cpupower_cpu_info *cpu_info)
 		if (ext_cpuid_level >= 0x80000008 &&
 		    cpuid_ebx(0x80000008) & (1 << 4))
 			cpu_info->caps |= CPUPOWER_CAP_AMD_RDPRU;
+
+		if (cpupower_amd_pstate_enabled(0)) {
+			cpu_info->caps |= CPUPOWER_CAP_AMD_PSTATE;
+
+			/*
+			 * If AMD P-state is enabled, the firmware will treat
+			 * AMD P-state function as high priority.
+			 */
+			cpu_info->caps &= ~CPUPOWER_CAP_AMD_CPB;
+			cpu_info->caps &= ~CPUPOWER_CAP_AMD_CPB_MSR;
+			cpu_info->caps &= ~CPUPOWER_CAP_AMD_HW_PSTATE;
+			cpu_info->caps &= ~CPUPOWER_CAP_AMD_PSTATEDEF;
+		}
 	}
 
 	if (cpu_info->vendor == X86_VENDOR_INTEL) {
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-18.8 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,USER_AGENT_GIT
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 1DF31C4332F
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:02:16 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 0992A611C2
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:02:16 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1352148AbhIHPDW (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 11:03:22 -0400
Received: from mail-mw2nam12on2061.outbound.protection.outlook.com ([40.107.244.61]:37985
        "EHLO NAM12-MW2-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1352139AbhIHPDJ (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 11:03:09 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=LKTQFGWbhaVlulHBnrpu9j/5VvkWptFFUVvfr+VjGFRNbZSKxaXUr9dMMKVhw8QkRJyfRrakmPhOkhKPaNhl5EKYo7YofaHdjVk5LuU5ZqkjnDocbWWanjlma6DWhRy4AV241uU3W20ZPexJ6vHPWvwn+g2O7CCle3JTGda0G9ZTljQKKkqI+2R9uhGyWfYYlWGSv6zx9kUXulsy6zRa+lhQhNZ2jHEyrLI59fCeIVEF4AqE7IRKSRrGNZqGz+/hyC68GfliBHelR6FHB9LHeDO441Q1G9Z+eqVIW4UHnH766tiOPazzEc0B1zbvOqQRBrd5wcs951t71YR5fteJZg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=eyD/zavu25QEKfhRVgmr/pwsTa9qz6QM+kgPqzFP2wY=;
 b=HJCS6o/tmkSO48sYFkLhtw3Vl0CN+qhDCH4jpLhAiXcsCeaHu2crZ5UdrkryJBI+57KjYNMnG/AJqwKJHO3L5PJBQihuR12PRmmL01Pgz0pQSBu/1EdfyhUSf06Jmtp1n/Nlrl2KhKzx6QXy9ct93vLjEPZNW3LO7EwFSnaB9/AzqYkAqmpL8c11C9jVzK4yXR9xNpgmXfxNtoSIr9R4W7cmY5oafYykEr0f/wSEmcfxjTpRAeVXiZYOawgcf+F9dYbWEp/P5jWxImoe91hD2S3oJWdGUG1utB26dXBnWz00F2OG1VEMV36nm4Qf0F0sMz/0onG5dveJ/Af6OqT6GQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=eyD/zavu25QEKfhRVgmr/pwsTa9qz6QM+kgPqzFP2wY=;
 b=KrEr8i5ogKKqSk4jPkklEytf3PemR2SQSohSaVrkVjwhDz1csnr1vzxSOyDnTwSb4J/FWgijxOpHaFzujAxW6BpzooEUDwFOR8QUqZeTR6I/ZsOm8E/wdHLAu/8bD7n/TqY7l49GwK1mivpXOfiJE5hCYQdy4cULKOmEWeFTMHI=
Received: from MWHPR22CA0035.namprd22.prod.outlook.com (2603:10b6:300:69::21)
 by BN9PR12MB5209.namprd12.prod.outlook.com (2603:10b6:408:11a::22) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4478.19; Wed, 8 Sep
 2021 15:01:55 +0000
Received: from CO1NAM11FT014.eop-nam11.prod.protection.outlook.com
 (2603:10b6:300:69:cafe::d6) by MWHPR22CA0035.outlook.office365.com
 (2603:10b6:300:69::21) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Wed, 8 Sep 2021 15:01:55 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CO1NAM11FT014.mail.protection.outlook.com (10.13.175.99) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 15:01:54 +0000
Received: from hr-amd.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Wed, 8 Sep 2021
 10:01:42 -0500
From:   Huang Rui <ray.huang@amd.com>
To:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        <linux-pm@vger.kernel.org>
CC:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        <linux-kernel@vger.kernel.org>, <x86@kernel.org>,
        Huang Rui <ray.huang@amd.com>
Subject: [PATCH 15/19] cpupower: add amd-pstate sysfs entries into libcpufreq
Date:   Wed, 8 Sep 2021 22:59:57 +0800
Message-ID: <20210908150001.3702552-16-ray.huang@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210908150001.3702552-1-ray.huang@amd.com>
References: <20210908150001.3702552-1-ray.huang@amd.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Type: text/plain
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: b6a78a0b-f777-418f-994e-08d972d998fc
X-MS-TrafficTypeDiagnostic: BN9PR12MB5209:
X-Microsoft-Antispam-PRVS: <BN9PR12MB520975315213EC072889A0D6ECD49@BN9PR12MB5209.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:1728;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 3urddICapwYmMzsA85Lf7yfMbOStByuSw9da1DAs5Tv+zdg8XzGpVHsdycEHRoFTYYhsg3e3ugFTSeTsc3LrTqP9Q62lBmZ4oc5eXSwbfVLtxwxffsI4He6rq+oxFwheW9ERYsxoF8usssIGOwzuLq1gGkv/DLC+8RJJf1chS/5BrO4vdD1NSLKigCrWVuvaTbgiEOs2uK1LqxAPtfl32cuXuj0J687k3hN7MP3FLM6pGsC/pieOVQlLK8GWKbozKUb4WNRGvJfna9QOYeZHNe6eOXxQkPxSxja2oeGZq0bOUzqEGoIy6qr6VQ8wEmRcdsmNviW8rBHq8UudhhrbCh+NIbqjjWpQC0TZpqSPkxBTAkmbrPjx+IwuFiDa9OCkRIRfdWagU0kEKCyejuIwJ1EmlXAEZOpoYmOkouwmK2+MvShYMtMdMT/oguYmlez+lXz/H8DWyekM6x5Xe04Q/XCN5MCR6f7W4BzAylk8+7wk9CZ54qodNhuf2oY28S8Wi6OO8DTKJGKwRcxdKco5JBooxW2oCL3JcNbPYzSz2FHeghvZLk/VjamQzujr2Q5LAaiYV/2eC9TpydWxgqyRW2WHBWktF3TmCwntyR6VvjG2t6ElMR7zcosFaiZxV1fvvYARHmmggxiFF8dw0gv+TLeuFm2m8UDseTviQsLpKUm1oLV7T8anf/HCRERt9n7yBqoh7ehJ1ikrmixuWzTl6B7Czif7bQPo3yzHAZGYM/A=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(376002)(346002)(39860400002)(396003)(136003)(36840700001)(46966006)(54906003)(110136005)(83380400001)(82740400003)(316002)(86362001)(2906002)(4326008)(36860700001)(82310400003)(36756003)(186003)(2616005)(336012)(1076003)(70206006)(70586007)(8936002)(426003)(26005)(16526019)(8676002)(6666004)(47076005)(81166007)(478600001)(356005)(7696005)(5660300002)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 15:01:54.8077
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: b6a78a0b-f777-418f-994e-08d972d998fc
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: CO1NAM11FT014.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: BN9PR12MB5209
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

These amd-pstate sysfs entries will be used on cpupower for amd-pstate
kernel module.

Signed-off-by: Huang Rui <ray.huang@amd.com>
---
 tools/power/cpupower/lib/cpufreq.c | 18 +++++++++++++++++-
 1 file changed, 17 insertions(+), 1 deletion(-)

diff --git a/tools/power/cpupower/lib/cpufreq.c b/tools/power/cpupower/lib/cpufreq.c
index c3b56db8b921..3f92ddadaad2 100644
--- a/tools/power/cpupower/lib/cpufreq.c
+++ b/tools/power/cpupower/lib/cpufreq.c
@@ -69,6 +69,14 @@ enum cpufreq_value {
 	SCALING_MIN_FREQ,
 	SCALING_MAX_FREQ,
 	STATS_NUM_TRANSITIONS,
+	AMD_PSTATE_HIGHEST_PERF,
+	AMD_PSTATE_NOMINAL_PERF,
+	AMD_PSTATE_LOWEST_NONLINEAR_PERF,
+	AMD_PSTATE_LOWEST_PERF,
+	AMD_PSTATE_MAX_FREQ,
+	AMD_PSTATE_NOMINAL_FREQ,
+	AMD_PSTATE_LOWEST_NONLINEAR_FREQ,
+	AMD_PSTATE_MIN_FREQ,
 	MAX_CPUFREQ_VALUE_READ_FILES
 };
 
@@ -80,7 +88,15 @@ static const char *cpufreq_value_files[MAX_CPUFREQ_VALUE_READ_FILES] = {
 	[SCALING_CUR_FREQ] = "scaling_cur_freq",
 	[SCALING_MIN_FREQ] = "scaling_min_freq",
 	[SCALING_MAX_FREQ] = "scaling_max_freq",
-	[STATS_NUM_TRANSITIONS] = "stats/total_trans"
+	[STATS_NUM_TRANSITIONS] = "stats/total_trans",
+	[AMD_PSTATE_HIGHEST_PERF] = "amd_pstate_highest_perf",
+	[AMD_PSTATE_NOMINAL_PERF] = "amd_pstate_nominal_perf",
+	[AMD_PSTATE_LOWEST_NONLINEAR_PERF] = "amd_pstate_lowest_nonlinear_perf",
+	[AMD_PSTATE_LOWEST_PERF] = "amd_pstate_lowest_perf",
+	[AMD_PSTATE_MAX_FREQ] = "amd_pstate_max_freq",
+	[AMD_PSTATE_NOMINAL_FREQ] = "amd_pstate_nominal_freq",
+	[AMD_PSTATE_LOWEST_NONLINEAR_FREQ] = "amd_pstate_lowest_nonlinear_freq",
+	[AMD_PSTATE_MIN_FREQ] = "amd_pstate_min_freq"
 };
 
 
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-18.8 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,USER_AGENT_GIT
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 349FAC433FE
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:02:18 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 1F180611C2
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:02:18 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1352034AbhIHPDY (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 11:03:24 -0400
Received: from mail-dm6nam12on2084.outbound.protection.outlook.com ([40.107.243.84]:18865
        "EHLO NAM12-DM6-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1352146AbhIHPDM (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 11:03:12 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=G9HDccRksStruCulp6QouXu+9cFLR/eym+uHL3WTRH+y5Gptr2yNcGgSiLzN2zmkJv1k9q0Ey7Y1BGXgqzkGeANOnZoco0T/HGINe0Y+rNvRVL+GE4Oq65whLlNjsZsGm9fDFCDkyMaH48ZvLcYv3FZHPPN391CNWU/fkOyVahLgYwZOCbUjjw1y8zq2XuXY0JIXgKjIuEPNLlb5yOHhzY5ybDxHhCEeWWsWC9FKlIA6O0wfmPLnuW7j2uUM9E5VDuVIh6oKiObh9gk0PawdFLN+tXbfCUp0Zfqvph+XG9vYKsKdfExU2XcweR/cKSBJ0Paom/8MdwNfRZNDnyRmVw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=cmrp+7el6YRgEkr6/T5xhYYKoMbgAYrrQ/2R4RvOi9Q=;
 b=c9CPuAPv20qK6sRDFh2QjWpXJyPBfVSJEAvMi8AHNEJcs0un/RB1yVMLOqJQSqlkeHYktg3M4AOknhOnuBZgqkEioi2AvFu8LNW2LVUY412dpM5ZVmpnlAOclzCSL1tFWJXDsoF7dgpZIaS6++UfZ2/NPcuwqFciguH05atexgLZTjOKdC1FOvZa9vCGIBB2oozG211kmy3kE0Jz6W2YTiEvWymwRFfk1EXV/PK4kU2il2EZFbNpYPFp+5Nx5AvrkiFqRmtGf9PSuyqdptniG/74ZGBBjUjE+H+XyoqfI5JBJFuL/hyM2HqHKUr76+r5fLf32v9noeb7QeY4dhw85Q==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=cmrp+7el6YRgEkr6/T5xhYYKoMbgAYrrQ/2R4RvOi9Q=;
 b=saF5g7uvNvcJZMmb5qb9cqXSVEnj0Ug525+VZcpUaB68K8CEizbg6gbudQ2sYLtMR8Bmvrtsg9C5v2qg500Z+A9bcBvrKCpDfNG2ghlvy4P1z70WaKLcYFnQALwQrp4etDqRcsF7NMm0sFJuHp0tdcdVajZVxs2173CSvD0DL4Q=
Received: from MW4PR04CA0218.namprd04.prod.outlook.com (2603:10b6:303:87::13)
 by DM5PR1201MB0203.namprd12.prod.outlook.com (2603:10b6:4:56::15) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14; Wed, 8 Sep
 2021 15:02:02 +0000
Received: from CO1NAM11FT018.eop-nam11.prod.protection.outlook.com
 (2603:10b6:303:87:cafe::fc) by MW4PR04CA0218.outlook.office365.com
 (2603:10b6:303:87::13) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Wed, 8 Sep 2021 15:02:02 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CO1NAM11FT018.mail.protection.outlook.com (10.13.175.16) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 15:02:02 +0000
Received: from hr-amd.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Wed, 8 Sep 2021
 10:01:46 -0500
From:   Huang Rui <ray.huang@amd.com>
To:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        <linux-pm@vger.kernel.org>
CC:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        <linux-kernel@vger.kernel.org>, <x86@kernel.org>,
        Huang Rui <ray.huang@amd.com>
Subject: [PATCH 16/19] cpupower: enable boost state support for amd-pstate module
Date:   Wed, 8 Sep 2021 22:59:58 +0800
Message-ID: <20210908150001.3702552-17-ray.huang@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210908150001.3702552-1-ray.huang@amd.com>
References: <20210908150001.3702552-1-ray.huang@amd.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Type: text/plain
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 303113ca-3f45-439b-9a41-08d972d99d7b
X-MS-TrafficTypeDiagnostic: DM5PR1201MB0203:
X-Microsoft-Antispam-PRVS: <DM5PR1201MB020308C53937E154B732EDDEECD49@DM5PR1201MB0203.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:4125;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 96dMPKC45FosabsBQZO9/PIFtFRGnb9/MzlArRs1Rk5BsJnRuAWo5zF9xEPFuxaPEQBKNWeUNchVGojHCOEoktO6ZddjPxb2E/Ryz50mfzYcBBhqLckWPdPvZ98T/E39qwZtpHNLMLYCnSNvekurpgI97U8ZLwLSeH9UeGe9okiv3lzwZa/KGtD/Oq8a4P0nEoS5BFUuRrBgtWUJ46PoB9LwdofUiaO/sIIgoXtbrecL5fyPuMcgeJ1TXGpwumC2n4C4Rj2kjwcuEuQQDOmanhMwjCdojsyMXRx4QCFgjgMeFCJY5ODRB4Ft7Ipx4Jgeepw/FZp7PppiP2BPAptDCMNgO/a9JtoNWQc0+KpG3jetNZET2EUhJbR6fhQoTUnDBGqityHcaUMxyZ5aSsc8f1vntaUuCWmwSE+jNR0ZnL8WHaFDthMbZa6LkLKsjhZ/LSSUJwaGkb7M9dGYoESHfEYaGFs1xVNxKHvszUN5UGTTyzdohNqTEyDe0bg/fggsx9JG4UB0lDahIg6Pp8uWXO+qbNcst5KCETLGKu0P3INT5yCG2pmDPmZNFzlJ33tQ/V4eX0vLBS+L3ycfJoFPtqcDaCzgDumjvj520bck8xZf1iZQHtDoxYNIPO6NAM6QvGkLEpc+K9z6QpPMaOAbgdtM/5F+XapALkZFNEDYh//83xWjvmlHEQNcfy3DQEpkz1oyY/GhEc6uE1AB8sQ/1ruoFpcY+YhwAIBd5FBMB5I=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(46966006)(36840700001)(70586007)(8676002)(8936002)(70206006)(316002)(54906003)(36756003)(426003)(6666004)(16526019)(186003)(110136005)(336012)(1076003)(2616005)(7696005)(5660300002)(26005)(81166007)(356005)(36860700001)(4326008)(82310400003)(86362001)(47076005)(508600001)(2906002)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 15:02:02.3609
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 303113ca-3f45-439b-9a41-08d972d99d7b
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: CO1NAM11FT018.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM5PR1201MB0203
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

The AMD P-state boost API is different from ACPI hardware P-states, so
implement the support for amd-pstate kernel module.

Signed-off-by: Huang Rui <ray.huang@amd.com>
---
 tools/power/cpupower/lib/cpufreq.c        | 20 ++++++++++++++++++++
 tools/power/cpupower/lib/cpufreq.h        |  3 +++
 tools/power/cpupower/utils/helpers/misc.c |  7 +++++++
 3 files changed, 30 insertions(+)

diff --git a/tools/power/cpupower/lib/cpufreq.c b/tools/power/cpupower/lib/cpufreq.c
index 3f92ddadaad2..37da87bdcfb1 100644
--- a/tools/power/cpupower/lib/cpufreq.c
+++ b/tools/power/cpupower/lib/cpufreq.c
@@ -790,3 +790,23 @@ unsigned long cpufreq_get_transitions(unsigned int cpu)
 {
 	return sysfs_cpufreq_get_one_value(cpu, STATS_NUM_TRANSITIONS);
 }
+
+int amd_pstate_boost_support(unsigned int cpu)
+{
+	unsigned int highest_perf, nominal_perf;
+
+	highest_perf = sysfs_cpufreq_get_one_value(cpu, AMD_PSTATE_HIGHEST_PERF);
+	nominal_perf = sysfs_cpufreq_get_one_value(cpu, AMD_PSTATE_NOMINAL_PERF);
+
+	return highest_perf > nominal_perf ? 1 : 0;
+}
+
+int amd_pstate_boost_enabled(unsigned int cpu)
+{
+	unsigned int cpuinfo_max, amd_pstate_max;
+
+	cpuinfo_max = sysfs_cpufreq_get_one_value(cpu, CPUINFO_MAX_FREQ);
+	amd_pstate_max = sysfs_cpufreq_get_one_value(cpu, AMD_PSTATE_MAX_FREQ);
+
+	return cpuinfo_max == amd_pstate_max ? 1 : 0;
+}
diff --git a/tools/power/cpupower/lib/cpufreq.h b/tools/power/cpupower/lib/cpufreq.h
index 95f4fd9e2656..d54d02a7a4f4 100644
--- a/tools/power/cpupower/lib/cpufreq.h
+++ b/tools/power/cpupower/lib/cpufreq.h
@@ -203,6 +203,9 @@ int cpufreq_modify_policy_governor(unsigned int cpu, char *governor);
 int cpufreq_set_frequency(unsigned int cpu,
 				unsigned long target_frequency);
 
+int amd_pstate_boost_support(unsigned int cpu);
+int amd_pstate_boost_enabled(unsigned int cpu);
+
 #ifdef __cplusplus
 }
 #endif
diff --git a/tools/power/cpupower/utils/helpers/misc.c b/tools/power/cpupower/utils/helpers/misc.c
index 07d80775fb68..aba979320760 100644
--- a/tools/power/cpupower/utils/helpers/misc.c
+++ b/tools/power/cpupower/utils/helpers/misc.c
@@ -10,6 +10,7 @@
 #if defined(__i386__) || defined(__x86_64__)
 
 #include "cpupower_intern.h"
+#include "cpufreq.h"
 
 #define MSR_AMD_HWCR	0xc0010015
 
@@ -39,6 +40,12 @@ int cpufreq_has_boost_support(unsigned int cpu, int *support, int *active,
 			if (ret)
 				return ret;
 		}
+	} if ((cpupower_cpu_info.caps & CPUPOWER_CAP_AMD_PSTATE) &&
+	      amd_pstate_boost_support(cpu)) {
+		*support = 1;
+
+		if (amd_pstate_boost_enabled(cpu))
+			*active = 1;
 	} else if (cpupower_cpu_info.caps & CPUPOWER_CAP_INTEL_IDA)
 		*support = *active = 1;
 	return 0;
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-18.8 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,USER_AGENT_GIT
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 9C357C433F5
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:02:25 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 857C8611CB
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:02:25 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1352159AbhIHPD0 (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 11:03:26 -0400
Received: from mail-bn7nam10on2053.outbound.protection.outlook.com ([40.107.92.53]:32993
        "EHLO NAM10-BN7-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1352150AbhIHPDN (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 11:03:13 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=jIFSxqoBsjqZnPxb6rknURdcjhN9ptm9yMIn91tLeR2YI5QYIvaUTQsPe9D80KySw8VtO5cCtEqmA8hERZvJHeqtm767binJG1wACzNy55o0NBKYSFYmJwebCSLzjp9zXbG8DB2DMi8Qr0FdGdKxWVI0YCWim4Dqh0nFKdv249o/9vx/YoAFgQarS1BRvK6TrxoBKtc+dA3PtddbuAQ+ufHFoYKyKFFFHWhJ8/4zlSx9k2Vr3AU5cN239SSBe4zpM9nuX6sGdQIHgauhN7GcvSBZTXhjGp33f/eIjdMtuRB6PYfQzaY2U0zbjYlxCZCvybdH/O8r5osQAjv5Jh2g7g==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=81l4DI6oBLJh8DFDJD0bnFficA68wYX8LYqPE4J60W8=;
 b=AD3BE9nYyKHJ8ZNbkr9KFr0QgUuMmYprHQSHdZCHY8DyWs5yWq53XETYk8OtMXVGVuclGtAC0GXpJB/cF+P2BTXz9kcCeV26xksdrFvadYzG3LUfD7OrDkCWoUZPHd2f03wlkNS9EDAwo+gx+ah/Aff1gdDs4xJ4Ur34nfX/UOEhB18vCD3mC0V4IVEpiGQR3sFNOu5UjkhBb3AxHk3WyyfyGlYBHabYAeIWv/CtUaHvxeJSxTk5Z4ykch1kNcePZHXt3IU5X4guUcQBUbJ8F3iNgs3dqoPEF9VykWpIz5DJO8bdh1CzplT03ecvKggNmzPZh6Vmu7/pY2RySo3AuA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=81l4DI6oBLJh8DFDJD0bnFficA68wYX8LYqPE4J60W8=;
 b=5FO3hrAIjQjGo2mqT6lfomEsRAX8WrQBYlCS/7EEVpDCebjSFzG23n9BoYVltfmcQWAnTmo82uCIVLzS4sy6r8m/5vQNz1UEj8AgIlGiJ1jzTFlpEWkl0Vfkufj68oY5EvLSbOLBI/dXJEMsCdAAkun9D76NVTlsA1LeFIk8Tm0=
Received: from MW4PR04CA0234.namprd04.prod.outlook.com (2603:10b6:303:87::29)
 by BL0PR12MB4754.namprd12.prod.outlook.com (2603:10b6:208:8e::26) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14; Wed, 8 Sep
 2021 15:02:03 +0000
Received: from CO1NAM11FT018.eop-nam11.prod.protection.outlook.com
 (2603:10b6:303:87:cafe::8d) by MW4PR04CA0234.outlook.office365.com
 (2603:10b6:303:87::29) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Wed, 8 Sep 2021 15:02:03 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CO1NAM11FT018.mail.protection.outlook.com (10.13.175.16) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 15:02:03 +0000
Received: from hr-amd.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Wed, 8 Sep 2021
 10:01:50 -0500
From:   Huang Rui <ray.huang@amd.com>
To:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        <linux-pm@vger.kernel.org>
CC:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        <linux-kernel@vger.kernel.org>, <x86@kernel.org>,
        Huang Rui <ray.huang@amd.com>
Subject: [PATCH 17/19] cpupower: add amd-pstate get data function to query the info
Date:   Wed, 8 Sep 2021 22:59:59 +0800
Message-ID: <20210908150001.3702552-18-ray.huang@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210908150001.3702552-1-ray.huang@amd.com>
References: <20210908150001.3702552-1-ray.huang@amd.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Type: text/plain
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 47733560-7453-4dda-79d2-08d972d99de1
X-MS-TrafficTypeDiagnostic: BL0PR12MB4754:
X-Microsoft-Antispam-PRVS: <BL0PR12MB47544C2C8CE1B7B8C59A6BABECD49@BL0PR12MB4754.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:849;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: pRdqJaEks2HQ0O26Ttkads+ODJPmtNz/Xz4oATz6I6MniZTkg8d/YMI9qZM4PF9r5fSG16KRH8UBE05kNjjChkckLM8PmZ/062Jdn3mpb9a3LM4jwoKrbJF/7y24qZkXlGkHX8J34MU62X5tKVvHVIDIj8r2ln2s0heshkSSuG02+w4/IYP5oQhsCvm35gHEB/SWPIL/DQvmhfWB5tV0BdOkfvzbJY7ZdzLhT2fUm9RGx0JChvOGdrNdJ31hmTnf9lF4X5ArBES/M26ZgtQvFpE2L/LOsS7KS3VZySYbhKZptS98NEr4LX5OCwRqkDeRjLdNZ1wl6Mgu1NZpS8nUoonUxzlMHiS//3OOUOOG+urPup6iw6xqSYnkzrJgvgzDaC7d1Wx/2tK4f1jEQ+VjhQclwwmsYAJ5tPja/zUD2tDyQfzO1rL7c7hiT8fG5nOSdQ+zGjLliDC+af78+Aw0BQi38hGQXEKSGJAxgReKoDJ8yWJn7voN98YPNcDlSPM/5/ImMtiFUP+47OJYDknRU5EM4jMzB2o/8p65y276IZ3sy8QBBRIHvFCnkc6J678HqqwU9tXfTK4HV6JqAqeHaBw6kTAvNLBMPaX44mQt5vGut8AHRlsPuQdlQL1gkVcWQJWEX9oEUMU1I9pIFuwqPvZMWZ3QQVoiVgXenVu9h6rW6cg+ntGvfUZsbMZVPQAnAe/2QrzFr6dXbxqH1+iGXnP2mES/77yO4RtjpVbSKbY=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(136003)(396003)(376002)(39860400002)(346002)(46966006)(36840700001)(4326008)(110136005)(316002)(70206006)(86362001)(336012)(83380400001)(36756003)(47076005)(81166007)(82740400003)(356005)(70586007)(2906002)(54906003)(426003)(5660300002)(8936002)(186003)(26005)(36860700001)(82310400003)(2616005)(1076003)(478600001)(7696005)(16526019)(8676002)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 15:02:03.0286
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 47733560-7453-4dda-79d2-08d972d99de1
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: CO1NAM11FT018.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: BL0PR12MB4754
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Frequency-info needs an interface to query the current amd-pstate data.

Signed-off-by: Huang Rui <ray.huang@amd.com>
---
 tools/power/cpupower/lib/cpufreq.c |  6 ++++++
 tools/power/cpupower/lib/cpufreq.h | 13 +++++++++++++
 2 files changed, 19 insertions(+)

diff --git a/tools/power/cpupower/lib/cpufreq.c b/tools/power/cpupower/lib/cpufreq.c
index 37da87bdcfb1..1443080868da 100644
--- a/tools/power/cpupower/lib/cpufreq.c
+++ b/tools/power/cpupower/lib/cpufreq.c
@@ -810,3 +810,9 @@ int amd_pstate_boost_enabled(unsigned int cpu)
 
 	return cpuinfo_max == amd_pstate_max ? 1 : 0;
 }
+
+unsigned amd_pstate_get_data(unsigned int cpu, enum amd_pstate_param param)
+{
+	return sysfs_cpufreq_get_one_value(cpu,
+					   param + AMD_PSTATE_HIGHEST_PERF);
+}
diff --git a/tools/power/cpupower/lib/cpufreq.h b/tools/power/cpupower/lib/cpufreq.h
index d54d02a7a4f4..954e72704fc0 100644
--- a/tools/power/cpupower/lib/cpufreq.h
+++ b/tools/power/cpupower/lib/cpufreq.h
@@ -206,6 +206,19 @@ int cpufreq_set_frequency(unsigned int cpu,
 int amd_pstate_boost_support(unsigned int cpu);
 int amd_pstate_boost_enabled(unsigned int cpu);
 
+enum amd_pstate_param {
+	HIGHEST_PERF,
+	NOMINAL_PERF,
+	LOWEST_NONLINEAR_PERF,
+	LOWEST_PERF,
+	MAX_FREQ,
+	NOMINAL_FREQ,
+	LOWEST_NONLINEAR_FREQ,
+	MIN_FREQ,
+};
+
+unsigned amd_pstate_get_data(unsigned int cpu, enum amd_pstate_param param);
+
 #ifdef __cplusplus
 }
 #endif
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-18.8 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,USER_AGENT_GIT
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 9374EC433F5
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:02:29 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 7C9D1611BF
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:02:29 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1352222AbhIHPDe (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 11:03:34 -0400
Received: from mail-mw2nam10on2082.outbound.protection.outlook.com ([40.107.94.82]:30292
        "EHLO NAM10-MW2-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1352151AbhIHPDN (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 11:03:13 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=mRp9WlHo8dar0uoV57w1jPYVk+JbMJ4oi1aWHqFcFh8YSOeoLs10KJ1HYs+Z3KO4qeOQK4uIg8KDfStdcIahKmB1n6x3vuw4JHCbJUCf4zdLVlCQh4VJEIaVeF1BLfQqQS7trtNqR8RwApQ7p8GWlOTsTY1m6kMvQFV3G4uw+f9IEjmsgPyWOoPXpEZdqCPdSBRLFV+Og3KgDi+67f2mOJM01OdxQG1ufVQut4XEw6MaI8XyQeIjC/lXRyG9aCp1pMStyQDqcYWFkiRRrB5d2Kx8/+pdij6itv30Y2sOxX4BRd+W/HNSJukpYAHELAYd1BxUcwTm2g3WoyOJdS9TQg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=PY4ei2w1olgedxpgS8+uC3ssMr/c8cGKUIGmOWkYhXs=;
 b=X95d0ZqZxPHXmYZ20FskhOiKzlHuUsN2O8Y9lpy4+qStVmKGhdkS8NSbtJBctg9D44xzJ2arn0mpsTzuMeAGucUZTPiTjlWrItnCSPi37JjHp3SIIhe/GFRiZEKdMIVXBX/T6t4/gUxdSCe/WiGa0V0HvcDBADB7qZce9QbtnBaZQUkz3MeSINFOl8QL6fKv9DPDLAe6+lzWI12yFBR/TM9d2Z67MUZvhJLx37naZfMBtc6GDVJ73pCda9Thxk0hN7IEO7i8XlQg300dLjdyk6zaXiq2DnUiHfHPMGA45tB+RDspu8fAbt3SRA/5kIb0Pop1c5eNlKc71Yd7Jnu4YQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=PY4ei2w1olgedxpgS8+uC3ssMr/c8cGKUIGmOWkYhXs=;
 b=5saOxaa7+FThqe/NHVyT5C49G5n6lSlnufLAI8zBqxXDN9CSFXuoXWd79ImgkrU3gFYFtWLGT8DkBVC0VP6CkvMmsnSi7eM0v92fdDorGORQLe8qrsKtsi/7Rz+ycOZBJKRheTXMRSRZjTCb8tC+KYs9NGABy2Tt1gkwN5vAdZA=
Received: from MW4PR04CA0220.namprd04.prod.outlook.com (2603:10b6:303:87::15)
 by DM5PR12MB1369.namprd12.prod.outlook.com (2603:10b6:3:6f::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4478.24; Wed, 8 Sep
 2021 15:02:04 +0000
Received: from CO1NAM11FT018.eop-nam11.prod.protection.outlook.com
 (2603:10b6:303:87:cafe::fb) by MW4PR04CA0220.outlook.office365.com
 (2603:10b6:303:87::15) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Wed, 8 Sep 2021 15:02:03 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CO1NAM11FT018.mail.protection.outlook.com (10.13.175.16) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 15:02:03 +0000
Received: from hr-amd.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Wed, 8 Sep 2021
 10:01:53 -0500
From:   Huang Rui <ray.huang@amd.com>
To:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        <linux-pm@vger.kernel.org>
CC:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        <linux-kernel@vger.kernel.org>, <x86@kernel.org>,
        Huang Rui <ray.huang@amd.com>
Subject: [PATCH 18/19] cpupower: print amd-pstate information on cpupower
Date:   Wed, 8 Sep 2021 23:00:00 +0800
Message-ID: <20210908150001.3702552-19-ray.huang@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210908150001.3702552-1-ray.huang@amd.com>
References: <20210908150001.3702552-1-ray.huang@amd.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Type: text/plain
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 83b1e812-9f6a-409b-b44e-08d972d99e4a
X-MS-TrafficTypeDiagnostic: DM5PR12MB1369:
X-Microsoft-Antispam-PRVS: <DM5PR12MB1369F22D28FC36B7C59981D8ECD49@DM5PR12MB1369.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:256;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 9VDOThMhLFn+6g9y2/1Np5p+zLPIVxcknYKM8fHAEiKfCDd1SXgFYD/90yRSWeMnhYQ+MZ0TXlI3P577ywtuQ3MYXWD3Cz+DIZGEZJwk3BOygpT6OvgKtTRtEUq+l+q4w+LNqAHO/ECe4t3vpF9zfmss4mcLbXk+t4IJqX0PPyw82xANKRrVBwRfiz66ouYP9Cj7YJg6h4DKwojKgUSY3D5DuqsDIW+zI4DRzPQ6VBklxR0bkW9SwwL6qPJK9OaxdNoSGazKKiXSPRkk8jmC2AelRib4HdRuWsjDj50UCygeTpAdQN26k0Zs499wdb7Z/+oW12VsXR+/TReJRWNViKRfdT66zFd2yu7kVx4+uFW8Vipwv9bjTo0FqAXoZpFLFxMDpd24kuWpNumcUxGGRHcv/vZAmQ7xOi4lQBRWZ8Sb6+Licee0X+XRRGdUjaIPviP50yMVQ0MkOrFqmosMeW1Jtt0K7DXqxgG1v521CPLaXbqSGMoCRJ9HDvMD5iA4TKcpgQtfDpiVt7sySlOwez3z497UIJkqPcutwMd5rtpg7bk0DT5bRWAI3c3BpsBi1n0HQOTwilWPa9q/X0wTxKvbqYP8o0Fa8Rz49Pk/Ygktkqc58OoDd/ljHVUk5RuxD6DzH/4074iZPKC2xk3M+qSjsCU5XGWzBMHQIPN/KLr9bI+nDlKyqe61U/opd1lllsL5iDYTCAQJB7ej6UFVHcKVgSSdHtKqV6dF27CXo9I=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(39860400002)(376002)(396003)(136003)(346002)(36840700001)(46966006)(26005)(110136005)(316002)(8936002)(336012)(82310400003)(7696005)(2906002)(54906003)(81166007)(36756003)(83380400001)(36860700001)(6666004)(2616005)(82740400003)(426003)(86362001)(356005)(47076005)(1076003)(8676002)(70586007)(5660300002)(70206006)(4326008)(478600001)(186003)(16526019)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 15:02:03.7192
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 83b1e812-9f6a-409b-b44e-08d972d99e4a
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: CO1NAM11FT018.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM5PR12MB1369
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

amd-pstate kernel module is using the fine grain frequency instead of
acpi hardware pstate. So the performance and frequency values should be
printed in frequency-info.

Signed-off-by: Huang Rui <ray.huang@amd.com>
---
 tools/power/cpupower/utils/cpufreq-info.c | 27 ++++++++++++++++++++---
 1 file changed, 24 insertions(+), 3 deletions(-)

diff --git a/tools/power/cpupower/utils/cpufreq-info.c b/tools/power/cpupower/utils/cpufreq-info.c
index f9895e31ff5a..9eabed209adc 100644
--- a/tools/power/cpupower/utils/cpufreq-info.c
+++ b/tools/power/cpupower/utils/cpufreq-info.c
@@ -183,9 +183,30 @@ static int get_boost_mode_x86(unsigned int cpu)
 	printf(_("    Supported: %s\n"), support ? _("yes") : _("no"));
 	printf(_("    Active: %s\n"), active ? _("yes") : _("no"));
 
-	if ((cpupower_cpu_info.vendor == X86_VENDOR_AMD &&
-	     cpupower_cpu_info.family >= 0x10) ||
-	     cpupower_cpu_info.vendor == X86_VENDOR_HYGON) {
+	if (cpupower_cpu_info.vendor == X86_VENDOR_AMD &&
+	    cpupower_cpu_info.caps & CPUPOWER_CAP_AMD_PSTATE) {
+		printf(_("    AMD PSTATE Highest Performance: %u. Maximum Frequency: "),
+		       amd_pstate_get_data(cpu, HIGHEST_PERF));
+		print_speed(amd_pstate_get_data(cpu, MAX_FREQ));
+		printf(".\n");
+
+		printf(_("    AMD PSTATE Nominal Performance: %u. Nominal Frequency: "),
+		       amd_pstate_get_data(cpu, NOMINAL_PERF));
+		print_speed(amd_pstate_get_data(cpu, NOMINAL_FREQ));
+		printf(".\n");
+
+		printf(_("    AMD PSTATE Lowest Non-linear Performance: %u. Lowest Non-linear Frequency: "),
+		       amd_pstate_get_data(cpu, LOWEST_NONLINEAR_PERF));
+		print_speed(amd_pstate_get_data(cpu, LOWEST_NONLINEAR_FREQ));
+		printf(".\n");
+
+		printf(_("    AMD PSTATE Lowest Performance: %u. Lowest Frequency: "),
+		       amd_pstate_get_data(cpu, LOWEST_PERF));
+		print_speed(amd_pstate_get_data(cpu, MIN_FREQ));
+		printf(".\n");
+	} else if ((cpupower_cpu_info.vendor == X86_VENDOR_AMD &&
+		    cpupower_cpu_info.family >= 0x10) ||
+		   cpupower_cpu_info.vendor == X86_VENDOR_HYGON) {
 		ret = decode_pstates(cpu, b_states, pstates, &pstate_no);
 		if (ret)
 			return ret;
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-18.8 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,USER_AGENT_GIT
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 5D48BC433EF
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:02:31 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 42468611F2
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 15:02:31 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1352052AbhIHPDh (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 11:03:37 -0400
Received: from mail-sn1anam02on2068.outbound.protection.outlook.com ([40.107.96.68]:3746
        "EHLO NAM02-SN1-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1352081AbhIHPDQ (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 11:03:16 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=VGCQzrND4nPSMBepOTKxLwhTkDtMrCEYXldNv92LGEGubOq9WW7IdBeiemPL5vruOoQQnP6Aqov7kZYWG3h+rbGwl1zEJ48P4J8PaEN8DBoLe4zz/+2/KsA7U2CsyhZ+YWdp5m5u1lCHIWQ4rH2+85+N1Q/lz61iwgQwSEkjZfRl0xK8V7SrrAaqevSIfm1gaO/AvfMgrpKTmK4ZrZaQ6j2KeeIKyEfbNqUu7Q1Ylnz0YL+6czW7yXFJVmzmI+5VTMYH6CJNVgUHeWfq+TlJrWUT0UVgvZlSf7zNelLF+emXRwz9AgNXpkYEDJcGFiyFrY0kZ4paDjbVvoa5G3lLCA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=1qbxvKk+Logi/YXTSn5znvJWC5lMdIkRYvIiqQPPLAg=;
 b=m3pHNLdjUYKN8od1BVXP2sYvNW0EjvxxYsnnX2exBDr0uPHevJ5RjquzcTRbjcVaYs951sAOyqy9mQw4GQKZw3jo0DC2sIJEzQZZ1J+b/f32otQkWBqua6AIweB2AvaWMa9oDqPo6Ev/Pi6TmmG615hyWbsE8CYcfjVGlUr73npIuIHQXiI3v+tuYHKQ9JlE3Ak/T5T5GWKWjfzja0BBlMbr2UbSFtzYwUL+vS0O2AosM03gp4nTq/2jX6ojo00zJHK23MABLJMgKaa/6ztuQkBX99+j+234Rqgpw8VF69mf3yL+k657gP47RReE/HD9rok+ob5570rYT3xzlRay/A==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=1qbxvKk+Logi/YXTSn5znvJWC5lMdIkRYvIiqQPPLAg=;
 b=AatzPx3ighgl3wdcJpWatm9qFmz8oq9FnYIyRMUWNMMfvf4o+dMgPcCc3MU/od3hWDCnJ/k7+Rjc9NOHxdhy4Yj8XHy0cwTCIqzk9pg1EPU6z1zvx1cNM4DIorbooTEfJV2NpykmnUV7S1KrRTfuiI5+/A38Feassc0HOESxX8A=
Received: from MW4PR04CA0234.namprd04.prod.outlook.com (2603:10b6:303:87::29)
 by DM6PR12MB4516.namprd12.prod.outlook.com (2603:10b6:5:2ac::20) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14; Wed, 8 Sep
 2021 15:02:06 +0000
Received: from CO1NAM11FT018.eop-nam11.prod.protection.outlook.com
 (2603:10b6:303:87:cafe::a6) by MW4PR04CA0234.outlook.office365.com
 (2603:10b6:303:87::29) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Wed, 8 Sep 2021 15:02:06 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 CO1NAM11FT018.mail.protection.outlook.com (10.13.175.16) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 15:02:06 +0000
Received: from hr-amd.amd.com (10.180.168.240) by SATLEXMB04.amd.com
 (10.181.40.145) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Wed, 8 Sep 2021
 10:01:57 -0500
From:   Huang Rui <ray.huang@amd.com>
To:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        <linux-pm@vger.kernel.org>
CC:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        <linux-kernel@vger.kernel.org>, <x86@kernel.org>,
        Huang Rui <ray.huang@amd.com>
Subject: [PATCH 19/19] Documentation: amd-pstate: add amd-pstate driver introduction
Date:   Wed, 8 Sep 2021 23:00:01 +0800
Message-ID: <20210908150001.3702552-20-ray.huang@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210908150001.3702552-1-ray.huang@amd.com>
References: <20210908150001.3702552-1-ray.huang@amd.com>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Content-Type: text/plain
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 39f39b53-84bc-46d7-cb8c-08d972d99fd2
X-MS-TrafficTypeDiagnostic: DM6PR12MB4516:
X-Microsoft-Antispam-PRVS: <DM6PR12MB4516E573E65C0FA0A431EDAAECD49@DM6PR12MB4516.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:10000;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 6Wuv09UsijfwBYZjpZq9C39IBUFP6gwWi6fuduTfrTUdSPpJiaVcUU1oTD72NBEo3wVhjDUWPxOznHntCOBY89Tw2A0zDA8OlIKX410qcNstYAVGqA21IocVHV/rQunG+/6gkxe7yPvq++poFVyxQjwpeWR1vsslHNnYTsmYAo7LQEj98UkZ5s8jwJH2TAKh1Y2oeQ7MAaM0OoU8krw3hM6ilbaE2g/2SwCFpEpv7BEg56Z9hZH9mLiiH+ZKdDH2Vtz0OhhdQQzq+TUX7BZ3Pfqol2a6nF1GP9zBrX8hFrWGmDi4/kVTqBsZnJKFCYu5WpWrX/4j/qPXcv9Tq4BylWZNdPuJcs3mTg5kfFyAyx/zv2GNIqLYj+Gno0l5BkLUcSe5XM0K/y2Dp57WnqPbYJjrUzJ+wHj4v+fNVwvZnn/Qs5nH+E7HoSGE/XAtvk4H6M+/nv/utm+wWn0+6oi2vI5FXjid1ca+pcEE0dz3BObN6RW6tamAokieubGOtfKi6Fn59Gj7iIdEt6OCK0ZxF+hFvxDXqP5xqWl66xHW2Be6kBVcpYTu+j8Ips2aKBzB3FmMiQmDT9ESCZ36P+pwc0+AECHreNaD5qimxuLQQcCOKV89jLweL63Np7lDWOID7mryd4Sh0JTHa5uEGtZ6qm3wlpdwv6I1vLghoHebJhhpoJuSDgq7kDrFud1aCwTU9KTMWm6iEfzilRqjPuj34LwUarTmKgbzP+TQldZ35YXq3tq/UAcfBOr9nfwPC7cZkVYo3WNhEs/OFLf/N7tzS2ibIbI0aaQGZ61Y4TOEjg7w+hcfwerDK8Xe+3vhnEdN7anjxa8ok4+io4MSIqF3KhoV5fTCq613PyEWfB7pOU4=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(346002)(39860400002)(376002)(136003)(396003)(46966006)(36840700001)(47076005)(30864003)(6666004)(5660300002)(7696005)(478600001)(186003)(16526019)(966005)(8936002)(110136005)(316002)(54906003)(82740400003)(8676002)(2906002)(336012)(36756003)(86362001)(2616005)(70586007)(70206006)(36860700001)(83380400001)(82310400003)(426003)(81166007)(26005)(356005)(4326008)(1076003)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 15:02:06.2838
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 39f39b53-84bc-46d7-cb8c-08d972d99fd2
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: CO1NAM11FT018.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB4516
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Introduce the amd-pstate driver design and implementation.

Signed-off-by: Huang Rui <ray.huang@amd.com>
---
 Documentation/admin-guide/pm/amd_pstate.rst   | 377 ++++++++++++++++++
 .../admin-guide/pm/working-state.rst          |   1 +
 2 files changed, 378 insertions(+)
 create mode 100644 Documentation/admin-guide/pm/amd_pstate.rst

diff --git a/Documentation/admin-guide/pm/amd_pstate.rst b/Documentation/admin-guide/pm/amd_pstate.rst
new file mode 100644
index 000000000000..c3659dde0cee
--- /dev/null
+++ b/Documentation/admin-guide/pm/amd_pstate.rst
@@ -0,0 +1,377 @@
+.. SPDX-License-Identifier: GPL-2.0
+.. include:: <isonum.txt>
+
+===============================================
+``amd-pstate`` CPU Performance Scaling Driver
+===============================================
+
+:Copyright: |copy| 2021 Advanced Micro Devices, Inc.
+
+:Author: Huang Rui <ray.huang@amd.com>
+
+
+Introduction
+===================
+
+``amd-pstate`` is the AMD CPU performance scaling driver that introduces a
+new CPU frequency control mechanism on modern AMD APU and CPU series in
+Linux kernel. The new mechanism is based on Collaborative Processor
+Performance Control (CPPC) which provides finer grain frequency management
+than legacy ACPI hardware P-States. Current AMD CPU/APU platforms are using
+the ACPI P-states driver to manage CPU frequency and clocks with switching
+only in 3 P-states. CPPC replaces the ACPI P-states controls, allows a
+flexible, low-latency interface for the Linux kernel to directly
+communicate the performance hints to hardware.
+
+``amd-pstate`` leverages the Linux kernel governors such as ``schedutil``,
+``ondemand``, etc. to manage the performance hints which are provided by
+CPPC hardware functionality that internally follows the hardware
+specification (for details refer to AMD64 Architecture Programmer's Manual
+Volume 2: System Programming [1]_). Currently ``amd-pstate`` supports basic
+frequency control function according to kernel governors on some of the
+Zen2 and Zen3 processors, and we will implement more AMD specific functions
+in future after we verify them on the hardware and SBIOS.
+
+
+AMD CPPC Overview
+=======================
+
+Collaborative Processor Performance Control (CPPC) interface enumerates a
+continuous, abstract, and unit-less performance value in a scale that is
+not tied to a specific performance state / frequency. This is an ACPI
+standard [2]_ which software can specify application performance goals and
+hints as a relative target to the infrastructure limits. AMD processors
+provides the low latency register model (MSR) instead of AML code
+interpreter for performance adjustments. ``amd-pstate`` will initialize a
+``struct cpufreq_driver`` instance ``amd_pstate_driver`` with the callbacks
+to manage each performance update behavior. ::
+
+ Highest Perf ------>+-----------------------+                         +-----------------------+
+                     |                       |                         |                       |
+                     |                       |                         |                       |
+                     |                       |          Max Perf  ---->|                       |
+                     |                       |                         |                       |
+                     |                       |                         |                       |
+ Nominal Perf ------>+-----------------------+                         +-----------------------+
+                     |                       |                         |                       |
+                     |                       |                         |                       |
+                     |                       |                         |                       |
+                     |                       |                         |                       |
+                     |                       |                         |                       |
+                     |                       |                         |                       |
+                     |                       |      Desired Perf  ---->|                       |
+                     |                       |                         |                       |
+                     |                       |                         |                       |
+                     |                       |                         |                       |
+                     |                       |                         |                       |
+                     |                       |                         |                       |
+                     |                       |                         |                       |
+                     |                       |                         |                       |
+                     |                       |                         |                       |
+                     |                       |                         |                       |
+  Lowest non-        |                       |                         |                       |
+  linear perf ------>+-----------------------+                         +-----------------------+
+                     |                       |                         |                       |
+                     |                       |       Lowest perf  ---->|                       |
+                     |                       |                         |                       |
+  Lowest perf ------>+-----------------------+                         +-----------------------+
+                     |                       |                         |                       |
+                     |                       |                         |                       |
+                     |                       |                         |                       |
+          0   ------>+-----------------------+                         +-----------------------+
+
+                                     AMD P-States Performance Scale
+
+
+.. _perf_cap:
+
+AMD CPPC Performance Capability
+--------------------------------
+
+Highest Performance (RO)
+.........................
+
+It is the absolute maximum performance an individual processor may reach,
+assuming ideal conditions. This performance level may not be sustainable
+for long durations and may only be achievable if other platform components
+are in a specific state; for example, it may require other processors be in
+an idle state. This would be equivalent to the highest frequencies
+supported by the processor.
+
+Nominal (Guaranteed) Performance (RO)
+......................................
+
+It is the maximum sustained performance level of the processor, assuming
+ideal operating conditions. In absence of an external constraint (power,
+thermal, etc.) this is the performance level the processor is expected to
+be able to maintain continuously. All cores/processors are expected to be
+able to sustain their nominal performance state simultaneously.
+
+Lowest non-linear Performance (RO)
+...................................
+
+It is the lowest performance level at which nonlinear power savings are
+achieved, for example, due to the combined effects of voltage and frequency
+scaling. Above this threshold, lower performance levels should be generally
+more energy efficient than higher performance levels. This register
+effectively conveys the most efficient performance level to ``amd-pstate``.
+
+Lowest Performance (RO)
+........................
+
+It is the absolute lowest performance level of the processor. Selecting a
+performance level lower than the lowest nonlinear performance level may
+cause an efficiency penalty but should reduce the instantaneous power
+consumption of the processor.
+
+AMD CPPC Performance Control
+------------------------------
+
+``amd-pstate`` passes performance goals through these registers. The
+register drives the behavior of the desired performance target.
+
+Minimum requested performance (RW)
+...................................
+
+``amd-pstate`` specifies the minimum allowed performance level.
+
+Maximum requested performance (RW)
+...................................
+
+``amd-pstate`` specifies a limit the maximum performance that is expected
+to be supplied by the hardware.
+
+Desired performance target (RW)
+...................................
+
+``amd-pstate`` specifies a desired target in the CPPC performance scale as
+a relative number. This can be expressed as percentage of nominal
+performance (infrastructure max). Below the nominal sustained performance
+level, desired performance expresses the average performance level of the
+processor subject to hardware. Above the nominal performance level,
+processor must provide at least nominal performance requested and go higher
+if current operating conditions allow.
+
+Energy Performance Preference (EPP) (RW)
+.........................................
+
+Provides a hint to the hardware if software wants to bias toward performance
+(0x0) or energy efficiency (0xff).
+
+
+Key Governors Support
+=======================
+
+``amd-pstate`` can be used with all the (generic) scaling governors listed
+by the ``scaling_available_governors`` policy attribute in ``sysfs``. Then,
+it is responsible for the configuration of policy objects corresponding to
+CPUs and provides the ``CPUFreq`` core (and the scaling governors attached
+to the policy objects) with accurate information on the maximum and minimum
+operating frequencies supported by the hardware. Users can check the
+``scaling_cur_freq`` information comes from the ``CPUFreq`` core.
+
+``amd-pstate`` mainly supports ``schedutil`` and ``ondemand`` for dynamic
+frequency control. It is to fine tune the processor configuration on
+``amd-pstate`` to the ``schedutil`` with CPU CFS scheduler. ``amd-pstate``
+registers adjust_perf callback to implement the CPPC similar performance
+update behavior. It is initialized by ``sugov_start`` and then populate the
+CPU's update_util_data pointer to assign ``sugov_update_single_perf`` as
+the utilization update callback function in CPU scheduler. CPU scheduler
+will call ``cpufreq_update_util`` and assign the target performance
+according to the ``struct sugov_cpu`` that utilization update belongs to.
+Then ``amd-pstate`` updates the desired performance according to the CPU
+scheduler assigned.
+
+
+Processor Support
+=======================
+
+The ``amd-pstate`` initialization will fail if the _CPC in ACPI SBIOS is
+not existed at the detected processor, and it uses ``acpi_cpc_valid`` to
+check the _CPC existence. All Zen based processors support legacy ACPI
+hardware P-States function, so while the ``amd-pstate`` fails to be
+initialized, the kernel will fall back to initialize ``acpi-cpufreq``
+driver.
+
+There are two types of hardware implementations for ``amd-pstate``: one is
+`Full MSR Support <perf_cap_>`_ and another is `Shared Memory Support
+<perf_cap_>`_. It can use :c:macro:`X86_FEATURE_AMD_CPPC_EXT` feature flag
+(for details refer to Processor Programming Reference (PPR) for AMD Family
+19h Model 21h, Revision B0 Processors [3]_) to indicate the different
+types. ``amd-pstate`` is to register different ``amd_pstate_perf_funcs``
+instances for different hardware implementations.
+
+Currently, some of Zen2 and Zen3 processors support ``amd-pstate``. In the
+future, it will be supported on more and more AMD processors.
+
+Full MSR Support
+-----------------
+
+Some new Zen3 processors such as Cezanne provide the MSR registers directly
+while the :c:macro:`X86_FEATURE_AMD_CPPC_EXT` CPU feature flag is set.
+``amd-pstate`` can handle the MSR register to implement the fast switch
+function in ``CPUFreq`` that can shrink latency of frequency control on the
+interrupt context.
+
+Shared Memory Support
+----------------------
+
+If :c:macro:`X86_FEATURE_AMD_CPPC_EXT` CPU feature flag is not set, that
+means the processor supports shared memory solution. In this case,
+``amd-pstate`` uses the ``cppc_acpi`` helper methods to implement the
+callback functions of ``amd_pstate_perf_funcs``.
+
+
+AMD P-States and ACPI hardware P-States always can be supported in one
+processor. But AMD P-States has the higher priority and if it is enabled
+with :c:macro:`MSR_AMD_CPPC_ENABLE` or ``cppc_set_enable``, it will respond
+to the request from AMD P-States.
+
+
+User Space Interface in ``sysfs``
+==================================
+
+``amd-pstate`` exposes several global attributes (files) in ``sysfs`` to
+control its functionality at the system level. They located in the
+``/sys/devices/system/cpu/cpufreq/policyX/`` directory and affect all CPUs. ::
+
+ root@hr-test1:/home/ray# ls /sys/devices/system/cpu/cpufreq/policy0/*amd*
+ /sys/devices/system/cpu/cpufreq/policy0/amd_pstate_highest_perf
+ /sys/devices/system/cpu/cpufreq/policy0/amd_pstate_lowest_nonlinear_freq
+ /sys/devices/system/cpu/cpufreq/policy0/amd_pstate_lowest_nonlinear_perf
+ /sys/devices/system/cpu/cpufreq/policy0/amd_pstate_lowest_perf
+ /sys/devices/system/cpu/cpufreq/policy0/amd_pstate_max_freq
+ /sys/devices/system/cpu/cpufreq/policy0/amd_pstate_min_freq
+ /sys/devices/system/cpu/cpufreq/policy0/amd_pstate_nominal_freq
+ /sys/devices/system/cpu/cpufreq/policy0/amd_pstate_nominal_perf
+ /sys/devices/system/cpu/cpufreq/policy0/is_amd_pstate_enabled
+
+
+``is_amd_pstate_enabled``
+
+Query whether current kernel loads ``amd-pstate`` to enable the AMD
+P-States functionality.
+This attribute is read-only.
+
+``amd_pstate_highest_perf / amd_pstate_max_freq``
+
+Maximum CPPC performance and CPU frequency that the driver is allowed to
+set in percent of the maximum supported CPPC performance level (the highest
+performance supported in `AMD CPPC Performance Capability <perf_cap_>`_).
+This attribute is read-only.
+
+``amd_pstate_nominal_perf / amd_pstate_nominal_freq``
+
+Nominal CPPC performance and CPU frequency that the driver is allowed to
+set in percent of the maximum supported CPPC performance level (Please see
+nominal performance in `AMD CPPC Performance Capability <perf_cap_>`_).
+This attribute is read-only.
+
+``amd_pstate_lowest_nonlinear_perf / amd_pstate_lowest_nonlinear_freq``
+
+The lowest non-linear CPPC performance and CPU frequency that the driver is
+allowed to set in percent of the maximum supported CPPC performance level
+(Please see the lowest non-linear performance in `AMD CPPC Performance
+Capability <perf_cap_>`_).
+This attribute is read-only.
+
+``amd_pstate_lowest_perf / amd_pstate_min_freq``
+
+The lowest physical CPPC performance and CPU frequency.
+This attribute is read-only.
+
+
+``amd-pstate`` vs ``acpi-cpufreq``
+======================================
+
+On majority of AMD platforms supported by ``acpi-cpufreq``, the ACPI tables
+provided by the platform firmware used for CPU performance scaling, but
+only provides 3 P-states on AMD processors.
+However, on modern AMD APU and CPU series, it provides the collaborative
+processor performance control according to ACPI protocol and customize this
+for AMD platforms. That is fine-grain and continuous frequency range
+instead of the legacy hardware P-states. ``amd-pstate`` is the kernel
+module which supports the new AMD P-States mechanism on most of future AMD
+platforms. The AMD P-States mechanism will be the more performance and energy
+efficiency frequency management method on AMD processors.
+
+``cpupower`` tool support for ``amd-pstate``
+===============================================
+
+``amd-pstate`` is supported on ``cpupower`` tool that can be used to dump the frequency
+information. And it is in progress to support more and more operations for new
+``amd-pstate`` module with this tool. ::
+
+ root@hr-test1:/home/ray# cpupower frequency-info
+ analyzing CPU 0:
+   driver: amd-pstate
+   CPUs which run at the same hardware frequency: 0
+   CPUs which need to have their frequency coordinated by software: 0
+   maximum transition latency: 131 us
+   hardware limits: 400 MHz - 4.68 GHz
+   available cpufreq governors: ondemand conservative powersave userspace performance schedutil
+   current policy: frequency should be within 400 MHz and 4.68 GHz.
+                   The governor "schedutil" may decide which speed to use
+                   within this range.
+   current CPU frequency: Unable to call hardware
+   current CPU frequency: 4.02 GHz (asserted by call to kernel)
+   boost state support:
+     Supported: yes
+     Active: yes
+     AMD PSTATE Highest Performance: 166. Maximum Frequency: 4.68 GHz.
+     AMD PSTATE Nominal Performance: 117. Nominal Frequency: 3.30 GHz.
+     AMD PSTATE Lowest Non-linear Performance: 39. Lowest Non-linear Frequency: 1.10 GHz.
+     AMD PSTATE Lowest Performance: 15. Lowest Frequency: 400 MHz.
+
+
+Diagnostics and Tuning
+=======================
+
+Trace Events
+--------------
+
+There are two static trace events that can be used for ``amd-pstate``
+diagnostics.  One of them is the cpu_frequency trace event generally used
+by ``CPUFreq``, and the other one is the ``amd_pstate_perf`` trace event
+specific to ``amd-pstate``.  The following sequence of shell commands can
+be used to enable them and see their output (if the kernel is generally
+configured to support event tracing). ::
+
+ root@hr-test1:/home/ray# cd /sys/kernel/tracing/
+ root@hr-test1:/sys/kernel/tracing# echo 1 > events/amd_cpu/enable
+ root@hr-test1:/sys/kernel/tracing# cat trace
+ # tracer: nop
+ #
+ # entries-in-buffer/entries-written: 47827/42233061   #P:2
+ #
+ #                                _-----=> irqs-off
+ #                               / _----=> need-resched
+ #                              | / _---=> hardirq/softirq
+ #                              || / _--=> preempt-depth
+ #                              ||| /     delay
+ #           TASK-PID     CPU#  ||||   TIMESTAMP  FUNCTION
+ #              | |         |   ||||      |         |
+           <idle>-0       [000] d.s. 244057.464842: amd_pstate_perf: amd_min_perf=39 amd_des_perf=39 amd_max_perf=166 cpu_id=0 prev=0x2727a6 value=0x2727a6
+           <idle>-0       [000] d.h. 244057.475436: amd_pstate_perf: amd_min_perf=39 amd_des_perf=39 amd_max_perf=166 cpu_id=0 prev=0x2727a6 value=0x2727a6
+           <idle>-0       [000] d.h. 244057.476629: amd_pstate_perf: amd_min_perf=39 amd_des_perf=39 amd_max_perf=166 cpu_id=0 prev=0x2727a6 value=0x2727a6
+           <idle>-0       [000] d.s. 244057.484847: amd_pstate_perf: amd_min_perf=39 amd_des_perf=39 amd_max_perf=166 cpu_id=0 prev=0x2727a6 value=0x2727a6
+           <idle>-0       [000] d.h. 244057.499821: amd_pstate_perf: amd_min_perf=39 amd_des_perf=39 amd_max_perf=166 cpu_id=0 prev=0x2727a6 value=0x2727a6
+     avahi-daemon-528     [000] d... 244057.513568: amd_pstate_perf: amd_min_perf=39 amd_des_perf=39 amd_max_perf=166 cpu_id=0 prev=0x2727a6 value=0x2727a6
+
+The cpu_frequency trace event will be triggered either by the ``schedutil`` scaling
+governor (for the policies it is attached to), or by the ``CPUFreq`` core (for the
+policies with other scaling governors).
+
+
+Reference
+===========
+
+.. [1] AMD64 Architecture Programmer's Manual Volume 2: System Programming,
+       https://www.amd.com/system/files/TechDocs/24593.pdf
+
+.. [2] Advanced Configuration and Power Interface Specification,
+       https://uefi.org/sites/default/files/resources/ACPI_Spec_6_4_Jan22.pdf
+
+.. [3] Processor Programming Reference (PPR) for AMD Family 19h Model 21h, Revision B0 Processors
+       https://www.amd.com/system/files/TechDocs/55898_B1_pub_0.50.zip
+
diff --git a/Documentation/admin-guide/pm/working-state.rst b/Documentation/admin-guide/pm/working-state.rst
index f40994c422dc..28db6156b55d 100644
--- a/Documentation/admin-guide/pm/working-state.rst
+++ b/Documentation/admin-guide/pm/working-state.rst
@@ -11,6 +11,7 @@ Working-State Power Management
    intel_idle
    cpufreq
    intel_pstate
+   amd_pstate
    cpufreq_drivers
    intel_epb
    intel-speed-select
-- 
2.25.1


From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-19.2 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,MSGID_FROM_MTA_HEADER,NICE_REPLY_A,
	SPF_HELO_NONE,SPF_PASS,USER_AGENT_SANE_1 autolearn=unavailable
	autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id B857AC433F5
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 17:32:43 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id A3E8F61153
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 17:32:43 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S243885AbhIHRdu (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 13:33:50 -0400
Received: from mail-mw2nam10on2059.outbound.protection.outlook.com ([40.107.94.59]:2422
        "EHLO NAM10-MW2-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S230091AbhIHRds (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 13:33:48 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=UPSyaPBk5zjlFlF0TDNLTIB18E8fZXsnCbkp5pc3xejR3R3cgdb0zUybN1vjVyVCPhNuGHINfmNr+/s69afpIg9cE/LYK90G3hIW1aGT3QElXaVy4CsUGqvvAr3O+F5JFdhSmQr4odaW/T83n3Vaw5kXwaOkfwgSMSpQIiyueRA7DbHP9e8nV4oIxGyv7j6rWEWxe3KZAUwWr7pYkEILOdZBWuplL8jY1FZFmYVGr5ud0cwOaX/LXPYYRgYzcQeuFG8zpUqUW1iuaA7P49W6sodUH3I8nEB3eEaJqaHZs/EU8YZ8lcbkHtBltjztUVdrfx+jkQkS1WrP7DQiX+5Klw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=A4+gnsMzF1FJ28K6HQwxm+Rr+RovIv3vRB4626zrPas=;
 b=eWd/WJI810EabEI1++hRYO7qnZmzvr9Ra9PW6SPPVnmaHbk1HIwFdGIDvTO9u40Gy2d45meaohsZBDFzyH6As5HBCcgwqZ+2hDLXQFCX2WoW6cuXanNpUeubcjOs0GDdIq9x2Iw+5uQF3bWMPMBhcLzHegl9n+VxiUkROWpVw39YVXgIP+2osEZ/pt3SMbFfFAB8APkUux8gsm1MuVrDojan0zQ/cqIOCGtuvvV6yvph6W7iGeHt1ugATFWOBssTJM8Y3mMe43BVe59zlDJhoFTdXROdvw5uyqBOlb6yKrf51p3MmGd0hY1aonk+1rZ3aXMoQNY4er1lZRdh6GS5Pg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=A4+gnsMzF1FJ28K6HQwxm+Rr+RovIv3vRB4626zrPas=;
 b=y1be77GuY6DZzMIUPA/QSQbvUk0EyxYLb+4Lh7zE+8BOVzn2I3dwF75Tc2dpgCfG104RtH/vHgzMjCNRC1A2F7or3+vPg7ZFi4fBlVpE9BY5M1yJzfhUjuXFIk/tPVKso0xm3Gzso7ZT4vmz5OIK3M1FlACLJjfRDFjh02MstZg=
Authentication-Results: kernel.org; dkim=none (message not signed)
 header.d=none;kernel.org; dmarc=none action=none header.from=amd.com;
Received: from SN6PR12MB4720.namprd12.prod.outlook.com (2603:10b6:805:e6::31)
 by SN1PR12MB2480.namprd12.prod.outlook.com (2603:10b6:802:22::21) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4478.21; Wed, 8 Sep
 2021 17:32:39 +0000
Received: from SN6PR12MB4720.namprd12.prod.outlook.com
 ([fe80::e134:658f:3a82:f750]) by SN6PR12MB4720.namprd12.prod.outlook.com
 ([fe80::e134:658f:3a82:f750%4]) with mapi id 15.20.4478.026; Wed, 8 Sep 2021
 17:32:39 +0000
Subject: Re: [PATCH 16/19] cpupower: enable boost state support for amd-pstate
 module
To:     Huang Rui <ray.huang@amd.com>,
        "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        Borislav Petkov <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        linux-pm@vger.kernel.org
Cc:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        linux-kernel@vger.kernel.org, x86@kernel.org
References: <20210908150001.3702552-1-ray.huang@amd.com>
 <20210908150001.3702552-17-ray.huang@amd.com>
From:   "Fontenot, Nathan" <Nathan.Fontenot@amd.com>
Message-ID: <5353e053-084d-9a29-bae5-c1e1d597d1e3@amd.com>
Date:   Wed, 8 Sep 2021 12:32:37 -0500
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:78.0) Gecko/20100101
 Thunderbird/78.13.0
In-Reply-To: <20210908150001.3702552-17-ray.huang@amd.com>
Content-Type: text/plain; charset=utf-8
Content-Language: en-US
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: SA0PR11CA0076.namprd11.prod.outlook.com
 (2603:10b6:806:d2::21) To SN6PR12MB4720.namprd12.prod.outlook.com
 (2603:10b6:805:e6::31)
MIME-Version: 1.0
Received: from [IPv6:2600:1700:271:b60:39a5:4135:fa07:41fb] (2600:1700:271:b60:39a5:4135:fa07:41fb) by SA0PR11CA0076.namprd11.prod.outlook.com (2603:10b6:806:d2::21) with Microsoft SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 17:32:38 +0000
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 0a124219-5d51-4254-669e-08d972eea78b
X-MS-TrafficTypeDiagnostic: SN1PR12MB2480:
X-MS-Exchange-Transport-Forked: True
X-Microsoft-Antispam-PRVS: <SN1PR12MB24803574416754D5B8DF55A2ECD49@SN1PR12MB2480.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:2331;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: UCNHyt41YAh0CyNDdXmP1icuFgp9OTAwFlFA27+aB4PJoHCtiEpKLyaxIH1WRBT5w62YbVmcwDXN9bLTuk0fjGfr2MInHpxRCM+KA9whrZhmuxQp97AFuJh0ltBmvs0LDFdShfLrip68QR5P086qTYJBI8pKniiBexIEYJKl4SOr9sZo9FIchZjXg4gvhOHYYy9hHszZ1+JrOgy0iUV1vXVeT83ahviowH0EWW21GW8nVE6H4gPWsbHng4y0QhQNM2PDloIYiu8Qha76RfDXMjQ2r1rDY667m0bvfqHsssUBQ4vozR6kd5MfbTNyc93WfTGC3RLK0eNBFafEWaOFeIwnTheutIFvZpuFuaWD18Q3QgP4EQLz6D5R42dAyHQaDODmSUAywMtFIy5GJc5mcBAlZ8nWdEk/5ywN3go8M8PY+x4LeIhwUhi3sRP6I4QqE41tLwWJca/iiqVXrIhhxP86pTi8NWuf9hAGnUcoXc9W+I33j391OTeLxbRE7TAweBlUudX84mYBeMtyTVIxymlN0sSC5Sc3kPR+Hqhbs1U9RO4z90kCEiptfagV0xG+xivCsbAtj0EuyHEBsWNvmE0EEesKzKmjSgjM11kkCkciBWaysvKZ/80JaHFmLNxFzQmHc4J6ktw8qXqCEbOh9Ln1ofmJC6pXsFZ5lV/9CWwBsLp2wq9Z5rdA8VkT/PMRPtL+edZgQnw/p1v0bGm/G6ikb5vLqihdaaWn8bFJ/m8=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:SN6PR12MB4720.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(4636009)(396003)(366004)(136003)(376002)(39860400002)(346002)(8676002)(31696002)(478600001)(110136005)(53546011)(54906003)(86362001)(31686004)(2616005)(38100700002)(186003)(5660300002)(8936002)(36756003)(2906002)(6486002)(316002)(4326008)(66946007)(66476007)(66556008)(43740500002)(45980500001);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?utf-8?B?OWx3bU1BL0xoVjVJUzFlOEF1bmY5b3FaV1NkcTVzRUlra1habzA5dytvUnlU?=
 =?utf-8?B?aTNYWjNWYmFVM29Ma3VtZmI1QTRzeEdVTldaR2RnaUw4TnlKUk9nOTU3aTl6?=
 =?utf-8?B?blZqL1d0U3FadEFHRG94L1dMcDhiaEMzaXNOcENIREIvMllRWXh5L3dCVGdH?=
 =?utf-8?B?TjVQcEtoc2tVTlVHeCsrWFZWeUxPTHlBZ3IrZ2Vtb0VHQ0VaemIrdFNSc1Fw?=
 =?utf-8?B?Y3BPdHg4cEVhK0doZThucmFGNEJVSHF4aGVLai9HTnJ1NkFNbGRma1A1RDgr?=
 =?utf-8?B?aVVIZWtkdTFkVzFIRUVVT0YwZUNZTThrcENTL2E0NHVoekRnOWJRZ1hRU250?=
 =?utf-8?B?MlkxSFlmYlE5SGdqSnhYaDZ4WDhYd25hRUg3OXNSQzB0cG56S2NZTVZPVXRK?=
 =?utf-8?B?cEFSb0ptRXNJU0pYbzFyOTQwajU4T3c1bFRSZHBIaFVMY29QWVlkeUQ3Zm53?=
 =?utf-8?B?TS8raXh5ZlVhWlF5Q2R0bnZJUDd1d1V6cGZPNnN5VGduYUpvRlprRENTVEZK?=
 =?utf-8?B?VGNqSDJFUGVvVUZvdERURUVQOHh4WDNSQVF3ZXFvbWZ3dXdXc01WcEIyTHBI?=
 =?utf-8?B?Z1MzWHgwMTBCc3pnUDdjek5iUEhoZ0hac202Rmd0ekZTbUsvR1JnQkNWTEdl?=
 =?utf-8?B?dlBpdFpVQUZ5NkpyWDZSNHhqd1lyTTBzWjA3L1JMQWtFdVhKRjZ4Tzdoc09V?=
 =?utf-8?B?dzVaS1FIOUFoVWszQzRYSGZkam91elZBMlZtd0F6ZE5tWldmVXRTdUlRM0Yr?=
 =?utf-8?B?K2hUTW1rNVE1M20xYjNaeGlBblVCejZCWis1Y2o5VzVWbEdhWHpqUkpYTjBX?=
 =?utf-8?B?SktLL1cwQ2NnTlRodnd0Q1ExNUFwK1YvT2l4YmtMYTZSbWw3bjUzOUlWc2dy?=
 =?utf-8?B?bnhWT3JXRXlhOFJpcU96TzcwaFh3eE1Pbysxb3BUSzBJTFRGcHhvZ0tUMklL?=
 =?utf-8?B?TCtRaXFxS3V6ZVpMYWdoZS82TmRqeEVuNzVlQWpYVE84SEI1eVJzdVN0eloy?=
 =?utf-8?B?K2FJRnUrdk91QmZROThGVGtadDBDbWpHR3hUSXZUSVZuRmxJd2tEVm5GWWkx?=
 =?utf-8?B?NDhyaGFGWnVxTE5hVWtFaVR5NnBTbWk1Sy9yR1BRQkI2dC9qQjJyMUdUK1RD?=
 =?utf-8?B?MlFEMUthOVMwVU1pQWNZNlVyazNXQUhPUVpDdVl1VlJaVk5LNDBNZXUxRHlX?=
 =?utf-8?B?WmtzdHE2ZEsraEV5S3Y1N0xMNUh6bm1hZHloamhOR3hzcVBTWTVDVlpFaFcy?=
 =?utf-8?B?RTF4V2NaYU1MZlZ6WFh2REI2TDNyUGlLc0VBbkxBZ0RwUkpnRmpkeVAyUmdP?=
 =?utf-8?B?NUJLMCszTWR1ckhUSkg1NFkwa24yUW5XMm9mY1ZBNTR5b0E5WGppYXpjcWpD?=
 =?utf-8?B?Tmt5cjdzbWp5YVhVbE00TTk5TjNFSjU5dWdKUzZqQStrWW8rVC8zOEREYkly?=
 =?utf-8?B?SGhYdGw4YXBxOEtVNGY5ZzJlTitRdW4wZlUvM3BrSTExK1RDL3RlVFM3Q2VQ?=
 =?utf-8?B?cXpBcUJ4Y29BejgvTnZJYzFIVG1vazlZczdLRGV2SEJYU1N0VGF1a1JncmFH?=
 =?utf-8?B?QnorTVVueDRidWR3QXlJaWdKUk91NStNYUNzeGQ2WUtneHQ2eW5PVmQvWXhG?=
 =?utf-8?B?QnFsSXl5Q3F2TXBiMDV2emtOam9KK3dzZmt5cU0rZFJyL0l1b1ZZc25hQVZz?=
 =?utf-8?B?VUkrTWdCQ0JjcU1WT0FSbmdaWnlNV1E2ZS9NendQRlVYVWhrS1BoUkF5Z21G?=
 =?utf-8?B?U2dCa0l1S3BrMVQweVlKbkJUanM2R3FuSGVsQ0RQUE4zdTVlMGNJZldOc3or?=
 =?utf-8?B?Vkw5cTd1b1dSdFEzaWdGK1VVdTVJVXk4VlhFTzZ2N0w3UFkzM3d1TmMzaHg2?=
 =?utf-8?Q?LBfAKwpdNQ5Oj?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 0a124219-5d51-4254-669e-08d972eea78b
X-MS-Exchange-CrossTenant-AuthSource: SN6PR12MB4720.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 17:32:39.0518
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: apPUYmuHcL2hb12VGV2vd9gKVfgpKjkIq6onJ/wWWb1HoXvskBAtuWrJEMBVNuugtmlh7sAqxChUUT/Zf8fUkQ==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SN1PR12MB2480
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On 9/8/2021 9:59 AM, Huang Rui wrote:
> The AMD P-state boost API is different from ACPI hardware P-states, so
> implement the support for amd-pstate kernel module.
> 
> Signed-off-by: Huang Rui <ray.huang@amd.com>
> ---
>  tools/power/cpupower/lib/cpufreq.c        | 20 ++++++++++++++++++++
>  tools/power/cpupower/lib/cpufreq.h        |  3 +++
>  tools/power/cpupower/utils/helpers/misc.c |  7 +++++++
>  3 files changed, 30 insertions(+)
> 
> diff --git a/tools/power/cpupower/lib/cpufreq.c b/tools/power/cpupower/lib/cpufreq.c
> index 3f92ddadaad2..37da87bdcfb1 100644
> --- a/tools/power/cpupower/lib/cpufreq.c
> +++ b/tools/power/cpupower/lib/cpufreq.c
> @@ -790,3 +790,23 @@ unsigned long cpufreq_get_transitions(unsigned int cpu)
>  {
>  	return sysfs_cpufreq_get_one_value(cpu, STATS_NUM_TRANSITIONS);
>  }
> +
> +int amd_pstate_boost_support(unsigned int cpu)
> +{
> +	unsigned int highest_perf, nominal_perf;
> +
> +	highest_perf = sysfs_cpufreq_get_one_value(cpu, AMD_PSTATE_HIGHEST_PERF);
> +	nominal_perf = sysfs_cpufreq_get_one_value(cpu, AMD_PSTATE_NOMINAL_PERF);
> +
> +	return highest_perf > nominal_perf ? 1 : 0;
> +}
> +
> +int amd_pstate_boost_enabled(unsigned int cpu)
> +{
> +	unsigned int cpuinfo_max, amd_pstate_max;
> +
> +	cpuinfo_max = sysfs_cpufreq_get_one_value(cpu, CPUINFO_MAX_FREQ);
> +	amd_pstate_max = sysfs_cpufreq_get_one_value(cpu, AMD_PSTATE_MAX_FREQ);
> +
> +	return cpuinfo_max == amd_pstate_max ? 1 : 0;
> +}
> diff --git a/tools/power/cpupower/lib/cpufreq.h b/tools/power/cpupower/lib/cpufreq.h
> index 95f4fd9e2656..d54d02a7a4f4 100644
> --- a/tools/power/cpupower/lib/cpufreq.h
> +++ b/tools/power/cpupower/lib/cpufreq.h
> @@ -203,6 +203,9 @@ int cpufreq_modify_policy_governor(unsigned int cpu, char *governor);
>  int cpufreq_set_frequency(unsigned int cpu,
>  				unsigned long target_frequency);
>  
> +int amd_pstate_boost_support(unsigned int cpu);
> +int amd_pstate_boost_enabled(unsigned int cpu);
> +
>  #ifdef __cplusplus
>  }
>  #endif
> diff --git a/tools/power/cpupower/utils/helpers/misc.c b/tools/power/cpupower/utils/helpers/misc.c
> index 07d80775fb68..aba979320760 100644
> --- a/tools/power/cpupower/utils/helpers/misc.c
> +++ b/tools/power/cpupower/utils/helpers/misc.c
> @@ -10,6 +10,7 @@
>  #if defined(__i386__) || defined(__x86_64__)
>  
>  #include "cpupower_intern.h"
> +#include "cpufreq.h"
>  
>  #define MSR_AMD_HWCR	0xc0010015
>  
> @@ -39,6 +40,12 @@ int cpufreq_has_boost_support(unsigned int cpu, int *support, int *active,
>  			if (ret)
>  				return ret;
>  		}
> +	} if ((cpupower_cpu_info.caps & CPUPOWER_CAP_AMD_PSTATE) &&

Shouldn't this be

	} else if ((cpupower_cpu_info.caps & CPUPOWER_CAP_AMD_PSTATE) &&

-Nathan

> +	      amd_pstate_boost_support(cpu)) {
> +		*support = 1;
> +
> +		if (amd_pstate_boost_enabled(cpu))
> +			*active = 1;
>  	} else if (cpupower_cpu_info.caps & CPUPOWER_CAP_INTEL_IDA)
>  		*support = *active = 1;
>  	return 0;
> -- 
> 2.25.1
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-16.4 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,MSGID_FROM_MTA_HEADER,NICE_REPLY_A,
	SPF_HELO_NONE,SPF_PASS,UNWANTED_LANGUAGE_BODY,USER_AGENT_SANE_1
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 87B35C433EF
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 18:13:54 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 71B6961100
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 18:13:54 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1349076AbhIHSPA (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 14:15:00 -0400
Received: from mail-dm6nam12on2041.outbound.protection.outlook.com ([40.107.243.41]:44256
        "EHLO NAM12-DM6-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S245528AbhIHSOz (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 14:14:55 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=F/rSi7+YWLrXFrt8mBXn0ztScFbZWcKfcNQgAcTxlTeo61xVtE3IITG7ea6RPiPjj7LRU3tvHmN1nr5SAe4L3Hn5w7zeDofwHk5bAMDntp8C5RXwa05pLdCA9YNuBX0Cznol3v2w0FyqQzTQAtQqDb5EMVN/8sUM3f0Wpry01kNt8GubobqmWHWaOij+mPLForItluuH/A+jy9DlSYUUkLwzT/BlAcaRHJpnuiuGmupQvwA4EkNLT6T6Wjk/NSJ0XsWi/SMop6ZeVeNIvzFqgbtSJYfK0E1Syx+gEPmUeQAOA1eWNFP7zDaF/JGh793N1KdqxBU6/OYJD6W9T4XQ6Q==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=3G4WvZzRmpGNP/MzQjRdmuUHKXbWm6dhUH0N8JUTb0k=;
 b=QcyIWOgaqXz56fGvkeah6ivQm82Q0QSPyr7cUxhcJHzVFB/uS0+T1BWihlSjZ0Zp6xF9khLuF/3RKQ34I+liz1Ba72aHEpkI4EVUUrXHVeVjceR9Qvv611DH6QLPrFAp0suR2IpuYQXLxbBNPkopYzIAD3wS1K/KDQlQMdeADi8l6HI79XfMkW/RFsaUGuDak9bamZ+xc3n+8+cAfQiu+oMyvpQJx+jdDbJXpWmfaliDWFzExPxO/epN45iUnqRkG3CUPDeiLOdB+O51oUxTe2C/t1wGLt3k2kOTe6zn1iAR9AWmokyPj24fGWr2V51BP5QlKQqnORqWl6vI0+Sc1g==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=3G4WvZzRmpGNP/MzQjRdmuUHKXbWm6dhUH0N8JUTb0k=;
 b=OcZEIr6Q1NzHDfhfbZ260qT1Jk+UTTL4R9DjsDtxdxfZVHsAuIjlkdJm6jdZcoAiYCJ1AGu8cf2E7qU4DgRnDVo3JCUfxO9A+S+oy9u+Py6FoT7Lm+4/Sb2lxNJwKMwgO3kT09/c5WRpyVz0zuv+LMakSCPUDzXWQMHhNyC7Rgg=
Authentication-Results: kernel.org; dkim=none (message not signed)
 header.d=none;kernel.org; dmarc=none action=none header.from=amd.com;
Received: from SN6PR12MB4720.namprd12.prod.outlook.com (2603:10b6:805:e6::31)
 by SA0PR12MB4368.namprd12.prod.outlook.com (2603:10b6:806:9f::21) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4478.19; Wed, 8 Sep
 2021 18:13:45 +0000
Received: from SN6PR12MB4720.namprd12.prod.outlook.com
 ([fe80::e134:658f:3a82:f750]) by SN6PR12MB4720.namprd12.prod.outlook.com
 ([fe80::e134:658f:3a82:f750%4]) with mapi id 15.20.4478.026; Wed, 8 Sep 2021
 18:13:45 +0000
Subject: Re: [PATCH 10/19] cpufreq: amd: add amd-pstate frequencies attributes
To:     Huang Rui <ray.huang@amd.com>,
        "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        Borislav Petkov <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        linux-pm@vger.kernel.org
Cc:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        linux-kernel@vger.kernel.org, x86@kernel.org
References: <20210908150001.3702552-1-ray.huang@amd.com>
 <20210908150001.3702552-11-ray.huang@amd.com>
From:   "Fontenot, Nathan" <Nathan.Fontenot@amd.com>
Message-ID: <25cbd9b4-f7f3-9b84-096a-5b2bffbd3e40@amd.com>
Date:   Wed, 8 Sep 2021 13:13:41 -0500
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:78.0) Gecko/20100101
 Thunderbird/78.13.0
In-Reply-To: <20210908150001.3702552-11-ray.huang@amd.com>
Content-Type: text/plain; charset=utf-8
Content-Language: en-US
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: SA9PR13CA0073.namprd13.prod.outlook.com
 (2603:10b6:806:23::18) To SN6PR12MB4720.namprd12.prod.outlook.com
 (2603:10b6:805:e6::31)
MIME-Version: 1.0
Received: from [172.31.130.72] (165.204.78.25) by SA9PR13CA0073.namprd13.prod.outlook.com (2603:10b6:806:23::18) with Microsoft SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4523.8 via Frontend Transport; Wed, 8 Sep 2021 18:13:43 +0000
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 30b21a9e-e9ba-45fa-ed61-08d972f465c6
X-MS-TrafficTypeDiagnostic: SA0PR12MB4368:
X-MS-Exchange-Transport-Forked: True
X-Microsoft-Antispam-PRVS: <SA0PR12MB4368236FD1FABC2AC698EBBCECD49@SA0PR12MB4368.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:612;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: WCs0MtD0Du5zhcJINBrl8jsr+nerfSFqjhubm2BXL6yn9zuSPLma/XeybiFdYHVmazidiI2lNyCgZyDUC0DkIRHWvhWU8XChZfnlt8RHA36s/prt4p1W/SCDs3OGZh80WdTz0CRl+8stsrMRQ5V0P6leVvxXPyaPQOni3Dos8UyLof0ZPu2kJ1tK+DWWyx/2gydVar1BQDk8TdWeDvDeiRy2QlZ10lYxj/80QXpYO2jMZrG6HN4FTx/Ilbsbwovf6g6hhK6M7xSuzGFS4bMRfR9WVgJbimpBJK9Lu65rTv3o9paYUD9k8UYn4ANpDk6Zj7ibup6Iqcpv/ulsXE1zaETFSD3ZGEYZZcp2i648T23g+xLgXYXZzIxNGjXFpqADjOlkz8JRd4OelotPG8zE5AYw17aTLwigJ+Bzf5YkNPJPYGpk6tp676DiCeky/hZhBmqaWjhVd7OK8yBIHLQ4+VIkPma5eKVRyRXYE46d1Lz7FWm8JVOFvzKU8K5+Vj9qfCaJn1fLlK8eibP1utxpAh4wTcey/3DBm1dL0HGVvylq7cjwWY93jXWTqHgJ1Z6jJR4CTrNYYuv8XTYqG2z25KNphc0R6ec9AYlUY1UdKr+rUiPFjXLIWhGBEygYs3V7gF9ynWQ8G4h90FTJLe2STXRqphYbQ6PI7HE2YC6jJzkETSPm4us108nRHlUvkUg4INfxrsx5yFAaOIjZYmOXUsfTERou8LMyv4jg6a9DwcY=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:SN6PR12MB4720.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(4636009)(376002)(346002)(396003)(136003)(366004)(39860400002)(38100700002)(6486002)(31686004)(478600001)(66946007)(31696002)(8936002)(4326008)(2906002)(66556008)(66476007)(54906003)(26005)(186003)(110136005)(53546011)(36756003)(5660300002)(316002)(2616005)(16576012)(8676002)(83380400001)(86362001)(956004)(43740500002)(45980500001);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?utf-8?B?SzcydHRmbjdJNVZZTUdBdHlXSU5BZ3dtL29uVnVQVHFZVVp0U3B6RGgyQk8y?=
 =?utf-8?B?WUxaOUtTQUVuRzlrWmNCdmR2emtXeVVxeEZGMnB2TVZGemh0MHM4U1NOakRE?=
 =?utf-8?B?ZU1YVmdDWlVmL2pBRmk5SjNGUGdkQ3A0YVJmVkFYWm5iUE5EUHJlclF6Z1Az?=
 =?utf-8?B?Qk1wdkc1MWxzcml6aGRsNCt1WUJEMWthNzB0ZEpqRXB3bEdEbG1oMkQwU3lk?=
 =?utf-8?B?cWZVa1puUEticEl3c0VOOGZDYjZaQXFwSlJjTEdTTTJ3WTlKZlI3QUZTOFlX?=
 =?utf-8?B?MEVycTBIayt5QjdJaVR5dTNIQWk0NDJ2Ym1sOVl2TkdINzd6N0d5VzdYVytG?=
 =?utf-8?B?eUEvQmdkYVdDYWRxYjZCRXA0cXRzeGpCbGtDdk9oRWMxalc1SDUyWFFQS2pv?=
 =?utf-8?B?UzczWkhqREhWbGhTQXNydS92dDBWdHhRTzlyZkZLWDJtZXFoZ200OVJjYzRX?=
 =?utf-8?B?a0VhQUhkVEVMb1BZNGRaSVU0ZnlqdWZ0eGdWc3NkSHB4ODF4R1VFY2l4K3h5?=
 =?utf-8?B?RGx4VTFGYlhLbXM1Z0NDN0ZQaFVnemJJbU1ZbUpWN1orMWlZVUZlUUVQbWkv?=
 =?utf-8?B?SWZKcWhpN2NQMWdUVktMWWFxSXpwSGtUOU9ycDZZMEJzMGcxcDJwS0FpZFl6?=
 =?utf-8?B?blorRVlmUVhRMUFUZVpPa0Mwb2t4Skl6VURVenZnNlFMcTl6V0NWVDJEREJz?=
 =?utf-8?B?Mlc3cTdUQnRiWXI3RnloN1JicFJFd2NyUDMzNDNjRkd0WVdUUFpqN1ZEd0FU?=
 =?utf-8?B?bGorNTVFVU5EdS9OMGFuV2Uyd3NnaHZxWnB4a1JYY2szTkdQc3AxcFU4UE5i?=
 =?utf-8?B?dk9CM1lJQWhNTS9teXZzdHBERVY0UkxFeXlPSEtUQUxPeWxndUR2eVhWQitq?=
 =?utf-8?B?dm9zdUszbjNrSGc4aFJZT2FUSXVFRkdkSytmL1hYeU91ZGpBdTl5NkdvWkdI?=
 =?utf-8?B?bDRkVTR6QTczY2ZCRlpmelphRVBwQnJwaWF6MktmZVRWcWdFMldGbHZ0cWww?=
 =?utf-8?B?eXpwSjV4NlRKSGZ0djQ4dm9qUlEwbHNUVHFIQW9lWnFJMnJmN1ArWThIdDFE?=
 =?utf-8?B?bnZKTTErSUJLeHEzZDVUVlluZHo0RTRLcDBieHZjUkgwR2Vvby8vWWxBQS9F?=
 =?utf-8?B?VTdzMVhuQWdEUFpFZVRtTHJGUFhaS09RdGxpelpOeW1SYk1pNzdzdCtMNExT?=
 =?utf-8?B?N3V3S056OTh5U0N1QUxUdHl0QUFCY3dZdHpRTzhUSStPdmMwaUw1dUVaZUZ3?=
 =?utf-8?B?RVNqODZqbENjVnplSzNiNW5WY241L2tFU3VWL2FkMm1sQUc0d01EL3RVcHJG?=
 =?utf-8?B?LzhGS1gwU0JwMEFFTmlqNGc0eXYxd1pCZWd1bkpQZ2J3NkpQb2NTV0ZKL2dr?=
 =?utf-8?B?aHBRL0F6Mk12eGU5NHgvdUhkMSs1dVloZE9HeXFobXh5ZnUrd3dOMlAxODc5?=
 =?utf-8?B?VFFqSlQ0UWtGQjlmU1ZVSmdLUFZVMEw5a1Q5QStBb1RZWC8wYWxWdkZhbEJ1?=
 =?utf-8?B?T2RDMVJEdHNFOFFMc2owcHZpUEdmdjF0WmZUZUQ2c2VZTG1aSUlwVzA5RGgy?=
 =?utf-8?B?RHhIVWFvVTdlWitkUHROOEc5VjEwL2MwVnlQUTFNU29hS2t3N0JQU0l4Z2FT?=
 =?utf-8?B?bGlXRVBPN0ZqQnhRc1ZNVjZDZmhsU3MyRm9rck1XRmJYaGRoME5nK1FJWEt0?=
 =?utf-8?B?VUxoQzBRbkxPUk8wVklGRDMyY2pXYXpISzZmb1crWGIyOTliVVNvU1JVL05k?=
 =?utf-8?Q?PIsr1Q+VPbOJ22xfULws1mkSVykbjan74Dm+ba0?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 30b21a9e-e9ba-45fa-ed61-08d972f465c6
X-MS-Exchange-CrossTenant-AuthSource: SN6PR12MB4720.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 18:13:45.6127
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 2IaCgFfCLRFXfvz3N0OkLZsw75QFi3qdRT9jIC1tbLUjgJTKvAcR5wnEvevhMSOpbnsKl+Q+NE6HdmC2dtfl7Q==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SA0PR12MB4368
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On 9/8/2021 9:59 AM, Huang Rui wrote:
> Introduce sysfs attributes to get the different level processor
> frequencies.
> 
> Signed-off-by: Huang Rui <ray.huang@amd.com>
> ---
>  drivers/cpufreq/amd-pstate.c | 80 +++++++++++++++++++++++++++++++++++-
>  1 file changed, 79 insertions(+), 1 deletion(-)
> 
> diff --git a/drivers/cpufreq/amd-pstate.c b/drivers/cpufreq/amd-pstate.c
> index 48dedd5af101..3c727a22cb69 100644
> --- a/drivers/cpufreq/amd-pstate.c
> +++ b/drivers/cpufreq/amd-pstate.c
> @@ -577,16 +577,94 @@ static int amd_pstate_cpu_exit(struct cpufreq_policy *policy)
>  	return 0;
>  }
>  
> -static ssize_t show_is_amd_pstate_enabled(struct cpufreq_policy *policy,
> +/* Sysfs attributes */
> +
> +static ssize_t show_amd_pstate_max_freq(struct cpufreq_policy *policy,
>  					char *buf)
> +{
> +	int ret = 0, max_freq;
> +	struct amd_cpudata *cpudata;
> +
> +	cpudata = policy->driver_data;
> +
> +	max_freq = amd_get_max_freq(cpudata);
> +	if (max_freq < 0)
> +		return max_freq;
> +
> +	ret += sprintf(&buf[ret], "%u\n", max_freq);
> +
> +	return ret;

Here, and in the functions below, you could just do

	return sprintf(&buf[ret], "%u\n", max_freq);

and get rid of the intermediary 'ret' variable.

-Nathan

> +}
> +
> +static ssize_t show_amd_pstate_nominal_freq(struct cpufreq_policy *policy,
> +					    char *buf)
> +{
> +	int ret = 0, nominal_freq;
> +	struct amd_cpudata *cpudata;
> +
> +	cpudata = policy->driver_data;
> +
> +	nominal_freq = amd_get_nominal_freq(cpudata);
> +	if (nominal_freq < 0)
> +		return nominal_freq;
> +
> +	ret += sprintf(&buf[ret], "%u\n", nominal_freq);
> +
> +	return ret;
> +}
> +
> +static ssize_t
> +show_amd_pstate_lowest_nonlinear_freq(struct cpufreq_policy *policy, char *buf)
> +{
> +	int ret = 0, freq;
> +	struct amd_cpudata *cpudata;
> +
> +	cpudata = policy->driver_data;
> +
> +	freq = amd_get_lowest_nonlinear_freq(cpudata);
> +	if (freq < 0)
> +		return freq;
> +
> +	ret += sprintf(&buf[ret], "%u\n", freq);
> +
> +	return ret;
> +}
> +
> +static ssize_t show_amd_pstate_min_freq(struct cpufreq_policy *policy, char *buf)
> +{
> +	int ret = 0;
> +	int freq;
> +	struct amd_cpudata *cpudata;
> +
> +	cpudata = policy->driver_data;
> +
> +	freq = amd_get_min_freq(cpudata);
> +	if (freq < 0)
> +		return freq;
> +
> +	ret += sprintf(&buf[ret], "%u\n", freq);
> +
> +	return ret;
> +}
> +
> +static ssize_t show_is_amd_pstate_enabled(struct cpufreq_policy *policy,
> +					  char *buf)
>  {
>  	return sprintf(&buf[0], "%d\n", acpi_cpc_valid() ?  1 : 0);
>  }
>  
>  cpufreq_freq_attr_ro(is_amd_pstate_enabled);
> +cpufreq_freq_attr_ro(amd_pstate_max_freq);
> +cpufreq_freq_attr_ro(amd_pstate_nominal_freq);
> +cpufreq_freq_attr_ro(amd_pstate_lowest_nonlinear_freq);
> +cpufreq_freq_attr_ro(amd_pstate_min_freq);
>  
>  static struct freq_attr *amd_pstate_attr[] = {
>  	&is_amd_pstate_enabled,
> +	&amd_pstate_max_freq,
> +	&amd_pstate_nominal_freq,
> +	&amd_pstate_lowest_nonlinear_freq,
> +	&amd_pstate_min_freq,
>  	NULL,
>  };
>  
> -- 
> 2.25.1
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-19.2 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,MSGID_FROM_MTA_HEADER,NICE_REPLY_A,
	SPF_HELO_NONE,SPF_PASS,USER_AGENT_SANE_1 autolearn=unavailable
	autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id BF8F9C433FE
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 18:21:06 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id A893460E97
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 18:21:06 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1349655AbhIHSWN (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 14:22:13 -0400
Received: from mail-mw2nam12on2067.outbound.protection.outlook.com ([40.107.244.67]:64545
        "EHLO NAM12-MW2-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1347196AbhIHSWL (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 14:22:11 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=XxvISMoPa/yDJtJE0Bl5SbUw2ND+y/UaNzcEdONGMIDXgT9mFlEwV7hO8eY1JoKMTHVDVi2CWxTYM1AW8ExAhcWdc+rqdtzGGG/LmtiaSzjVPTfxlaBydiCQrKfNyuoW6aG6cCfJpZo7Rl0rqrFOgs6Gnipy/0Ht/h3Ov0K0bkdnUcLiAQbxP9/Z7j3Rk9exVpw7u5h1JFO2M81JfCWdY+le1XO1QfHPHZzM0BKlmPbylQ9/Df9P62b0E6By/8ardxrIew/rr89u6rF22ZN9wQcyv6UInks6INxXezmWBkaXxvapBtUxnHMrb0N2sHNRjMWa/EJlRmgQiTR5iPJHOw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=ZcJaBEYfCPIioKJYKEYgkbuC6LkyPjeI8YzhvRS79F8=;
 b=dj/IqescgZeRBuHe9YhtiWh2dON5acrCaWE2aWOwxfMrdx0rjamo8to6vOR6ZzL13MqSoso9+fFtqElogS11Dt4RPYGctBpaUTH472GUK9O0OblyFNRlI7TW5uKdzUSrZCrMsA8jLR1/bbcAsB/Job/IdhoDsMXuTiHXByIZDw91ciqebp7FbyLfct3eu+1XSTEPiKD/gLgOO6NjdGr1Qjik2+Hpo3/FO4mXTVO0aLV4x8IEdrvXU2KWaknW1SmCdnHWczr30VyVHkmF48nqRmkU+zmUcg9nDVB9uGdb1ooUgGPUODrE+eiBDjcAaAwwWTEDD+kcjn1FGpdPvJg5gQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=ZcJaBEYfCPIioKJYKEYgkbuC6LkyPjeI8YzhvRS79F8=;
 b=E0gzwHS3v84bhT0EF1fH1BLvc2PY72g3Bfvb9hFnlgdIpPeW1DmTBQqC/X4jiUuSy68XIja5wifulGetXfBciNJ1wlbyi32jY5FW2sJ5Lhyqj+bwdAzPSgpF+5j4EqtzapsmBQ8BbYffdUEKiwR9us+QaARJfoev94NfrRXOBAI=
Authentication-Results: kernel.org; dkim=none (message not signed)
 header.d=none;kernel.org; dmarc=none action=none header.from=amd.com;
Received: from SN6PR12MB4720.namprd12.prod.outlook.com (2603:10b6:805:e6::31)
 by SA0PR12MB4576.namprd12.prod.outlook.com (2603:10b6:806:93::13) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14; Wed, 8 Sep
 2021 18:21:02 +0000
Received: from SN6PR12MB4720.namprd12.prod.outlook.com
 ([fe80::e134:658f:3a82:f750]) by SN6PR12MB4720.namprd12.prod.outlook.com
 ([fe80::e134:658f:3a82:f750%4]) with mapi id 15.20.4478.026; Wed, 8 Sep 2021
 18:21:02 +0000
Subject: Re: [PATCH 11/19] cpufreq: amd: add amd-pstate performance attributes
To:     Huang Rui <ray.huang@amd.com>,
        "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        Borislav Petkov <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        linux-pm@vger.kernel.org
Cc:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        linux-kernel@vger.kernel.org, x86@kernel.org
References: <20210908150001.3702552-1-ray.huang@amd.com>
 <20210908150001.3702552-12-ray.huang@amd.com>
From:   "Fontenot, Nathan" <Nathan.Fontenot@amd.com>
Message-ID: <a03268e4-f6c6-93ed-d977-94efbd6f923e@amd.com>
Date:   Wed, 8 Sep 2021 13:20:58 -0500
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:78.0) Gecko/20100101
 Thunderbird/78.13.0
In-Reply-To: <20210908150001.3702552-12-ray.huang@amd.com>
Content-Type: text/plain; charset=utf-8
Content-Language: en-US
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: SN4PR0501CA0067.namprd05.prod.outlook.com
 (2603:10b6:803:41::44) To SN6PR12MB4720.namprd12.prod.outlook.com
 (2603:10b6:805:e6::31)
MIME-Version: 1.0
Received: from [172.31.130.72] (165.204.78.25) by SN4PR0501CA0067.namprd05.prod.outlook.com (2603:10b6:803:41::44) with Microsoft SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.6 via Frontend Transport; Wed, 8 Sep 2021 18:20:59 +0000
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 63df8c71-fc92-44a5-58ef-08d972f569ca
X-MS-TrafficTypeDiagnostic: SA0PR12MB4576:
X-MS-Exchange-Transport-Forked: True
X-Microsoft-Antispam-PRVS: <SA0PR12MB457605BA48344B395E9C58C9ECD49@SA0PR12MB4576.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:1303;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: qBj21znrXWYaHIpy1A76994b/MImoUtUwxCzx4TO+e+7+AvWH2WmRO9vWlJ5yRzFA2NaehyTb14zGJ+OgRqzl1j9EphNMaeVeT71sNBTKmHciriB8sDJLgK93Pa8Km1JLc3EeNAXh43U+/dw+3oHlXd2n5qV+HOnEVELRLr/S1G+e2FT4uJGVzaKf6CgiSLiG4bOX26juw7sZIXjMVidmuHchBxcYOP5ZDOmuOX3WQq15S++Wr/jmus6yNtO7LCbCB2noO/ScUQdcQu5678WmvcDZn/WdSxuo3AgQLMSFPSfDDoxyAMC1b4fvU5Kog9Y1A2L33n9KhcOoD8pe7/MhthOHcXqOufYKs/YQFhFtua/RHRrRP4scLuqwcKwi8MqRqu6sxwaf/Ao+WRjRr1cGGPsceiVPl6colzJJosbJ6OOASVL32OLQgKbBkhYzyYHalam/N/IEOMEf/5IcOuvnnqFWdPB2AsPe6IWzjWULiuv5oPKShb2yDf9WWK3vXg0aynxEyHhnQjLDdQ+n/TeT7Juhjtw7+dtbd9tD34emr1vLmiQlrqy6PGVDlsWYAjedD3CJOJsUKMitNnuT3B6HUDzTXOMC5phUM9+u3SWWo8zYQg9RJlh+dhH1dyjjnTevtN75vseAunxa08EYFNZ91cnD1E99jBnLq+w9S4Gua5nn32lfCO6dESo/NJ+GYwfqSZj3OHTp++sC+g0cioAN7Nge0N3xq0VPsZRppoKrc0=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:SN6PR12MB4720.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(4636009)(366004)(396003)(39860400002)(376002)(346002)(136003)(26005)(4326008)(2616005)(66556008)(66946007)(5660300002)(86362001)(186003)(83380400001)(66476007)(478600001)(2906002)(8936002)(8676002)(110136005)(16576012)(31696002)(54906003)(31686004)(38100700002)(36756003)(6486002)(316002)(956004)(53546011)(43740500002)(45980500001);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?utf-8?B?dlFQLzNGVGIvaDNQaUQrT3VZemtUSlhrZEhWVmtQem8xeVdoWTIzS0ZMcGFF?=
 =?utf-8?B?QmJQME01Q2oxQmRWSmJpbkFyNWxSMGp2MzBobFZmYkNzN0lKM3dZTTN2L3BG?=
 =?utf-8?B?dCs0ZGZZdjR0TGkyQmpkQ3JEaURXaXZkSkk3aGpLdlhocnpTWDRNNXBaL2xU?=
 =?utf-8?B?KzNRTlFSMDJpSW1CNE9kczJFaFNOdVJzNlgrOEdySXl2K1UyRkc4VlhQUndX?=
 =?utf-8?B?ejh0ajlFeUw3TkVOTDlCN1hhYzFLMXRVSXFjZnNtL2dVNEdXeXh0ZGRaQm5y?=
 =?utf-8?B?UnIwQ1dhaE5Lei9aRmR4WkxYbXlNQ1dKTkdQUkx6L1ZyZ0FjMHZWbFBULzk0?=
 =?utf-8?B?Y3J5d3BRdHNRZVRvaG5KSnFvMlRyajNSaGcvUUcvV1pzR0JJdHVXTzh0TCtp?=
 =?utf-8?B?NjlSbVNwU2NjQ2RGTnhPbnNhYnpFcmNBRjB0WnFQVmFLZlZOMmt1MFVVQldE?=
 =?utf-8?B?a2hJVDJJRjNJWmcxakhCMG9VdFNMQTV1N1BwZVplWDhvclhFbWIza2RrMjFN?=
 =?utf-8?B?RUxQc002c29QYUJlRnplYUpZUjFxZU5lNXBjWDlkMklEdEhNak5TR2JNQitD?=
 =?utf-8?B?MGxGZUsycnQzU3dnMXpwdy9LaUVkaWpiNGZkNGR5RkdCSlNubG5Ob2FsMy9E?=
 =?utf-8?B?MXJoZENWNS90WE1PN0J5dUtxbmRkdzVMUkZublZnRXlHWUpYNXVYVVFlTnZi?=
 =?utf-8?B?eTVRY041aUd2UmZncUFjczlEVjU0NFYvYkV2a2xyNmdDWUc1cTExR0cvcVdh?=
 =?utf-8?B?N0l5dFRCRFNqSFJPek1rNFBsTjVZQlo2QktWRTVxckhpb01xTm9zb2QrelVh?=
 =?utf-8?B?SHZQb0xlV2RuSDNMUy8rem83eTZDSTUxdFRpTlR2ZVFodlIvbThOa25sWU4r?=
 =?utf-8?B?b2V5T0tqOUlFZ082V2VWeERpdG04YVFtbjdQTXBOZjBsNyttOFJobzk1QUlT?=
 =?utf-8?B?ZDZFNUtNbUc1NkdHTnhPbTJPbXpib3IrV3hyTTQxM0wrTStZbE1iU050ZlF1?=
 =?utf-8?B?YkF1ZmVISWptYU1rSmVlazV2ampQWW04S0FZZTlVTWtZcDdSYXlqN0lScjVk?=
 =?utf-8?B?UlZ4a2pNd3J2cS9WTXFVOGpjVFZpVTl6NlVCY1A3bEhiaWhCQ2VtbHBqZDBw?=
 =?utf-8?B?VktENnRzUlJkMmI4SEhUZWI4WTF6b3dRMm9Na2lWa2R4bkYwZlcwVE4yb1lK?=
 =?utf-8?B?YzRFdUp6YmRDNlpvZitsRUlBVDU1OGhnampENXNrWDRvb0lScWYwYTROTlJQ?=
 =?utf-8?B?ZHAvOGZFeHVpbkkxZUQvMnhMcVdPNTdBMDIydEtsQUdhUThWTEVyaVB4c3ZS?=
 =?utf-8?B?VTNZVjA2akY5SkJKYnlnWmRHOForcGtPQ1JSZDJwL1M4ZU9LL2dlNUlCYm1L?=
 =?utf-8?B?bGRuL0YrN29qbFcvb3gvKzJBcFc1V2UvaWRLZ3R5MExmRjhBdlBaMHRmWHBr?=
 =?utf-8?B?aWhGa212Wk1Hd1dxcWJtUFltcTFRL1pMY3ZRZkljUVdUVUlxaGw2RnlmU1dC?=
 =?utf-8?B?TEMrY1p5WTIya1Q4aExjbDBad21XR29CRXZER3RMWkJadjFTSnNrM2NGSHcz?=
 =?utf-8?B?RVhrZjVZYzJJMmYvOVJ0dDZreTQ4clVQREFRNWNKV3R4bFE0RFp4a0FRK1hn?=
 =?utf-8?B?UDIyb2JXWVdRa2tpamtaRTV3WkNRYWxEVlUzZlRFRWNETGdlZVliVUhDeGFM?=
 =?utf-8?B?NmtjbGlaNXFNRWxoSHhsTEc5d1dsMEVYblFocGU5ZG9nL3I3OUFMS3NoZnFG?=
 =?utf-8?Q?+wDwF+ocOyfn2xyDCd3zkEYPZT5o/6v1tOjPqfM?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 63df8c71-fc92-44a5-58ef-08d972f569ca
X-MS-Exchange-CrossTenant-AuthSource: SN6PR12MB4720.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 18:21:01.8357
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 7GJYAhqsSBy2aGYBLa1+8fxrx6EHMhIlU1wZxLG88ITkeLBlFwfAIUFN12e48nVX7jhewo7t+5jFDHUr34FhQg==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SA0PR12MB4576
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On 9/8/2021 9:59 AM, Huang Rui wrote:
> Introduce sysfs attributes to get the different level amd-pstate
> performances.
> 
> Signed-off-by: Huang Rui <ray.huang@amd.com>
> ---
>  drivers/cpufreq/amd-pstate.c | 66 ++++++++++++++++++++++++++++++++++++
>  1 file changed, 66 insertions(+)
> 
> diff --git a/drivers/cpufreq/amd-pstate.c b/drivers/cpufreq/amd-pstate.c
> index 3c727a22cb69..9c60388d45ed 100644
> --- a/drivers/cpufreq/amd-pstate.c
> +++ b/drivers/cpufreq/amd-pstate.c
> @@ -647,6 +647,62 @@ static ssize_t show_amd_pstate_min_freq(struct cpufreq_policy *policy, char *buf
>  	return ret;
>  }
>  
> +static ssize_t
> +show_amd_pstate_highest_perf(struct cpufreq_policy *policy, char *buf)

Here (and in the other functions) the function return value and name should
be on the same line.

> +{
> +	int ret = 0;
> +	u32 perf;
> +	struct amd_cpudata *cpudata = policy->driver_data;
> +
> +	perf = READ_ONCE(cpudata->highest_perf);
> +
> +	ret += sprintf(&buf[ret], "%u\n", perf);
> +
> +	return ret;

Same comment as the previous patch here and in the functions below, just do

	return sprintf(&buf[ret], "%u\n", perf);

and get rid of the intermediary 'ret' variable.

-Nathan

> +}
> +
> +static ssize_t
> +show_amd_pstate_nominal_perf(struct cpufreq_policy *policy, char *buf)
> +{
> +	int ret = 0;
> +	u32 perf;
> +	struct amd_cpudata *cpudata = policy->driver_data;
> +
> +	perf = READ_ONCE(cpudata->nominal_perf);
> +
> +	ret += sprintf(&buf[ret], "%u\n", perf);
> +
> +	return ret;
> +}
> +
> +static ssize_t
> +show_amd_pstate_lowest_nonlinear_perf(struct cpufreq_policy *policy, char *buf)
> +{
> +	int ret = 0;
> +	u32 perf;
> +	struct amd_cpudata *cpudata = policy->driver_data;
> +
> +	perf = READ_ONCE(cpudata->lowest_nonlinear_perf);
> +
> +	ret += sprintf(&buf[ret], "%u\n", perf);
> +
> +	return ret;
> +}
> +
> +static ssize_t
> +show_amd_pstate_lowest_perf(struct cpufreq_policy *policy, char *buf)
> +{
> +	int ret = 0;
> +	u32 perf;
> +	struct amd_cpudata *cpudata = policy->driver_data;
> +
> +	perf = READ_ONCE(cpudata->lowest_perf);
> +
> +	ret += sprintf(&buf[ret], "%u\n", perf);
> +
> +	return ret;
> +}
> +
>  static ssize_t show_is_amd_pstate_enabled(struct cpufreq_policy *policy,
>  					  char *buf)
>  {
> @@ -654,17 +710,27 @@ static ssize_t show_is_amd_pstate_enabled(struct cpufreq_policy *policy,
>  }
>  
>  cpufreq_freq_attr_ro(is_amd_pstate_enabled);
> +
>  cpufreq_freq_attr_ro(amd_pstate_max_freq);
>  cpufreq_freq_attr_ro(amd_pstate_nominal_freq);
>  cpufreq_freq_attr_ro(amd_pstate_lowest_nonlinear_freq);
>  cpufreq_freq_attr_ro(amd_pstate_min_freq);
>  
> +cpufreq_freq_attr_ro(amd_pstate_highest_perf);
> +cpufreq_freq_attr_ro(amd_pstate_nominal_perf);
> +cpufreq_freq_attr_ro(amd_pstate_lowest_nonlinear_perf);
> +cpufreq_freq_attr_ro(amd_pstate_lowest_perf);
> +
>  static struct freq_attr *amd_pstate_attr[] = {
>  	&is_amd_pstate_enabled,
>  	&amd_pstate_max_freq,
>  	&amd_pstate_nominal_freq,
>  	&amd_pstate_lowest_nonlinear_freq,
>  	&amd_pstate_min_freq,
> +	&amd_pstate_highest_perf,
> +	&amd_pstate_nominal_perf,
> +	&amd_pstate_lowest_nonlinear_perf,
> +	&amd_pstate_lowest_perf,
>  	NULL,
>  };
>  
> -- 
> 2.25.1
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-19.2 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,MSGID_FROM_MTA_HEADER,NICE_REPLY_A,
	SPF_HELO_NONE,SPF_PASS,USER_AGENT_SANE_1 autolearn=unavailable
	autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 17500C433EF
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 18:25:09 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id E3D0360EE6
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 18:25:08 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1349881AbhIHS0P (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 14:26:15 -0400
Received: from mail-sn1anam02on2041.outbound.protection.outlook.com ([40.107.96.41]:6286
        "EHLO NAM02-SN1-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S235224AbhIHS0J (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 14:26:09 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=mlK5j++qCmSvwrQ2YG3g485rW0jwZJdPiTo674a9eflYq8xKSaEfGfpo4EkQ3DG/V7W0dHwTrM59zfrUtKORPCIeLDThSoCOZE+zg3eU44pHoSh//fW6ALG60IqTuGrjGwTNX9TMgHYodco2fSn3bw5+UjDeACm6Ke+wEU6mby/U1/ph0xbuZaUxKEQ/6gMNEYFLzVPP9uvQAVlo3LTdnCzeebwGAyyWZMZWzERqJO9byHNr79/1EhcqajmB5hFzwSYYIB94Lb264KtIUNcfddY4pzLDVJlp+TscC6WOWKVv7eQfN76jZZ5rpWvzP/EFUgeFuAMbI351wW3yzWv9BA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=hCfNM8Iz7KAm5bALt8HUeJoCuTtiwTpZkOr4KM8gEKI=;
 b=TG0DqNa2nF52AXa1c58P34aoPvd5lp4l0+AGGDY5TyW8To4nC0Dy1levgNKsMraudifHdgPQ8VQLy4uANRa6LCTrX9e+qKhR22HeZT1aEMJC51AVen/gvaTkx/000IA1XbPXI2/L0XnJ8a9QfvK/ltSRzHg5oYCsAQnzBu7no9qfyuetY6RgP9S3QMLX67tcRzI/vO4woYZ6pFK53jgtfVUz3DSWhOXQLgWGPA7pLYm2p1PQsBmQxw2DL8l/kOEgplRMTHK1wGQ78Fgqb6n/+xNkX13/25MDSwE5o1L3C7qrn7HvEA0FpzOTr0SM5Ni0dlhNciDhMd+bITJlsyAkaA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=hCfNM8Iz7KAm5bALt8HUeJoCuTtiwTpZkOr4KM8gEKI=;
 b=ZD+Tp1duxUtFyvi4mNa8KrVgdEk/6eqP+m5KpylyZD8u5pcrZGWKY07Gj8asd4vZdklWdTg+OltIyhp/RQ8HzIicIEzAXtRkAQc4gQKCsT5o3HH0CvmTFFAHqaS+rh1htQDC5RMIVQyQa0v26c/hpAoQ4NInh2zHnZCKB3gPHys=
Authentication-Results: kernel.org; dkim=none (message not signed)
 header.d=none;kernel.org; dmarc=none action=none header.from=amd.com;
Received: from SN6PR12MB4720.namprd12.prod.outlook.com (2603:10b6:805:e6::31)
 by SN1PR12MB2576.namprd12.prod.outlook.com (2603:10b6:802:22::22) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14; Wed, 8 Sep
 2021 18:25:00 +0000
Received: from SN6PR12MB4720.namprd12.prod.outlook.com
 ([fe80::e134:658f:3a82:f750]) by SN6PR12MB4720.namprd12.prod.outlook.com
 ([fe80::e134:658f:3a82:f750%4]) with mapi id 15.20.4478.026; Wed, 8 Sep 2021
 18:24:58 +0000
Subject: Re: [PATCH 08/19] cpufreq: amd: add boost mode support for amd-pstate
To:     Huang Rui <ray.huang@amd.com>,
        "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        Borislav Petkov <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        linux-pm@vger.kernel.org
Cc:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        linux-kernel@vger.kernel.org, x86@kernel.org
References: <20210908150001.3702552-1-ray.huang@amd.com>
 <20210908150001.3702552-9-ray.huang@amd.com>
From:   "Fontenot, Nathan" <Nathan.Fontenot@amd.com>
Message-ID: <a2718365-5975-5c91-350f-fe9098b4de7b@amd.com>
Date:   Wed, 8 Sep 2021 13:24:54 -0500
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:78.0) Gecko/20100101
 Thunderbird/78.13.0
In-Reply-To: <20210908150001.3702552-9-ray.huang@amd.com>
Content-Type: text/plain; charset=utf-8
Content-Language: en-US
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: SA0PR11CA0147.namprd11.prod.outlook.com
 (2603:10b6:806:131::32) To SN6PR12MB4720.namprd12.prod.outlook.com
 (2603:10b6:805:e6::31)
MIME-Version: 1.0
Received: from [172.31.130.72] (165.204.78.25) by SA0PR11CA0147.namprd11.prod.outlook.com (2603:10b6:806:131::32) with Microsoft SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 18:24:56 +0000
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: f2766f2e-7870-4c2e-3392-08d972f5f703
X-MS-TrafficTypeDiagnostic: SN1PR12MB2576:
X-MS-Exchange-Transport-Forked: True
X-Microsoft-Antispam-PRVS: <SN1PR12MB25765C899331F3AEE47C8DF0ECD49@SN1PR12MB2576.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:4502;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: /UnvBtBGMEaBa5K6NqR/18M9pHz5IZmw1WQZJ64SkN+77E6gz+34wdzKCxuuLJlsq1a6M9QVlfkYgDxO3wnKrWM9yP9R0ubrdQUm93mLVfC9H0B/D1ZUj+vGg8Vuaav5WtFf05nlXnRW2NeP5qYyqVT1sMmeBP7wAlRYllXNFJI8cnyzZ1bE6y2hlUOJLoXazwqikBh5C5B65L+k6G09K5Ts/8jzqfFY1EKrFZRi2XwWM1e49LsMxkCf9GRjSb8Rm1fattLkU98oSn/W7Aih1nDj9jO9hRgQ7sPFT8GrVHaT1t8CB1lO8XO4rLp+j93Kw7nIq1tzY9b1DjCBD2I+cBT0rE4sm061/bDuceGayi0tphxNcra+4Yg6s1HvRiu6pTAWvTNo29r8MgVq7LrOEkF5b2JPk3OVZ5AtuvJLPw2jkwL9JTBv6bgk/1Fu764OLdOcjxeH19QDIBZDRTBTe+WiHsWHjMtrfQGGjQefkCWlmFOx5Azk9bjqIIGeFrYCFeN9gvPCtDKOwQl4G5bh6ZVAAtg7R+qYwTucFCLdwAppAAIvudkd59Oh/CSqlASjxUPa+ZWV/9A+VohsQfqCpsK0HGJUIkX/ev0Xapb7pj3exyT5stirSpEMQ67MiUnYXkH4AAUUF5KTdAnCEgrdZTnRPq1FlXl4eskxAFnKovTXg0p7l0klrzE70t/5kmMv5WzwO36Ooj4hlJbqAG/Zh2tHDZlVIxkb0EfC3E1dNoY=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:SN6PR12MB4720.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(4636009)(39860400002)(376002)(366004)(396003)(136003)(346002)(8936002)(31696002)(83380400001)(53546011)(316002)(110136005)(16576012)(956004)(54906003)(5660300002)(2906002)(6486002)(66476007)(2616005)(66556008)(66946007)(36756003)(31686004)(186003)(4326008)(26005)(8676002)(86362001)(478600001)(38100700002)(45980500001)(43740500002);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?utf-8?B?STJ6cVlNRkU3My8xUTY4TnA2aTIrMjN4OE5GWW9aVzA0NTVpeE04QXBjRXFS?=
 =?utf-8?B?VDd5M1krb055akd1NTA0anlxK1dQUnpvWWVCMzF4M3NIREFhSUVOOGVGRDZI?=
 =?utf-8?B?NlhNUllUdS9UYkhuQU9uTU5xcHZYK0NrVUZvYUlJdklwWEUrMzVTUlpVRHdL?=
 =?utf-8?B?NGlSRVU5Z01pb0hvOUlDSG9KK3FSSGhoL0dUSFZjamh3bHdZaHlrL0FaK0lw?=
 =?utf-8?B?cEJhTG9aemZrcXlUTk1udVZ1aGtNY1VlWi9lRU94K01IZGhFZzFKODVNVXBH?=
 =?utf-8?B?Y0hGc0Z2ZnREaVI0RlQzQ3lBUm1PbDJzbTR2VEVVaEtUUVlHVjg4UlVaOE5M?=
 =?utf-8?B?TTdCZndYSEh0QUZTOWdUVHg2SWhuNlQxaWpseTM1VVdtTFkxUWYrSHp2bU1K?=
 =?utf-8?B?d09xSUhQVUJZZm82UzFaZEhjNzl6YUIraU4zVGxMVnZ6Z2tYalhiVUQvUDd2?=
 =?utf-8?B?a0hpQlFDTU04QnF6a09ndDlBU3d0WDdZM29meUQyd0tUUlFZZmFOTGxJNzJh?=
 =?utf-8?B?LzJlN3BxNTFMcU03NnJLSHV6NGlEZ3g1TTVYbkNiaUtHd0N0UEQyYTJKeTg3?=
 =?utf-8?B?QmU4VVh1eDVBdG1TWml6ZXJkMVROcFZscVdiTFNmWE5NZWduazVSV0VUb3lt?=
 =?utf-8?B?OW4wQUE2R3hYSzFQZ0F1T3dXaHBYUnlHQzN1VFlaWFBiUFRFWFhpa1lLd1FF?=
 =?utf-8?B?ekkvMldSY1c5QkF1clJnTDFCaENSa0hXd3E1aXErVjRJR1ZqeG0xZnBQdlR2?=
 =?utf-8?B?M2NqaDNGUXFYVC9RYWVVUVdiOTU3bUVWbG9vQlhNNDlQVnpkK0t6djBWSGdF?=
 =?utf-8?B?T3p3d2lRdTdDR2owNVdGZGxScUhOOGZacndGVkZNSldWZWZqQVM4RDcyQlY3?=
 =?utf-8?B?NW80dzVNYnE0ZWVqNUp4VU5KSTh1UmdmZHlvNHZaZHRTQ0c2cURUY2x1M2tk?=
 =?utf-8?B?cUNwVXBFbW9QOXdyaHBFMXJmcGJYWXJSYzNkNHJzaUVDZUpUSlhkcHFOMExE?=
 =?utf-8?B?bjlXSnpZa0ZEKzdWZllTZVMveWRGNFNHLzkrUFVMU2FUQmhsNm82VGZ2dVdP?=
 =?utf-8?B?OHV0OXR1MkU5WGJydkV2UkMzODFtNS9mdms1c3RJU0gxdE1nbnhEMHEvV2VR?=
 =?utf-8?B?bW1lSTVMNGpNa0xHQld0cDJ6c3ZSOTBhQUtjR0c5ZW5iSE45Wmk3dXVvL0R1?=
 =?utf-8?B?dmYxck5Jd2RKZDZNS2d6aGpHZktSTFFaTFJMcUgrWjFUdXMwS253WnhCTXl2?=
 =?utf-8?B?K082c3MyeUo0cXBYY2h6QTV2aklKdHJjUzkrZWh5RzJPYm9TZld4TTN6bHBq?=
 =?utf-8?B?T09RZnZPOEh3aTVFTEExbm9ONWdyeWk2MzkrZUR4V0dSemZwNndKdlZpdDYx?=
 =?utf-8?B?cUk0dGYrcTdDL2R5cGdVbjZVRmI2ZkE0aklZTFFUSXd0VlFYQTJlTjRBTFkw?=
 =?utf-8?B?RVc3TFo0V1lxS1hKRTNCZUlrVm9XUlk0Y3p4MjI0cmFUYmVEZ1ptZENNM3Ir?=
 =?utf-8?B?Y2V6Z3FPekVTT08reEFDdk1uUjJVd2czWENTSEJockZNTldmUFM5cFg1Smoy?=
 =?utf-8?B?SmlPcVNJdnZ6am9Gek9aM2d5MmhJbnBHcGp3SmpIMytBRHg4cDJjT1JrTENk?=
 =?utf-8?B?TVdoWldVMnlBTThjSEtzd0tURUUrSWRMOEtqbUt0bXpMang3R1RjeTNydHZI?=
 =?utf-8?B?ZUpPYmJacEVJcFRWRFo4RDErY2ZRdCtjaGN1Z0NBL1ZhRnNtQjB5ZlF4OStY?=
 =?utf-8?Q?RmmhRQMHJ9Ll8Xpy5f+Ik7NsBkeaup+sT9KvzRF?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: f2766f2e-7870-4c2e-3392-08d972f5f703
X-MS-Exchange-CrossTenant-AuthSource: SN6PR12MB4720.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 18:24:58.7871
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: fB4B5Uf9+CwQjnvJttURmpAV6XMiaoYX9Oqj3be/UAm8PK49nVB3marsDk+MihSRHxpGPBhJMiD2l4dltEcFOQ==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SN1PR12MB2576
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On 9/8/2021 9:59 AM, Huang Rui wrote:
> If the sbios supports the boost mode of amd-pstate, let's switch to
> boost enabled by default.
> 
> Signed-off-by: Huang Rui <ray.huang@amd.com>
> ---
>  drivers/cpufreq/amd-pstate.c | 50 ++++++++++++++++++++++++++++++++++++
>  1 file changed, 50 insertions(+)
> 
> diff --git a/drivers/cpufreq/amd-pstate.c b/drivers/cpufreq/amd-pstate.c
> index ea965a122431..67a9a117f524 100644
> --- a/drivers/cpufreq/amd-pstate.c
> +++ b/drivers/cpufreq/amd-pstate.c
> @@ -75,6 +75,8 @@ struct amd_cpudata {
>  	u32	min_freq;
>  	u32	nominal_freq;
>  	u32	lowest_nonlinear_freq;
> +
> +	bool	boost_supported;
>  };
>  
>  struct amd_pstate_perf_funcs {
> @@ -229,6 +231,19 @@ amd_pstate_update(struct amd_cpudata *cpudata, u32 min_perf,
>  				      max_perf, fast_switch);
>  }
>  
> +static bool amd_pstate_boost_supported(struct amd_cpudata *cpudata)
> +{
> +	u32 highest_perf, nominal_perf;
> +
> +	highest_perf = READ_ONCE(cpudata->highest_perf);
> +	nominal_perf = READ_ONCE(cpudata->nominal_perf);
> +
> +	if (highest_perf > nominal_perf)
> +		return true;
> +
> +	return false;
> +}
> +
>  static int amd_pstate_verify(struct cpufreq_policy_data *policy)
>  {
>  	cpufreq_verify_within_cpu_limits(policy);
> @@ -402,6 +417,37 @@ static int amd_get_lowest_nonlinear_freq(struct amd_cpudata *cpudata)
>  	return lowest_nonlinear_freq * 1000;
>  }
>  
> +static int amd_pstate_set_boost(struct cpufreq_policy *policy, int state)
> +{
> +	struct amd_cpudata *cpudata = policy->driver_data;
> +	int ret;
> +
> +	if (!cpudata->boost_supported) {
> +		pr_err("Boost mode is not supported by this processor or SBIOS\n");
> +		return -EINVAL;
> +	}
> +
> +	if (state)
> +		policy->cpuinfo.max_freq = cpudata->max_freq;
> +	else
> +		policy->cpuinfo.max_freq = cpudata->nominal_freq;
> +
> +	policy->max = policy->cpuinfo.max_freq;
> +
> +	ret = freq_qos_update_request(&cpudata->req[1],
> +				      policy->cpuinfo.max_freq);
> +	if (ret < 0)
> +		return ret;
> +
> +	return 0;
> +}
> +
> +static void amd_pstate_boost_init(struct amd_cpudata *cpudata)
> +{
> +	cpudata->boost_supported = true;
> +	amd_pstate_driver.boost_enabled = true;
> +}
> +
>  static int amd_pstate_init_freqs_in_cpudata(struct amd_cpudata *cpudata,
>  					    u32 max_freq, u32 min_freq,
>  					    u32 nominal_freq,
> @@ -504,6 +550,9 @@ static int amd_pstate_cpu_init(struct cpufreq_policy *policy)
>  
>  	policy->driver_data = cpudata;
>  
> +	if (amd_pstate_boost_supported(cpudata))
> +		amd_pstate_boost_init(cpudata);

Is there any reason to not merge amd_pstate_boost_supported() and
amd_pstate_boost_init() into a single function? I don't see that
amd_pstate_boost_supported() is called anywhere else.

-Nathan

> +
>  	return 0;
>  
>  free_cpudata3:
> @@ -535,6 +584,7 @@ static struct cpufreq_driver amd_pstate_driver = {
>  	.fast_switch    = amd_pstate_fast_switch,
>  	.init		= amd_pstate_cpu_init,
>  	.exit		= amd_pstate_cpu_exit,
> +	.set_boost	= amd_pstate_set_boost,
>  	.name		= "amd-pstate",
>  };
>  
> -- 
> 2.25.1
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-19.2 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,MSGID_FROM_MTA_HEADER,NICE_REPLY_A,
	SPF_HELO_NONE,SPF_PASS,USER_AGENT_SANE_1 autolearn=unavailable
	autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id C6789C433FE
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 19:14:46 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id B304C61166
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 19:14:46 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1349414AbhIHTPx (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 15:15:53 -0400
Received: from mail-dm6nam10on2083.outbound.protection.outlook.com ([40.107.93.83]:17536
        "EHLO NAM10-DM6-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S231734AbhIHTPu (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 15:15:50 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=hzhqChK2dKafq6wwkAUsSKdj4SfR2wLrWiDStpzqdQG52fGx+ZtorisyIKBMYLY0gylq+jfG4zMbWMJmOhuTg8cEJM3XtiTX44KstQIewnwldF83U5Dy+tRASb0awevKyzPURoWAY7o0NCB9NNPHSz8oFzyh9ZM9aWTiNCfweMQEJaxk1X1R1pw+KcNqXdPmSXLD3g5UMXR6NY7PUjGHGhorl08Nn6y0WHalT2k1ylT2fxhy672p28JbnZ1ZeJBtjHom5L0Kcb7R9niHRR98wjGWx6hHe2dN3NflTuEvXCJb6mzBr62MCEzS7DV+VLVzny3OodyChKasoIiOZD+QFA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=m9UTllVlAszaTGPbniMc+DWEQxc8MswtCBlkV1igtzU=;
 b=NOZ7cjl5iyRY+mMwhE2Evzfjwb9cmpz92Tlgk+VnDeex9L1WidQwMpwe6ok/KQ0nG/HA1OKmXC0ubMvymCwY7pwalkkWnjXhK9IV3ADPm4sP6CdDKpFHmDQKdmfqF7XZtNMsztpY4kI5V9BjybDF/sCinNXTrgM/QmS55rDn1ljGGji5ccGZC9TDWYV+I6uRU0k0QdXuDyL7iFuMZvbNC8FnVuqau4tltvJDIjtB+5jVtqmbNcyVUCCWtR1qfihRuwWGGolm5KpL/N3hoqDWvu1jrQ8Q//MTe+M5gKOC3cd9UzrEMoYc2kWolB5K67sCh55dxOMVN70lR46G7THmtA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=amd.com; dmarc=pass action=none header.from=amd.com; dkim=pass
 header.d=amd.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=m9UTllVlAszaTGPbniMc+DWEQxc8MswtCBlkV1igtzU=;
 b=g/rwGsbOp+oH8G7Mr6RPMDqL+cmQ2qyd8msqsrx9GfpXyeiSAWskon6rgVQXaKl2Bf2QA15HjNlEHU1BONM2Ul6B5KF4Uv6YWbi3mYCxaqgeycZCGaVSGjIiWZ/zt6s72C04/aUZKHcjAeSa43GcvLuJJfKAQEAliQ5zaCq6zhM=
Authentication-Results: kernel.org; dkim=none (message not signed)
 header.d=none;kernel.org; dmarc=none action=none header.from=amd.com;
Received: from SN6PR12MB4720.namprd12.prod.outlook.com (2603:10b6:805:e6::31)
 by SN1PR12MB2480.namprd12.prod.outlook.com (2603:10b6:802:22::21) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4478.21; Wed, 8 Sep
 2021 19:14:40 +0000
Received: from SN6PR12MB4720.namprd12.prod.outlook.com
 ([fe80::e134:658f:3a82:f750]) by SN6PR12MB4720.namprd12.prod.outlook.com
 ([fe80::e134:658f:3a82:f750%4]) with mapi id 15.20.4478.026; Wed, 8 Sep 2021
 19:14:40 +0000
Subject: Re: [PATCH 03/19] ACPI: CPPC: add cppc enable register function
To:     Huang Rui <ray.huang@amd.com>,
        "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        Borislav Petkov <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        linux-pm@vger.kernel.org
Cc:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        linux-kernel@vger.kernel.org, x86@kernel.org
References: <20210908150001.3702552-1-ray.huang@amd.com>
 <20210908150001.3702552-4-ray.huang@amd.com>
From:   "Fontenot, Nathan" <Nathan.Fontenot@amd.com>
Message-ID: <53962105-07cb-d964-28d0-1cc4d2e7fe8b@amd.com>
Date:   Wed, 8 Sep 2021 14:14:37 -0500
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:78.0) Gecko/20100101
 Thunderbird/78.13.0
In-Reply-To: <20210908150001.3702552-4-ray.huang@amd.com>
Content-Type: text/plain; charset=utf-8
Content-Language: en-US
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: SN7PR04CA0019.namprd04.prod.outlook.com
 (2603:10b6:806:f2::24) To SN6PR12MB4720.namprd12.prod.outlook.com
 (2603:10b6:805:e6::31)
MIME-Version: 1.0
Received: from [172.31.130.72] (165.204.78.25) by SN7PR04CA0019.namprd04.prod.outlook.com (2603:10b6:806:f2::24) with Microsoft SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend Transport; Wed, 8 Sep 2021 19:14:39 +0000
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 488a52d7-6b08-44b3-afe4-08d972fce843
X-MS-TrafficTypeDiagnostic: SN1PR12MB2480:
X-MS-Exchange-Transport-Forked: True
X-Microsoft-Antispam-PRVS: <SN1PR12MB2480357B2B0D23970E178604ECD49@SN1PR12MB2480.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:2449;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: miuDAohsoYfxk8WCVZCZHmtJPLqFTkPdLWzO+mhmjRkv6Di/0G0CxKomQtakhJcZXnycpBfNEZDDXlXXSEe12FI5Q2VvUjJMXHUnDP39w0gLIDdA4Joo95k3GkRv75GcegCdV33S5dAaielNWG93PyCdvvk7f2VCxCSEPTNVaEyGCtC5Q454gNfkaRnrIdB6TowXvFt/K9ER/C18cUM1BVBMmFZvaQMY90uMcotfSS+ENmyhs7YTMmZzKWG4xZxVRWqmcRu1Us2nnWmaXn9Iav8m5pkS4twynHdkiWcY0LvUwvOVTughr5+A+Nb+Z+4v9RilrDolr1DJxqcDR6QwqrlqNUGF0FTmpD2PrwIGCG67vRly3PObLBcEdq+fKiJdi9baF4TYbBjlnsJFbV9mHcdJCDKgYP3ht1xfhWx4YepkdPju9AFtwlEOWWFkzZbf4vzvMhVUwM3iVx3T21DoXkb409yn2mKs9VPanAZYy4qhhtQPVOFVNeNdHkATKCpTSX3y0IGfIz+SbO6XeIGVc+jV2FBJgTuYdYpEzOnZWJpz43XeY/k3DG3l+CEmvvxDgl4imORZWGpjCsQN1nGpLHAE9tvTXdaqcSSKYBf/Dy5Yay1/aCajjOCH/2jLYfcPSMIXlPhqOmUwx52u2AB/B3MEAIXhPdnjy56w6KXoN432BQRwmvTTvdQCyICVjCcyU9Q9lMbjQEdMDO0J7p/pRuMb5IX8Pi8yS0BlBfVVoi4=
X-Forefront-Antispam-Report: CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:SN6PR12MB4720.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(4636009)(136003)(376002)(396003)(346002)(39860400002)(366004)(8676002)(83380400001)(478600001)(53546011)(110136005)(31696002)(54906003)(86362001)(31686004)(2616005)(956004)(186003)(38100700002)(5660300002)(26005)(8936002)(36756003)(2906002)(6486002)(316002)(16576012)(4326008)(66946007)(66476007)(66556008)(43740500002)(45980500001);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData-ChunkCount: 1
X-MS-Exchange-AntiSpam-MessageData-0: =?utf-8?B?a2ppN0hjSkRvNnhma3ZJN2hwZk1ZN3hRV3dVb2p4VVpmVkVKWTBwRkxGMHJX?=
 =?utf-8?B?NVVEcHJ6cjFCamxheGNaQ2tLZTA5dWNHN0xUYTBJQWUwR2NwV0tDRUhNWmtY?=
 =?utf-8?B?RmJ0bnYrZDc3UmpiVkUxWUJrSGdtOCsvQnM3d3N3Mmt1TnlBQWdwWXkrOElk?=
 =?utf-8?B?OWUrb2VndWIvbFdMLzRta2p0cGZVblp4aTh0Uk9aa010K21VMUx0dkRuWGx2?=
 =?utf-8?B?Y3k0bE9WdXMwakNWSGprT3VLVGVQYi9XUk4zMXc1N2thOGJlajVlUmRNS0xX?=
 =?utf-8?B?MjhJRHRBL3JXVmlIN0Y0TjRhTTZiSk5wd21rNnRqWXNoQXV1S2I5djh0SGJD?=
 =?utf-8?B?WUNmUkhhNmVMVVlHS1RBc3lSZEdpSHZkTXJrN3NJRitCVVlBSmJKak5iaHBY?=
 =?utf-8?B?QUt3bDBkUk9La1VzdkluZ0pKY1VLby8wVTF0bzRPeTd1ZmtjYjdTMXdIODFC?=
 =?utf-8?B?Nm9DdEpUT0FWR29GRFNuTHBYakkyVysyMlB6RER6cG13VUVEdW5lMm9pUzhs?=
 =?utf-8?B?ZWFhazk0NzhRNXZpaWFQMi9lK1NxcGRGYmVZUWlwWWlpOEpCWmg1UXFweU4y?=
 =?utf-8?B?RHlEUUIyQTdvUGVhVzhPSUFEUitLWTFwc2dUc3gzTUU1aTVjNThuOHVlbmlP?=
 =?utf-8?B?alZHQU1jejFtMzJvRXJ2S2U0bC82ZlFnVjBYZjk5QjBJQnhEMzNlcjdhL1hM?=
 =?utf-8?B?dldSVkhBalBlRXhMejRZSlBGc1pmZlRZTzBUT21tcXdlb3ZydUFTWUFjNDAr?=
 =?utf-8?B?SXI3eW9YeGZrRUp5OW96Znk3M0orM0dxcGhxZEt6eTc2OVAxZDRaVDYwU3Jq?=
 =?utf-8?B?Z3hvSXRIemJid0dFY1VKOTFEUTVSblVKTVVBbmx2Rnk3R2l4MzBkODBpQUsv?=
 =?utf-8?B?bE9KMmlPc3V4UWRlZktSN1Z1bGdVQjhLRkYvSXRJYTlZSDRFUVFJMDNFMDJt?=
 =?utf-8?B?OGpobng2d1V0TVd0dzAyek9ZMFdYNGs2ZElneFhHRVBuVEN0Z3UrSlY1UlBI?=
 =?utf-8?B?TGh5eHB3eUlTNkVKUEtKWXMySDVpazJ0QURyUThDUXViQ0ZpNC9uVzhQc0Fu?=
 =?utf-8?B?WVJFaWxwUGVQNlZUYXpXaTloeGRJYk1xNjF2SzBERk9nRk81WVR5Q3hpN3Fn?=
 =?utf-8?B?Y3JSZ1JhM210YTZibmlQVm14OVoycEVZR3BIUXJrK2hJYmJFMWRwb1ltdkJ4?=
 =?utf-8?B?Zm5vQko1Q0ZObFNlT0N1emk2STJyalBBZG5xR2p3MW96M1N2cWRnY2prSUhV?=
 =?utf-8?B?MERjeWg3VEc4U0R4ZncrcEJ2SFZNajBMWWl6Q09DTEk3REc4ckd3d3VtSVBK?=
 =?utf-8?B?ZSt3SFNiUXpvdXRkamc5RTFKN2hzb0VzLytBQXBQejFHWG5rbS9xTHEzVTFP?=
 =?utf-8?B?MWxUMm1Ic2FBQktYS0s4N3Zlc2VDSzByempIbGFhT3dGSFVvQ1gxWEltTW1y?=
 =?utf-8?B?akZhcVk2dnNwRW1sWkl1ZE1uRjhUK3N0SFRQQ2tRQkhDQVVIQnc5S2twOTN5?=
 =?utf-8?B?ZE5uN3U4Q2FrT25iMFFFRi9pQnNMVEFZUzE3OW5yZFIzaHNnam8vZFdoMkFI?=
 =?utf-8?B?TzlRSStWb1ZZYVBtZzA4NFpsYVJ4Q3htdFA1Q21DZEZCUEVMcHdMREh6L2da?=
 =?utf-8?B?R09Qcm9xcHpnZmM4UWVuN1lManZnRWxFQVMrWm5iNWpZbCtQVUt2cE9PQzdx?=
 =?utf-8?B?OGhvc1ovR0RNVnFyazNJOHh2UEpYVitueTVxREZOTllzaEpHOUNrNHlySUhl?=
 =?utf-8?Q?km4D2gtGpK2/TILG7xqyYGJG0T3L/dlHURTQ2IF?=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 488a52d7-6b08-44b3-afe4-08d972fce843
X-MS-Exchange-CrossTenant-AuthSource: SN6PR12MB4720.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 08 Sep 2021 19:14:40.5799
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: kpsTuIxNBSxxhuHRke+gQNhPV2NFM/nRJvtCy0EXIyNTy9i/v+dNuquLje1To2a88myg7hS1FI6+3UW+SSicWg==
X-MS-Exchange-Transport-CrossTenantHeadersStamped: SN1PR12MB2480
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On 9/8/2021 9:59 AM, Huang Rui wrote:
> From: Jinzhou Su <Jinzhou.Su@amd.com>
> 
> Export the cppc enable register function for future use.
> 
> Signed-off-by: Jinzhou Su <Jinzhou.Su@amd.com>
> Signed-off-by: Huang Rui <ray.huang@amd.com>
> ---
>  drivers/acpi/cppc_acpi.c | 42 ++++++++++++++++++++++++++++++++++++++++
>  include/acpi/cppc_acpi.h |  5 +++++
>  2 files changed, 47 insertions(+)
> 
> diff --git a/drivers/acpi/cppc_acpi.c b/drivers/acpi/cppc_acpi.c
> index a4d4eebba1da..de4b30545215 100644
> --- a/drivers/acpi/cppc_acpi.c
> +++ b/drivers/acpi/cppc_acpi.c
> @@ -1220,6 +1220,48 @@ int cppc_get_perf_ctrs(int cpunum, struct cppc_perf_fb_ctrs *perf_fb_ctrs)
>  }
>  EXPORT_SYMBOL_GPL(cppc_get_perf_ctrs);
>  
> +/**
> + * cppc_set_enable - Set to enable CPPC register.
> + * @cpu: CPU for which to enable CPPC register.
> + * @enable: enable field to write into share memory.
> + *
> + * Return: 0 for success, -ERRNO otherwise.
> + */
> +int cppc_set_enable(int cpu, u32 enable)
> +{
> +	int pcc_ss_id = per_cpu(cpu_pcc_subspace_idx, cpu);
> +	struct cpc_register_resource *enable_reg;
> +	struct cpc_desc *cpc_desc = per_cpu(cpc_desc_ptr, cpu);
> +	struct cppc_pcc_data *pcc_ss_data = NULL;
> +	int ret = -1;
> +
> +	if (!cpc_desc) {
> +		pr_debug("No CPC descriptor for CPU:%d\n", cpu);
> +		return -ENODEV;
> +	}
> +
> +	enable_reg = &cpc_desc->cpc_regs[ENABLE];
> +
> +	if (CPC_IN_PCC(enable_reg)) {
> +
> +		if (pcc_ss_id < 0)
> +			return -EIO;
> +
> +		ret = cpc_write(cpu, enable_reg, enable);
> +		if (ret)
> +			return ret;
> +
> +		pcc_ss_data = pcc_data[pcc_ss_id];
> +
> +		down_write(&pcc_ss_data->pcc_lock);
> +		send_pcc_cmd(pcc_ss_id, CMD_WRITE);

Shouldn't we be checking the return value from send_pcc_cmd()?

Also, if the call to send_pcc_cmd() fails do we need to update
enable_reg? i.e. cpc_write(..., !enable);

-Nathan

> +		up_write(&pcc_ss_data->pcc_lock);
> +	}
> +
> +	return ret;
> +}
> +EXPORT_SYMBOL_GPL(cppc_set_enable);
> +
>  /**
>   * cppc_set_perf - Set a CPU's performance controls.
>   * @cpu: CPU for which to set performance controls.
> diff --git a/include/acpi/cppc_acpi.h b/include/acpi/cppc_acpi.h
> index 9f4985b4d64d..3fdae40a75fc 100644
> --- a/include/acpi/cppc_acpi.h
> +++ b/include/acpi/cppc_acpi.h
> @@ -137,6 +137,7 @@ struct cppc_cpudata {
>  extern int cppc_get_desired_perf(int cpunum, u64 *desired_perf);
>  extern int cppc_get_perf_ctrs(int cpu, struct cppc_perf_fb_ctrs *perf_fb_ctrs);
>  extern int cppc_set_perf(int cpu, struct cppc_perf_ctrls *perf_ctrls);
> +extern int cppc_set_enable(int cpu, u32 enable);
>  extern int cppc_get_perf_caps(int cpu, struct cppc_perf_caps *caps);
>  extern bool acpi_cpc_valid(void);
>  extern int acpi_get_psd_map(unsigned int cpu, struct cppc_cpudata *cpu_data);
> @@ -157,6 +158,10 @@ static inline int cppc_set_perf(int cpu, struct cppc_perf_ctrls *perf_ctrls)
>  {
>  	return -ENOTSUPP;
>  }
> +static inline int cppc_set_enable(int cpu, u32 enable)
> +{
> +	return -ENOTSUPP;
> +}
>  static inline int cppc_get_perf_caps(int cpu, struct cppc_perf_caps *caps)
>  {
>  	return -ENOTSUPP;
> -- 
> 2.25.1
> 

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-19.6 required=3.0 tests=BAYES_00,DKIMWL_WL_HIGH,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,NICE_REPLY_A,
	SPF_HELO_NONE,SPF_PASS,USER_AGENT_SANE_1 autolearn=unavailable
	autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 73142C433FE
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 20:00:10 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 53A7860EBA
	for <linux-kernel@archiver.kernel.org>; Wed,  8 Sep 2021 20:00:10 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1350715AbhIHUBR (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 16:01:17 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:51036 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1343558AbhIHUBP (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 16:01:15 -0400
Received: from mail-oo1-xc2f.google.com (mail-oo1-xc2f.google.com [IPv6:2607:f8b0:4864:20::c2f])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 4C76FC061575
        for <linux-kernel@vger.kernel.org>; Wed,  8 Sep 2021 13:00:07 -0700 (PDT)
Received: by mail-oo1-xc2f.google.com with SMTP id k20-20020a4ad114000000b0029133123994so1172094oor.4
        for <linux-kernel@vger.kernel.org>; Wed, 08 Sep 2021 13:00:07 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=linuxfoundation.org; s=google;
        h=subject:to:cc:references:from:message-id:date:user-agent
         :mime-version:in-reply-to:content-language:content-transfer-encoding;
        bh=RtxwRt2rTuC496QAV96NN3FjKBQdlap5HoR2ATAA9hU=;
        b=RsOiPsYODfTsIryeJE0IlLhSwf62h5Se7YksEGS0zegwU3Il8jCzlrJ5if1mEFhhWZ
         ydKf5ZGJ6tTV/T4rdQn0/ly2reLSXSyVv2w7UYsfWj56TP4Bkqsbt/pB9G03uZUbkKXL
         qWoY1WnDs4Stetsc1dJaf4YW/bNtlFlNXxvCk=
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20210112;
        h=x-gm-message-state:subject:to:cc:references:from:message-id:date
         :user-agent:mime-version:in-reply-to:content-language
         :content-transfer-encoding;
        bh=RtxwRt2rTuC496QAV96NN3FjKBQdlap5HoR2ATAA9hU=;
        b=jnxhVEm/tmaQQtb/KB+auAjlVww6kT7eX4eZiGlxfQxSTsAJv25tAeX2N5fCpHG1Th
         Bt5oouBMf+s3ElVo6lq6FBtq43cHyZG3GIab6KvbG65z4sWp/H7rVe0qbSU2Knwx0+Up
         TzxZV2EkTYD7AZWkKB3Kri/QfKRIFALOevMKWAp/MOwn/gXfemiPAl2MLHtLNnjF6P2j
         x9ss0jvm4fkSV7EFKFNAalX0a8g+toKww2OYucEb+040RuOOKLDeD+cvf0lRBjxWwBFW
         oshN+TwlYUDlDtAnX3izshmnimVJa/Utm0k1uLjYLYJbvzRCv/NvCC+Sqz9AcU+cchO7
         8OGQ==
X-Gm-Message-State: AOAM530neg4JxubvInlMtaR8EImzXmUNIrfhDxRtenezBW5+mxM+63ys
        IDB59TKjQYUho8ZfSXkj+vCzow==
X-Google-Smtp-Source: ABdhPJxVIKlbDojIl6ZNygmPq7kE1gZ8MAYMaX+VkWQ1Tv7ShdXJr5e2KhVp5DP7gFiCu0ty2mXMfQ==
X-Received: by 2002:a05:6820:613:: with SMTP id e19mr21508oow.67.1631131206643;
        Wed, 08 Sep 2021 13:00:06 -0700 (PDT)
Received: from [192.168.1.112] (c-24-9-64-241.hsd1.co.comcast.net. [24.9.64.241])
        by smtp.gmail.com with ESMTPSA id z18sm14301oib.27.2021.09.08.13.00.05
        (version=TLS1_3 cipher=TLS_AES_128_GCM_SHA256 bits=128/128);
        Wed, 08 Sep 2021 13:00:06 -0700 (PDT)
Subject: Re: [PATCH 01/19] x86/cpufreatures: add AMD CPPC extension feature
 flag
To:     Huang Rui <ray.huang@amd.com>,
        "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Borislav Petkov <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        linux-pm@vger.kernel.org
Cc:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        linux-kernel@vger.kernel.org, x86@kernel.org,
        Shuah Khan <skhan@linuxfoundation.org>
References: <20210908150001.3702552-1-ray.huang@amd.com>
 <20210908150001.3702552-2-ray.huang@amd.com>
From:   Shuah Khan <skhan@linuxfoundation.org>
Message-ID: <c8c57be3-5a86-062c-bd5c-5132d05dde3f@linuxfoundation.org>
Date:   Wed, 8 Sep 2021 14:00:04 -0600
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101
 Thunderbird/78.8.1
MIME-Version: 1.0
In-Reply-To: <20210908150001.3702552-2-ray.huang@amd.com>
Content-Type: text/plain; charset=utf-8; format=flowed
Content-Language: en-US
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On 9/8/21 8:59 AM, Huang Rui wrote:
> Add Collaborative Processor Performance Control Extension feature flag
> for AMD processors.
> 

Please add a couple of sentences about the feature and what it does.

> Signed-off-by: Huang Rui <ray.huang@amd.com>
> ---
>   arch/x86/include/asm/cpufeatures.h | 1 +
>   1 file changed, 1 insertion(+)
> 
> diff --git a/arch/x86/include/asm/cpufeatures.h b/arch/x86/include/asm/cpufeatures.h
> index d0ce5cfd3ac1..f7aea50e3371 100644
> --- a/arch/x86/include/asm/cpufeatures.h
> +++ b/arch/x86/include/asm/cpufeatures.h
> @@ -313,6 +313,7 @@
>   #define X86_FEATURE_AMD_SSBD		(13*32+24) /* "" Speculative Store Bypass Disable */
>   #define X86_FEATURE_VIRT_SSBD		(13*32+25) /* Virtualized Speculative Store Bypass Disable */
>   #define X86_FEATURE_AMD_SSB_NO		(13*32+26) /* "" Speculative Store Bypass is fixed in hardware. */
> +#define X86_FEATURE_AMD_CPPC_EXT	(13*32+27) /* Collaborative Processor Performance Control Extension */
>   
>   /* Thermal and Power Management Leaf, CPUID level 0x00000006 (EAX), word 14 */
>   #define X86_FEATURE_DTHERM		(14*32+ 0) /* Digital Thermal Sensor */
> 

thanks,
-- Shuah

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-19.6 required=3.0 tests=BAYES_00,DKIMWL_WL_HIGH,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,NICE_REPLY_A,
	SPF_HELO_NONE,SPF_PASS,URIBL_BLOCKED,USER_AGENT_SANE_1 autolearn=unavailable
	autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 97EC8C433F5
	for <linux-kernel@archiver.kernel.org>; Thu,  9 Sep 2021 00:21:53 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 66C0A610F8
	for <linux-kernel@archiver.kernel.org>; Thu,  9 Sep 2021 00:21:53 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1348517AbhIIAXA (ORCPT
        <rfc822;linux-kernel@archiver.kernel.org>);
        Wed, 8 Sep 2021 20:23:00 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:52818 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1348278AbhIIAW7 (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Wed, 8 Sep 2021 20:22:59 -0400
Received: from mail-il1-x12c.google.com (mail-il1-x12c.google.com [IPv6:2607:f8b0:4864:20::12c])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id EB934C061575
        for <linux-kernel@vger.kernel.org>; Wed,  8 Sep 2021 17:21:50 -0700 (PDT)
Received: by mail-il1-x12c.google.com with SMTP id u17so99392ilm.13
        for <linux-kernel@vger.kernel.org>; Wed, 08 Sep 2021 17:21:50 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=linuxfoundation.org; s=google;
        h=subject:to:cc:references:from:message-id:date:user-agent
         :mime-version:in-reply-to:content-language:content-transfer-encoding;
        bh=nyyS/oElz6G47rTDzdZzhnO3VTNUt3aMfsrZJACLUK0=;
        b=N5L/bm9EA0/nF7JHD2xJaQPzpZZRk1v2vACf8FEufoCSvSU8YbdLVMQPFyD2yH/Kak
         dz6PQRrAd7YoMFKhmDZ3MbwuL6DsalNHyEkUKqDa3VgtdcagOJz49keEgGweFupudCpO
         cdXd+GBZDP7gDDjrecBlYfx5cebdIHw4ckAdg=
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20210112;
        h=x-gm-message-state:subject:to:cc:references:from:message-id:date
         :user-agent:mime-version:in-reply-to:content-language
         :content-transfer-encoding;
        bh=nyyS/oElz6G47rTDzdZzhnO3VTNUt3aMfsrZJACLUK0=;
        b=NPqMC24XgE9BErdkq6u0Af1kD/jAHHU9xr5C6fXZuFI5F/VzRFvkTnvAsoIPpBeHXE
         veYBTOllTDI/chI1Cq3/AkK6aLIKZIGjDuElt4h2eWi+3YlQLp6NYC6xUeCe6d1zozCX
         A4CwGitsv8eSpGI7q4WKgjGzMmYL2vbNfxPIUoa002u11yJ8Qua5VMLg7A0+I1AW5615
         cRVXAOUroMREpoNtQGwOU61HmzD3n9sVN27tC86NJmF+tE9VdaZD1pStaENdXd+YRv1b
         +PWrRx6EDgkAJRf935RqCZjT77LQO9hDN+1tBxGsfWXi6++46x1RSxfrjOC3APwL6kud
         g2Og==
X-Gm-Message-State: AOAM530JB3ptGcpbVsfn2qVnVWMPRPkNYLWMycq3hO+h2xXY+bH/tkPB
        5FgPdhewwy8BgHDzVn6XGSVaxw==
X-Google-Smtp-Source: ABdhPJzpWC0pzdmX5gNMr3VJ2rqQkrO6po6sn3W5LyaZHqAAKLZ5NTPksOm5CJRcgUWrCECVlXV6Gg==
X-Received: by 2002:a92:c70e:: with SMTP id a14mr109747ilp.299.1631146909810;
        Wed, 08 Sep 2021 17:21:49 -0700 (PDT)
Received: from [192.168.1.112] (c-24-9-64-241.hsd1.co.comcast.net. [24.9.64.241])
        by smtp.gmail.com with ESMTPSA id d14sm122508iod.18.2021.09.08.17.21.48
        (version=TLS1_3 cipher=TLS_AES_128_GCM_SHA256 bits=128/128);
        Wed, 08 Sep 2021 17:21:49 -0700 (PDT)
Subject: Re: [PATCH 03/19] ACPI: CPPC: add cppc enable register function
To:     Huang Rui <ray.huang@amd.com>,
        "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Borislav Petkov <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        linux-pm@vger.kernel.org
Cc:     Deepak Sharma <deepak.sharma@amd.com>,
        Alex Deucher <alexander.deucher@amd.com>,
        Mario Limonciello <mario.limonciello@amd.com>,
        Nathan Fontenot <nathan.fontenot@amd.com>,
        Jinzhou Su <Jinzhou.Su@amd.com>,
        Xiaojian Du <Xiaojian.Du@amd.com>,
        linux-kernel@vger.kernel.org, x86@kernel.org,
        Shuah Khan <skhan@linuxfoundation.org>
References: <20210908150001.3702552-1-ray.huang@amd.com>
 <20210908150001.3702552-4-ray.huang@amd.com>
From:   Shuah Khan <skhan@linuxfoundation.org>
Message-ID: <e23d49d3-1591-bd12-549a-efd2a1f28dea@linuxfoundation.org>
Date:   Wed, 8 Sep 2021 18:21:48 -0600
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101
 Thunderbird/78.8.1
MIME-Version: 1.0
In-Reply-To: <20210908150001.3702552-4-ray.huang@amd.com>
Content-Type: text/plain; charset=utf-8; format=flowed
Content-Language: en-US
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On 9/8/21 8:59 AM, Huang Rui wrote:
> From: Jinzhou Su <Jinzhou.Su@amd.com>
> 
> Export the cppc enable register function for future use.

This patch also adds a new function. How about saying something about
adding a new function.

> 
> Signed-off-by: Jinzhou Su <Jinzhou.Su@amd.com>
> Signed-off-by: Huang Rui <ray.huang@amd.com>
> ---
>   drivers/acpi/cppc_acpi.c | 42 ++++++++++++++++++++++++++++++++++++++++
>   include/acpi/cppc_acpi.h |  5 +++++
>   2 files changed, 47 insertions(+)
> 
> diff --git a/drivers/acpi/cppc_acpi.c b/drivers/acpi/cppc_acpi.c
> index a4d4eebba1da..de4b30545215 100644
> --- a/drivers/acpi/cppc_acpi.c
> +++ b/drivers/acpi/cppc_acpi.c
> @@ -1220,6 +1220,48 @@ int cppc_get_perf_ctrs(int cpunum, struct cppc_perf_fb_ctrs *perf_fb_ctrs)
>   }
>   EXPORT_SYMBOL_GPL(cppc_get_perf_ctrs);
>   
> +/**
> + * cppc_set_enable - Set to enable CPPC register.

Please make this more descriptive - does it write to register
What is the behavior in error paths etc.

> + * @cpu: CPU for which to enable CPPC register.
> + * @enable: enable field to write into share memory.

What should this be? What are the valid values to write?
Also aren't we adding this to header file where prtotype
is defined these days?

> + *
> + * Return: 0 for success, -ERRNO otherwise.
> + */
> +int cppc_set_enable(int cpu, u32 enable)
> +{
> +	int pcc_ss_id = per_cpu(cpu_pcc_subspace_idx, cpu);
> +	struct cpc_register_resource *enable_reg;
> +	struct cpc_desc *cpc_desc = per_cpu(cpc_desc_ptr, cpu);
> +	struct cppc_pcc_data *pcc_ss_data = NULL;
> +	int ret = -1;
> +
> +	if (!cpc_desc) {
> +		pr_debug("No CPC descriptor for CPU:%d\n", cpu);
> +		return -ENODEV;
> +	}
> +

Don't we need to do some error checking on input args? What is the
valid range for cpu and enbale?

> +	enable_reg = &cpc_desc->cpc_regs[ENABLE];
> +
> +	if (CPC_IN_PCC(enable_reg)) {
> +
> +		if (pcc_ss_id < 0)
> +			return -EIO;
> +
> +		ret = cpc_write(cpu, enable_reg, enable);
> +		if (ret)
> +			return ret;
> +
> +		pcc_ss_data = pcc_data[pcc_ss_id];
> +
> +		down_write(&pcc_ss_data->pcc_lock);
> +		send_pcc_cmd(pcc_ss_id, CMD_WRITE);

Could this fail?

> +		up_write(&pcc_ss_data->pcc_lock);
> +	}
> +
> +	return ret;
> +}
> +EXPORT_SYMBOL_GPL(cppc_set_enable);
> +
>   /**
>    * cppc_set_perf - Set a CPU's performance controls.
>    * @cpu: CPU for which to set performance controls.
> diff --git a/include/acpi/cppc_acpi.h b/include/acpi/cppc_acpi.h
> index 9f4985b4d64d..3fdae40a75fc 100644
> --- a/include/acpi/cppc_acpi.h
> +++ b/include/acpi/cppc_acpi.h
> @@ -137,6 +137,7 @@ struct cppc_cpudata {
>   extern int cppc_get_desired_perf(int cpunum, u64 *desired_perf);
>   extern int cppc_get_perf_ctrs(int cpu, struct cppc_perf_fb_ctrs *perf_fb_ctrs);
>   extern int cppc_set_perf(int cpu, struct cppc_perf_ctrls *perf_ctrls);
> +extern int cppc_set_enable(int cpu, u32 enable);
>   extern int cppc_get_perf_caps(int cpu, struct cppc_perf_caps *caps);
>   extern bool acpi_cpc_valid(void);
>   extern int acpi_get_psd_map(unsigned int cpu, struct cppc_cpudata *cpu_data);
> @@ -157,6 +158,10 @@ static inline int cppc_set_perf(int cpu, struct cppc_perf_ctrls *perf_ctrls)
>   {
>   	return -ENOTSUPP;
>   }
> +static inline int cppc_set_enable(int cpu, u32 enable)
> +{
> +	return -ENOTSUPP;
> +}
>   static inline int cppc_get_perf_caps(int cpu, struct cppc_perf_caps *caps)
>   {
>   	return -ENOTSUPP;
> 

thanks,
-- Shuah

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-5.8 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,MAILING_LIST_MULTI,
	SPF_HELO_NONE,SPF_PASS autolearn=no autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 8D904C433FE
	for <linux-kernel@archiver.kernel.org>; Thu,  9 Sep 2021 09:46:50 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 66CB661131
	for <linux-kernel@archiver.kernel.org>; Thu,  9 Sep 2021 09:46:50 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233272AbhIIJr6 (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Thu, 9 Sep 2021 05:47:58 -0400
Received: from mail-dm6nam12on2076.outbound.protection.outlook.com ([40.107.243.76]:10337
        "EHLO NAM12-DM6-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S230145AbhIIJrs (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Thu, 9 Sep 2021 05:47:48 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=KLn6jC9GBATI7CajF7XOl9nv2L/RC7q6zo/tCLCuWZNIGNowl56lcghlUUmb/mE+TEvyeOTLzvgP5hZJWad1sPZbNY8sZMy9ipg58VLnhd46zyT1yk5h/REJatQ2Drt/3z7iQbSEc56rpmnvu88gdy00uY2s7cw2KUPeIjGcMRshRZeJl+nHYYXdWjmyqStgvaAFKGDtfYKkXRVu/8yN7aR+T34g64PhOhGHK9F8g3YCdah9lBfauj6NMXdRACM5EK7/ohddSqT2UVhXVJQcFHePdILzNpLd4fYpZ3Bknevk88vBTftkZKDV2jQrMEa3JgrOKPZ5i4Eog0thHsZyqw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=BU2VuCDQYyS3MqJC3JsnGsEp9mM4DdHBHoV7+JVGhS0=;
 b=i5yUnaMDdT1gW3pnUMk8MH0uVVGk62JSOcRtM4yUPQU/qrxwP84ddLVVeduqOsHmy1sS2UjpyIdPhBSR+tBTSmkKSngwnm32YY4hpwskhOkBLlbxQv0GOr6ie7/5DbGPssec+LNWvxWmSE/Q2Vh2Znji6is/XVHtNazuTf6gf4/nLEwLAjuJN/NZuX++fj4nbAwuRj6lj7HrmbA+9uHsiGX+2X74L6Bhbqt3tugqloYwsDNsHniMjTW2Nk6QrkvqjPavknnBXK2FgBi9VbuAi59YkgadYmkHpR/MK5K75hlGEdgmYM1rN3Z/ympTqKMTBdqkl2FVKvB5a7R1AGGTRw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=linuxfoundation.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=BU2VuCDQYyS3MqJC3JsnGsEp9mM4DdHBHoV7+JVGhS0=;
 b=JQdpr5i/vsUZLU22MJHmBDbRooHNE5f+70LGB3TnwrgtuqqTWTn1nXWJ1FG13knR6tmSEalH8lD8D3XHE+Egn6Q108ylhXPwMqsA6d9MfrJib7vrA0EW6wNnHhF0uFoZ5bWa0OmPMbH5nBSR/cY4VNPMTFLMsGXzul3Wc3b4CYU=
Received: from BN9PR03CA0401.namprd03.prod.outlook.com (2603:10b6:408:111::16)
 by CY4PR12MB1590.namprd12.prod.outlook.com (2603:10b6:910:a::8) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14; Thu, 9 Sep
 2021 09:46:35 +0000
Received: from BN8NAM11FT050.eop-nam11.prod.protection.outlook.com
 (2603:10b6:408:111:cafe::1) by BN9PR03CA0401.outlook.office365.com
 (2603:10b6:408:111::16) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.15 via Frontend
 Transport; Thu, 9 Sep 2021 09:46:35 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; linuxfoundation.org; dkim=none (message not signed)
 header.d=none;linuxfoundation.org; dmarc=pass action=none
 header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 BN8NAM11FT050.mail.protection.outlook.com (10.13.177.5) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Thu, 9 Sep 2021 09:46:35 +0000
Received: from hr-amd (10.180.168.240) by SATLEXMB04.amd.com (10.181.40.145)
 with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Thu, 9 Sep 2021
 04:46:31 -0500
Date:   Thu, 9 Sep 2021 17:45:38 +0800
From:   Huang Rui <ray.huang@amd.com>
To:     Shuah Khan <skhan@linuxfoundation.org>
CC:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Borislav Petkov <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        "linux-pm@vger.kernel.org" <linux-pm@vger.kernel.org>,
        "Sharma, Deepak" <Deepak.Sharma@amd.com>,
        "Deucher, Alexander" <Alexander.Deucher@amd.com>,
        "Limonciello, Mario" <Mario.Limonciello@amd.com>,
        "Fontenot, Nathan" <Nathan.Fontenot@amd.com>,
        "Su, Jinzhou (Joe)" <Jinzhou.Su@amd.com>,
        "Du, Xiaojian" <Xiaojian.Du@amd.com>,
        "linux-kernel@vger.kernel.org" <linux-kernel@vger.kernel.org>,
        "x86@kernel.org" <x86@kernel.org>
Subject: Re: [PATCH 01/19] x86/cpufreatures: add AMD CPPC extension feature
 flag
Message-ID: <20210909094538.GA3702717@hr-amd>
References: <20210908150001.3702552-1-ray.huang@amd.com>
 <20210908150001.3702552-2-ray.huang@amd.com>
 <c8c57be3-5a86-062c-bd5c-5132d05dde3f@linuxfoundation.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <c8c57be3-5a86-062c-bd5c-5132d05dde3f@linuxfoundation.org>
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: cbcb2fa3-55a7-455c-8b88-08d97376b6a1
X-MS-TrafficTypeDiagnostic: CY4PR12MB1590:
X-Microsoft-Antispam-PRVS: <CY4PR12MB1590B498C043CA98A3D7526DECD59@CY4PR12MB1590.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:2803;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: PocT39DiK2qq4gP40T8BAx5o1Ert2lrexefwf/157QcYVjGBj025Fzest0KNVVpX2WJAaMgegbixGEKZHrqdJnHjHvnRlpD0EDJBG+TGCEPoM5zdCJeGy0XriOCyyi2hUdfmL182YHh9mzqnjx3ormzJVLlDrtT3C10TF1IDDxWSwhge7qOHtQaOK7gxaGHYbTJkJ6tOznG0XZSZ82q8YvvVmjcQYo2GpH2KWsBHLlYCJJIz4Jbq1NxX2kRwBAHhH5F63vH7gP07TjOqQH+EmtgAEY3fQaYlb7D1hnFB5Ll07XuN9A6TSSSrAmjbydkW1hrU7JFEFroMIxHABkkP5BnYPic1XGK2Xqv/P2f4vbaAR6ZXGNc4D2dG3ubje3RvvLf11H1WcmM4R25tovW9QjzhZzkQYRhvUgK2rIEeFZTZnhBJMGLNruQIB36Yfx4cDEB1al7mGoXAxRRItWx1cYN3u3tuRG4Z5Vx8cdv/kXumzWH4xH9vYOXCArQEmz8/EDJe+1IQ9WXNrkzMn2PA1XL1LOYBKQWCf8Q++eWmf12p4ktSSJbdOZSR7xQzJHl9akZT+6acvoRGMI9NnDnwO+yFl1TT2fxm1aESTaz6spmj4BQEx6KPtaLHV9wN01LlWz6VFAZ1ke3PzVLjukuLjziA866tJJcWRCkFCE/rQ66dlwQuplWwDE0ZWCeqDaJZMEFzM0j3QvZfgVyP9eTFFpRSgjVpLCIs9lYTijAhvzs=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(136003)(39860400002)(376002)(396003)(346002)(46966006)(36840700001)(33656002)(336012)(316002)(47076005)(5660300002)(1076003)(8676002)(53546011)(82310400003)(478600001)(54906003)(86362001)(26005)(4744005)(4326008)(70206006)(82740400003)(186003)(2906002)(8936002)(55016002)(356005)(9686003)(6916009)(70586007)(81166007)(16526019)(426003)(33716001)(36860700001)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 09 Sep 2021 09:46:35.6582
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: cbcb2fa3-55a7-455c-8b88-08d97376b6a1
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: BN8NAM11FT050.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: CY4PR12MB1590
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Thu, Sep 09, 2021 at 04:00:04AM +0800, Shuah Khan wrote:
> On 9/8/21 8:59 AM, Huang Rui wrote:
> > Add Collaborative Processor Performance Control Extension feature flag
> > for AMD processors.
> > 
> 
> Please add a couple of sentences about the feature and what it does.

OK, will describe details at V2.

Thanks,
Ray

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-15.7 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,URIBL_BLOCKED
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 109EBC433EF
	for <linux-kernel@archiver.kernel.org>; Thu,  9 Sep 2021 09:51:13 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id E75E9611C0
	for <linux-kernel@archiver.kernel.org>; Thu,  9 Sep 2021 09:51:12 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233338AbhIIJwQ (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Thu, 9 Sep 2021 05:52:16 -0400
Received: from mail-co1nam11on2077.outbound.protection.outlook.com ([40.107.220.77]:23008
        "EHLO NAM11-CO1-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S233312AbhIIJwN (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Thu, 9 Sep 2021 05:52:13 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=E73k5m2U4nPTxF8PzgYDH31gcAH0tgV7qeB4rrbeWoiLf1o9Ko1X/l3JB5ryUtLFg1raHNjgefR03iu/BrpLJVKyoPauW/FFOZ3SQgwv1gu1wcYzgriFx11MhQW+OtSuU3M7HNA7NSdADUFhM/Z4QkknlyZ5fMLo4p2s73DopQnhfccvM42oTVXRxfAWpMTbTU1o46YdoeXzN2nJGkDl9CCBYyFrA2/T6OALqfQaES2ysv7OyRAn6lu5xUAba1DHZshU4lifdJNCjMa3p3qoTpaHEK8bdEVdjaaMqsHGDPE9D0QGMjZGjx6pxm5GEzAcWjNdxkjdwx/Ez9Y3fze5jw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=/4istKz3GQ1avnSSWP6D4xMPzHAixO6sfAz8BvcblBg=;
 b=gZA0fSgru+kGrfigPi+dx5SZFjKCni2edr/N+1WGyFrTSvKahcSsJ0NCKMQQzpFYnS34l/s5xZz5G4mTAsfuN456QQoSxPnjBOx550MAE/eZJb0kFrveW0CrL9jOxW8EDPDHi8taYdyWcgsLohCqPGm5A8evcFIC/SkfVkyLtYAcZL9tnxTJm7uZOX1hS20bcG5PeP/yjp5gGHYeBMxQI7lt31cz1xwoNpLA117T2wGUT+rnKtblHYjI6dwMkiqWupZOVjYwiEg3i0GrSsPymlWt4QS7y6QiItKfoHvVAaikx+eeyprQEwE9/++d8jyHhoTx52t3+HKRBkTIhoA7jQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=/4istKz3GQ1avnSSWP6D4xMPzHAixO6sfAz8BvcblBg=;
 b=vcFUKvZZjEd/r7P1MnRBr2NNGdEM4FB3BTn6Hc+3QuHYFYa5Y+FoHCWCD46/IF97CLQzBpOieUyGJPN8D6Q0UMjjb1a5cMM7p9MkNCfTalhQd4Cg+HRlaUuGN0WTPjT+pKqvGsXg+it0kU6jOurg8MauPBGg/+5rDGZ6chnkhMA=
Received: from BN0PR08CA0016.namprd08.prod.outlook.com (2603:10b6:408:142::35)
 by DM6PR12MB4233.namprd12.prod.outlook.com (2603:10b6:5:210::21) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14; Thu, 9 Sep
 2021 09:51:01 +0000
Received: from BN8NAM11FT059.eop-nam11.prod.protection.outlook.com
 (2603:10b6:408:142:cafe::35) by BN0PR08CA0016.outlook.office365.com
 (2603:10b6:408:142::35) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Thu, 9 Sep 2021 09:51:01 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 BN8NAM11FT059.mail.protection.outlook.com (10.13.177.120) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Thu, 9 Sep 2021 09:51:01 +0000
Received: from hr-amd (10.180.168.240) by SATLEXMB04.amd.com (10.181.40.145)
 with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Thu, 9 Sep 2021
 04:50:58 -0500
Date:   Thu, 9 Sep 2021 17:50:04 +0800
From:   Huang Rui <ray.huang@amd.com>
To:     "Fontenot, Nathan" <Nathan.Fontenot@amd.com>
CC:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        "linux-pm@vger.kernel.org" <linux-pm@vger.kernel.org>,
        "Sharma, Deepak" <Deepak.Sharma@amd.com>,
        "Deucher, Alexander" <Alexander.Deucher@amd.com>,
        "Limonciello, Mario" <Mario.Limonciello@amd.com>,
        "Su, Jinzhou (Joe)" <Jinzhou.Su@amd.com>,
        "Du, Xiaojian" <Xiaojian.Du@amd.com>,
        "linux-kernel@vger.kernel.org" <linux-kernel@vger.kernel.org>,
        "x86@kernel.org" <x86@kernel.org>
Subject: Re: [PATCH 03/19] ACPI: CPPC: add cppc enable register function
Message-ID: <20210909094946.GB3702717@hr-amd>
References: <20210908150001.3702552-1-ray.huang@amd.com>
 <20210908150001.3702552-4-ray.huang@amd.com>
 <53962105-07cb-d964-28d0-1cc4d2e7fe8b@amd.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <53962105-07cb-d964-28d0-1cc4d2e7fe8b@amd.com>
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB03.amd.com (10.181.40.144) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 7d5aa2aa-5232-4339-dae7-08d973775540
X-MS-TrafficTypeDiagnostic: DM6PR12MB4233:
X-Microsoft-Antispam-PRVS: <DM6PR12MB4233A7768D5950746317858BECD59@DM6PR12MB4233.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:4941;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: W/IWefASlVr+saURtxg9GuUf9ReU7/egM3xMe22KFvQTkq8BHBoldEJoSghD9+xpp6LO9qoxS/TuPnE15Us0CiFwAOBeEeSDgNXaQy7PcqHCeu93eQmNb1vf27FSH/X4MtqjOe2yizIpRiq0WeVT52IGyM9yvu/tcLx3MIjvTMwFB31GbGnT0EVIwL/aB8vMKVp/pTSZRziYUQZtq6BKWSb1ymQnL2V0BHf+bB6NRqh5EBGlcRsFLGCTxHQ24QYmFS+l382eOCweEncEbPUWpOIObrgxf3MHo1F2KtFT7rCu8VMxTg/1pf+wiJxUO49ilF0bsu7CD3d6Fgxf746IldeT2lg/81lIiZUvsb5CNF7WPSuA6AGHmrbiRF1rjR55weWbgFaedzyUkhpaZjVBu9hXAHdwNvKpS/gI3OklEJpi4Hd7FLuh2aJ+Y6Tu0ObFz4dew5VHrcVS4AzEPA92LEWepVLnUwQDe+VSSc7zoeA+VzAdClVs7CCn610gKKUNGWdBeZ8UuYss7HG3VCbtq87/BzgMol3KDW28zAlWR7Lvgwtdt2PK/JFUa/LqbXNcwtrWrfaSXQRwJEULxn85cK9IOOUkqzmrM7il/IuDuB2tf9jtteLaXx8yQkSK2Ek+qMvhZbN9yOVDC1yQqkLODR+yZdXFwHBEkur1yv3HcCHCOH8dVXo3xxydEIIik8roq49lsvX1Yy5Lqw8z2NeELWPqBWkpFafs1EC1k9owN9I=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(136003)(396003)(346002)(39860400002)(376002)(36840700001)(46966006)(82310400003)(6636002)(4326008)(6862004)(33716001)(2906002)(82740400003)(336012)(6666004)(5660300002)(33656002)(70206006)(8676002)(26005)(16526019)(186003)(53546011)(70586007)(8936002)(426003)(83380400001)(316002)(36860700001)(47076005)(86362001)(54906003)(1076003)(55016002)(9686003)(478600001)(81166007)(356005)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 09 Sep 2021 09:51:01.7822
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 7d5aa2aa-5232-4339-dae7-08d973775540
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: BN8NAM11FT059.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB4233
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Thu, Sep 09, 2021 at 03:14:37AM +0800, Fontenot, Nathan wrote:
> On 9/8/2021 9:59 AM, Huang Rui wrote:
> > From: Jinzhou Su <Jinzhou.Su@amd.com>
> > 
> > Export the cppc enable register function for future use.
> > 
> > Signed-off-by: Jinzhou Su <Jinzhou.Su@amd.com>
> > Signed-off-by: Huang Rui <ray.huang@amd.com>
> > ---
> >  drivers/acpi/cppc_acpi.c | 42 ++++++++++++++++++++++++++++++++++++++++
> >  include/acpi/cppc_acpi.h |  5 +++++
> >  2 files changed, 47 insertions(+)
> > 
> > diff --git a/drivers/acpi/cppc_acpi.c b/drivers/acpi/cppc_acpi.c
> > index a4d4eebba1da..de4b30545215 100644
> > --- a/drivers/acpi/cppc_acpi.c
> > +++ b/drivers/acpi/cppc_acpi.c
> > @@ -1220,6 +1220,48 @@ int cppc_get_perf_ctrs(int cpunum, struct cppc_perf_fb_ctrs *perf_fb_ctrs)
> >  }
> >  EXPORT_SYMBOL_GPL(cppc_get_perf_ctrs);
> >  
> > +/**
> > + * cppc_set_enable - Set to enable CPPC register.
> > + * @cpu: CPU for which to enable CPPC register.
> > + * @enable: enable field to write into share memory.
> > + *
> > + * Return: 0 for success, -ERRNO otherwise.
> > + */
> > +int cppc_set_enable(int cpu, u32 enable)
> > +{
> > +	int pcc_ss_id = per_cpu(cpu_pcc_subspace_idx, cpu);
> > +	struct cpc_register_resource *enable_reg;
> > +	struct cpc_desc *cpc_desc = per_cpu(cpc_desc_ptr, cpu);
> > +	struct cppc_pcc_data *pcc_ss_data = NULL;
> > +	int ret = -1;
> > +
> > +	if (!cpc_desc) {
> > +		pr_debug("No CPC descriptor for CPU:%d\n", cpu);
> > +		return -ENODEV;
> > +	}
> > +
> > +	enable_reg = &cpc_desc->cpc_regs[ENABLE];
> > +
> > +	if (CPC_IN_PCC(enable_reg)) {
> > +
> > +		if (pcc_ss_id < 0)
> > +			return -EIO;
> > +
> > +		ret = cpc_write(cpu, enable_reg, enable);
> > +		if (ret)
> > +			return ret;
> > +
> > +		pcc_ss_data = pcc_data[pcc_ss_id];
> > +
> > +		down_write(&pcc_ss_data->pcc_lock);
> > +		send_pcc_cmd(pcc_ss_id, CMD_WRITE);
> 
> Shouldn't we be checking the return value from send_pcc_cmd()?
> 
> Also, if the call to send_pcc_cmd() fails do we need to update
> enable_reg? i.e. cpc_write(..., !enable);
> 

Sounds reasonable. I will modify this in V2.

Thanks,
Ray

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-15.7 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,URIBL_BLOCKED
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 4DEACC433EF
	for <linux-kernel@archiver.kernel.org>; Thu,  9 Sep 2021 09:59:19 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 2AA86611AD
	for <linux-kernel@archiver.kernel.org>; Thu,  9 Sep 2021 09:59:19 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233426AbhIIKAY (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Thu, 9 Sep 2021 06:00:24 -0400
Received: from mail-mw2nam10on2076.outbound.protection.outlook.com ([40.107.94.76]:56655
        "EHLO NAM10-MW2-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S232630AbhIIKAX (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Thu, 9 Sep 2021 06:00:23 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=Jrtm6i0FOJNQEEbcW5B/AeUTGpgDWbOAEY+a6G7LPMeq+qTTSCPB0qfXqrSOWBpvAS1pg290ll6d492iTxwMEJbZDf8SzTfI2AGPYr5FnO01P9NF1SHXtif313W7ytXHyWa4+oXpc/RQGgNOySCwn8L5lFqKQd6mfQXMoMPkuaxxDgwwMY7oQigtIVNIkv8aYGGyK4/z5HYcMV5fHgBUC/B0fCTFtvBE0a+ZXzeWSrRO4bi9oWI+0aGGihgvQg2nge5AziFvn3k4en/wl9ZvIphzBoLDfhvbzwJl1T8JISwm63D/lnfsnh2msRy5e+FuN4o7QfEer4HvqUCQKCihfQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=nOQoa0XYR4Lbzw8nDM3vWdwB2ok2bND8sQwbjwl1QGg=;
 b=Z9yNLKePaKhn1kXTjX7qxHFNulY2sIXcWD82zNDjoGzAsiryppL32sQ42yGpSrJyv2a4InLYTAfmF6dXJRSIiqSh1p5/A4q+zr5IT/w6IXdpgOpi260s9TyfdafG/YxaHghC9VGVTE+16y1bUlwWFGOYtKMPHBK1t1vcsoj2ohBdsWF+KkXMM3AM+1/UnOabQ2QA5TCAhsa1sFL3RUe6iXK3niiVVdJ438g66sTXKsUF5xaoUWjRLH9Pygzp2G7FNtH1Mesh9E1cBx8h9ui0g+uA8mj+gXeDJt3EEz6A5iA5N7c+lVtPhLeRKq14BKfQAb4Yk/UeciCHXXe24VrA5A==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=linuxfoundation.org smtp.mailfrom=amd.com;
 dmarc=pass (p=quarantine sp=quarantine pct=100) action=none
 header.from=amd.com; dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=nOQoa0XYR4Lbzw8nDM3vWdwB2ok2bND8sQwbjwl1QGg=;
 b=b/1MnDNhRaG9vYjbWfg3mAiyjDyZipmhBYGRWpIak0yskyTvK5tMNXya5s/yY2yX9H0uSIm3aidqnsZHZK3K6tSsCkulypBPVVMuJLyfFGduYEb4eOVgExkoGK8oWWhQvVIGCvitmq68CVLy8cKtgaSChAHV97hcyIbxxgDHrrA=
Received: from DM6PR07CA0101.namprd07.prod.outlook.com (2603:10b6:5:337::34)
 by MW2PR12MB2553.namprd12.prod.outlook.com (2603:10b6:907:9::32) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14; Thu, 9 Sep
 2021 09:59:12 +0000
Received: from DM6NAM11FT012.eop-nam11.prod.protection.outlook.com
 (2603:10b6:5:337:cafe::65) by DM6PR07CA0101.outlook.office365.com
 (2603:10b6:5:337::34) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Thu, 9 Sep 2021 09:59:12 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; linuxfoundation.org; dkim=none (message not signed)
 header.d=none;linuxfoundation.org; dmarc=pass action=none
 header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 DM6NAM11FT012.mail.protection.outlook.com (10.13.173.109) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Thu, 9 Sep 2021 09:59:12 +0000
Received: from hr-amd (10.180.168.240) by SATLEXMB04.amd.com (10.181.40.145)
 with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Thu, 9 Sep 2021
 04:59:08 -0500
Date:   Thu, 9 Sep 2021 17:58:13 +0800
From:   Huang Rui <ray.huang@amd.com>
To:     Shuah Khan <skhan@linuxfoundation.org>
CC:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Borislav Petkov <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        "linux-pm@vger.kernel.org" <linux-pm@vger.kernel.org>,
        "Sharma, Deepak" <Deepak.Sharma@amd.com>,
        "Deucher, Alexander" <Alexander.Deucher@amd.com>,
        "Limonciello, Mario" <Mario.Limonciello@amd.com>,
        "Fontenot, Nathan" <Nathan.Fontenot@amd.com>,
        "Su, Jinzhou (Joe)" <Jinzhou.Su@amd.com>,
        "Du, Xiaojian" <Xiaojian.Du@amd.com>,
        "linux-kernel@vger.kernel.org" <linux-kernel@vger.kernel.org>,
        "x86@kernel.org" <x86@kernel.org>
Subject: Re: [PATCH 03/19] ACPI: CPPC: add cppc enable register function
Message-ID: <20210909095813.GC3702717@hr-amd>
References: <20210908150001.3702552-1-ray.huang@amd.com>
 <20210908150001.3702552-4-ray.huang@amd.com>
 <e23d49d3-1591-bd12-549a-efd2a1f28dea@linuxfoundation.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <e23d49d3-1591-bd12-549a-efd2a1f28dea@linuxfoundation.org>
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 1144265b-45ba-4d15-8290-08d9737879b5
X-MS-TrafficTypeDiagnostic: MW2PR12MB2553:
X-Microsoft-Antispam-PRVS: <MW2PR12MB2553696ACA4D86BB3D80FFDCECD59@MW2PR12MB2553.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:7691;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: pDzY+D/ByjFm2MthZHKfpg0ri3VfTbiECsO7Gfn/fMWfAGiP+W7OaT1cLxpeeh6g6uj+tSg0rqc4pWKLJC/ekM2P3BKHX4NSS+KbupVmczFQCQuKyCiIIucUz6bxXJshBPDvAjSR7PNORyP8rAc3DeYhHjN1/IXGl8xv5e9V7aQbogyn6ICRBBn0r/a4a0G02XaOtsolO1uBED+4b9jg5tj2kQ39tjayWEW9VaDxyzMDby5dAGSjrlFAXVTkHu6rP3K1PxWuzvHYpk8JmDt+S7ST9QPnToYPzfcz0Yossgr7VAa5Z/LqV9JXXr34T+xKQNYbkh6vWu8aF5vFKH1hpeSPidwrGsXdUb+6Qlo/k5Z7cJk6rUWxNVwUKcWnCEyOq+VkjH8TApf0Cm6VN+GLqFsXSm7pt/eRm9PiLYtAm8aUJ1HDmlP+gsXC5aCTO33Q7dxgFmmhacLO/2Xjw2H4qw1gf7tFlgOpHUAd98sRV07hpYMQTbTSsK1ES9KwkvCfJCzbKlSSSOmv3GicdSCs/qL+H/sI39qzWtUIz0OUCV6HHTM3p0jWEsS5DlVhWBPAD/gvk/Lhf2/R8xhttuzwmVV/G08r15F1XIEksWwwfY3JnvMaAHVgtKRb1k6S8OVyQMcgBnNkEyVeee+SlzAD6lPniWB2UHbyC34K/De9ZhBhU59BBgZN6w3hxZ7aOC4k5+AQbDjIed7MR0OsJdZsSQy4Gk74tH6mkY1es3f4LpY=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(346002)(39860400002)(136003)(376002)(396003)(36840700001)(46966006)(70206006)(426003)(54906003)(336012)(36860700001)(5660300002)(55016002)(86362001)(8676002)(82740400003)(316002)(478600001)(81166007)(6916009)(53546011)(356005)(33656002)(4326008)(26005)(9686003)(83380400001)(186003)(70586007)(47076005)(16526019)(6666004)(2906002)(33716001)(8936002)(82310400003)(1076003)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 09 Sep 2021 09:59:12.3930
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 1144265b-45ba-4d15-8290-08d9737879b5
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: DM6NAM11FT012.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MW2PR12MB2553
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Thu, Sep 09, 2021 at 08:21:48AM +0800, Shuah Khan wrote:
> On 9/8/21 8:59 AM, Huang Rui wrote:
> > From: Jinzhou Su <Jinzhou.Su@amd.com>
> > 
> > Export the cppc enable register function for future use.
> 
> This patch also adds a new function. How about saying something about
> adding a new function.
> 
> > 
> > Signed-off-by: Jinzhou Su <Jinzhou.Su@amd.com>
> > Signed-off-by: Huang Rui <ray.huang@amd.com>
> > ---
> >   drivers/acpi/cppc_acpi.c | 42 ++++++++++++++++++++++++++++++++++++++++
> >   include/acpi/cppc_acpi.h |  5 +++++
> >   2 files changed, 47 insertions(+)
> > 
> > diff --git a/drivers/acpi/cppc_acpi.c b/drivers/acpi/cppc_acpi.c
> > index a4d4eebba1da..de4b30545215 100644
> > --- a/drivers/acpi/cppc_acpi.c
> > +++ b/drivers/acpi/cppc_acpi.c
> > @@ -1220,6 +1220,48 @@ int cppc_get_perf_ctrs(int cpunum, struct cppc_perf_fb_ctrs *perf_fb_ctrs)
> >   }
> >   EXPORT_SYMBOL_GPL(cppc_get_perf_ctrs);
> >   
> > +/**
> > + * cppc_set_enable - Set to enable CPPC register.
> 
> Please make this more descriptive - does it write to register
> What is the behavior in error paths etc.
> 
> > + * @cpu: CPU for which to enable CPPC register.
> > + * @enable: enable field to write into share memory.
> 
> What should this be? What are the valid values to write?
> Also aren't we adding this to header file where prtotype
> is defined these days?

Thank you for the suggestions, I will refine the comments and commmit log
in V2.

> 
> > + *
> > + * Return: 0 for success, -ERRNO otherwise.
> > + */
> > +int cppc_set_enable(int cpu, u32 enable)
> > +{
> > +	int pcc_ss_id = per_cpu(cpu_pcc_subspace_idx, cpu);
> > +	struct cpc_register_resource *enable_reg;
> > +	struct cpc_desc *cpc_desc = per_cpu(cpc_desc_ptr, cpu);
> > +	struct cppc_pcc_data *pcc_ss_data = NULL;
> > +	int ret = -1;
> > +
> > +	if (!cpc_desc) {
> > +		pr_debug("No CPC descriptor for CPU:%d\n", cpu);
> > +		return -ENODEV;
> > +	}
> > +
> 
> Don't we need to do some error checking on input args? What is the
> valid range for cpu and enbale?

Good point.

> 
> > +	enable_reg = &cpc_desc->cpc_regs[ENABLE];
> > +
> > +	if (CPC_IN_PCC(enable_reg)) {
> > +
> > +		if (pcc_ss_id < 0)
> > +			return -EIO;
> > +
> > +		ret = cpc_write(cpu, enable_reg, enable);
> > +		if (ret)
> > +			return ret;
> > +
> > +		pcc_ss_data = pcc_data[pcc_ss_id];
> > +
> > +		down_write(&pcc_ss_data->pcc_lock);
> > +		send_pcc_cmd(pcc_ss_id, CMD_WRITE);
> 
> Could this fail?

Will add error handling in V2.

Thanks,
Ray

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-15.7 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,URIBL_BLOCKED
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 11ECAC433F5
	for <linux-kernel@archiver.kernel.org>; Thu,  9 Sep 2021 10:00:46 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id E6055611AD
	for <linux-kernel@archiver.kernel.org>; Thu,  9 Sep 2021 10:00:45 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233833AbhIIKBw (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Thu, 9 Sep 2021 06:01:52 -0400
Received: from mail-bn7nam10on2069.outbound.protection.outlook.com ([40.107.92.69]:52864
        "EHLO NAM10-BN7-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S233436AbhIIKBp (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Thu, 9 Sep 2021 06:01:45 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=Ev+Rs9s5H2WSpMUWTLvIaY/ux/Nvldot/WkNCMYIFT+gYmZ8/XvaA5USUelYab2obdkxkHn4hqMbgU1mxMWG0zR/CXEqc5YaBv12BdQOD0tWbjdgQU701A3kEZgj0BnYhD7yHydumVJtTG4PWBoKUNgu5GFMw3ZQM2F9g7W58svr/6ii1n3BI9es6MRDYqzNB06j9Cochdfsbfkh2oWQZZl7krznGR9Pt0493BVR1F+3bPAiQtPqIzgCP0ZNGOr1JAqUL5EaUWIJoPGqXB2+iySB8JCZoiJFA0K6rw4jDrA57bKjquZdlGdpVcA1tR6SMSDX5A8H1LsZzBF15pKooQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=m3QpiA6+N9k3zNpTsG9eJkoywck3AF64rSThH06iuko=;
 b=Ld+PrftCtwqYH+IR7ZUZ1DeEkTCzlvycENWsr8l9TKAmpHQyNdtjbYOtWeVUYqoIzFJPm6coQfgwEB1zq16sTnMdDpdeRrQBi3SvU7JWtFkCWOQQAVx2vT1Yc47qlG3IsVo6tGCI5+W+PDdZ79Edn+OSbwyhqL6Eq6CsZhwzkveOJn1upBzLt5UvQQAqmtyYgE2WLC67Kgmn2c3ZAVR67QIgarVuii9cKSq5zJox5cVULnkAJNzfwIwd3T5HZaukCjo/O/HAExw4NdcVOckUZtkWAgP75oYzezDcenFNu0qGtaTdD54RFniOgrQvhO4nVqgr/tlcVJp6eYvpHwSKTw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=m3QpiA6+N9k3zNpTsG9eJkoywck3AF64rSThH06iuko=;
 b=YAKnoXrSH/USjL5zqtbCmGOIXFx4VCvzQH0EGgunOc6H+QuZcUQVnGsS60vUF+mR3A584VDYgcqyRo5iwGtnNvXu+Skxw9fgenjxHz4KUE79uXEq1Yo1h0RwXStRBcjJ54q4S4QrZOM3c8PMIMO3RAT7Zzk3wYy1ZNa/hgfvtbk=
Received: from DM6PR08CA0024.namprd08.prod.outlook.com (2603:10b6:5:80::37) by
 MWHPR12MB1613.namprd12.prod.outlook.com (2603:10b6:301:11::16) with Microsoft
 SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.20.4500.14; Thu, 9 Sep 2021 10:00:31 +0000
Received: from DM6NAM11FT021.eop-nam11.prod.protection.outlook.com
 (2603:10b6:5:80:cafe::55) by DM6PR08CA0024.outlook.office365.com
 (2603:10b6:5:80::37) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.14 via Frontend
 Transport; Thu, 9 Sep 2021 10:00:31 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 DM6NAM11FT021.mail.protection.outlook.com (10.13.173.76) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Thu, 9 Sep 2021 10:00:31 +0000
Received: from hr-amd (10.180.168.240) by SATLEXMB04.amd.com (10.181.40.145)
 with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Thu, 9 Sep 2021
 05:00:27 -0500
Date:   Thu, 9 Sep 2021 17:59:33 +0800
From:   Huang Rui <ray.huang@amd.com>
To:     "Fontenot, Nathan" <Nathan.Fontenot@amd.com>
CC:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        "linux-pm@vger.kernel.org" <linux-pm@vger.kernel.org>,
        "Sharma, Deepak" <Deepak.Sharma@amd.com>,
        "Deucher, Alexander" <Alexander.Deucher@amd.com>,
        "Limonciello, Mario" <Mario.Limonciello@amd.com>,
        "Su, Jinzhou (Joe)" <Jinzhou.Su@amd.com>,
        "Du, Xiaojian" <Xiaojian.Du@amd.com>,
        "linux-kernel@vger.kernel.org" <linux-kernel@vger.kernel.org>,
        "x86@kernel.org" <x86@kernel.org>
Subject: Re: [PATCH 16/19] cpupower: enable boost state support for
 amd-pstate module
Message-ID: <20210909095933.GD3702717@hr-amd>
References: <20210908150001.3702552-1-ray.huang@amd.com>
 <20210908150001.3702552-17-ray.huang@amd.com>
 <5353e053-084d-9a29-bae5-c1e1d597d1e3@amd.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <5353e053-084d-9a29-bae5-c1e1d597d1e3@amd.com>
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB04.amd.com (10.181.40.145) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 6307a7fb-0c34-4691-a4c0-08d97378a8f2
X-MS-TrafficTypeDiagnostic: MWHPR12MB1613:
X-Microsoft-Antispam-PRVS: <MWHPR12MB16139D35B951BA6FB24A1016ECD59@MWHPR12MB1613.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:3383;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: U5U8NdvgSAQMGsew/3TykHJd0Rs7yyDYzkqielf9xfWeAGN7tBWh9k1RYHc6hqPunEPhGsgn4fTDlTdnnauf+FIwAPIAeSk+ZqDIreQilDSij/yTarP7SP9XIZXi0QBIIVX35eD7Mz3Z9OcWSEM7tJC0TPbzdGHVMiZDjxfqHYWKv14JN12rEigue/9X5L7+XbtqFmPknHAJZLwNTeqlufhSG0Bv5VDNz5mRN9qUZ0EDrh338nAkHONli5qZAkEDO5RnzyjOyuM1IfcyI4o2d/Qf0JrJbI3xVVM8oEsVtiKQj4mDettaL4ybRyJN2JVzByAl96QwuEywGkxgnAjJMn9PBJM7Iwj8Zou+QEgIxXg44URE7KYJYXt9kWNioaBWNAeKHeiD2P2F7Ai5yqcZoSgpxWy0eG+X+9XnazpmTKqALGZWpvgXZ5PomKctoLSoHI6sNIwTXjEedZNpBG4OhKeEB3z6mb+JZ4DeNVIkrSq4EfY1Jwzes8D7VsybA5YG5Yj0EuvsLMoL9G7gqy0far6XpcPXjf7xcPaf/yjcAgJe6SFGOE3GmRgTQISaHB1XUAK3ZSttqkdcghQ83JWTzvcBrgROEa8p9CqzJf9GPZ6/PXd5nokzsgOpoCkosVNtcLjig00HgQbSmexyidEoRtaPp7UNcS48VKlOz3Qwkytl+VaJrQQ5LMEpF5fqssASF7scokq1T6XHCPu4E0j6MkUXWGy/GQg/mx1dhnZzqeg=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(39860400002)(376002)(346002)(396003)(136003)(36840700001)(46966006)(478600001)(70206006)(426003)(70586007)(33716001)(47076005)(6636002)(4326008)(82740400003)(9686003)(336012)(1076003)(8936002)(316002)(81166007)(2906002)(6862004)(8676002)(356005)(54906003)(186003)(82310400003)(26005)(86362001)(36860700001)(5660300002)(16526019)(6666004)(53546011)(33656002)(55016002)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 09 Sep 2021 10:00:31.6400
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 6307a7fb-0c34-4691-a4c0-08d97378a8f2
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: DM6NAM11FT021.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: MWHPR12MB1613
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Thu, Sep 09, 2021 at 01:32:37AM +0800, Fontenot, Nathan wrote:
> On 9/8/2021 9:59 AM, Huang Rui wrote:
> > The AMD P-state boost API is different from ACPI hardware P-states, so
> > implement the support for amd-pstate kernel module.
> > 
> > Signed-off-by: Huang Rui <ray.huang@amd.com>
> > ---
> >  tools/power/cpupower/lib/cpufreq.c        | 20 ++++++++++++++++++++
> >  tools/power/cpupower/lib/cpufreq.h        |  3 +++
> >  tools/power/cpupower/utils/helpers/misc.c |  7 +++++++
> >  3 files changed, 30 insertions(+)
> > 
> > diff --git a/tools/power/cpupower/lib/cpufreq.c b/tools/power/cpupower/lib/cpufreq.c
> > index 3f92ddadaad2..37da87bdcfb1 100644
> > --- a/tools/power/cpupower/lib/cpufreq.c
> > +++ b/tools/power/cpupower/lib/cpufreq.c
> > @@ -790,3 +790,23 @@ unsigned long cpufreq_get_transitions(unsigned int cpu)
> >  {
> >  	return sysfs_cpufreq_get_one_value(cpu, STATS_NUM_TRANSITIONS);
> >  }
> > +
> > +int amd_pstate_boost_support(unsigned int cpu)
> > +{
> > +	unsigned int highest_perf, nominal_perf;
> > +
> > +	highest_perf = sysfs_cpufreq_get_one_value(cpu, AMD_PSTATE_HIGHEST_PERF);
> > +	nominal_perf = sysfs_cpufreq_get_one_value(cpu, AMD_PSTATE_NOMINAL_PERF);
> > +
> > +	return highest_perf > nominal_perf ? 1 : 0;
> > +}
> > +
> > +int amd_pstate_boost_enabled(unsigned int cpu)
> > +{
> > +	unsigned int cpuinfo_max, amd_pstate_max;
> > +
> > +	cpuinfo_max = sysfs_cpufreq_get_one_value(cpu, CPUINFO_MAX_FREQ);
> > +	amd_pstate_max = sysfs_cpufreq_get_one_value(cpu, AMD_PSTATE_MAX_FREQ);
> > +
> > +	return cpuinfo_max == amd_pstate_max ? 1 : 0;
> > +}
> > diff --git a/tools/power/cpupower/lib/cpufreq.h b/tools/power/cpupower/lib/cpufreq.h
> > index 95f4fd9e2656..d54d02a7a4f4 100644
> > --- a/tools/power/cpupower/lib/cpufreq.h
> > +++ b/tools/power/cpupower/lib/cpufreq.h
> > @@ -203,6 +203,9 @@ int cpufreq_modify_policy_governor(unsigned int cpu, char *governor);
> >  int cpufreq_set_frequency(unsigned int cpu,
> >  				unsigned long target_frequency);
> >  
> > +int amd_pstate_boost_support(unsigned int cpu);
> > +int amd_pstate_boost_enabled(unsigned int cpu);
> > +
> >  #ifdef __cplusplus
> >  }
> >  #endif
> > diff --git a/tools/power/cpupower/utils/helpers/misc.c b/tools/power/cpupower/utils/helpers/misc.c
> > index 07d80775fb68..aba979320760 100644
> > --- a/tools/power/cpupower/utils/helpers/misc.c
> > +++ b/tools/power/cpupower/utils/helpers/misc.c
> > @@ -10,6 +10,7 @@
> >  #if defined(__i386__) || defined(__x86_64__)
> >  
> >  #include "cpupower_intern.h"
> > +#include "cpufreq.h"
> >  
> >  #define MSR_AMD_HWCR	0xc0010015
> >  
> > @@ -39,6 +40,12 @@ int cpufreq_has_boost_support(unsigned int cpu, int *support, int *active,
> >  			if (ret)
> >  				return ret;
> >  		}
> > +	} if ((cpupower_cpu_info.caps & CPUPOWER_CAP_AMD_PSTATE) &&
> 
> Shouldn't this be
> 
> 	} else if ((cpupower_cpu_info.caps & CPUPOWER_CAP_AMD_PSTATE) &&
> 

Nice catch, it's my typo.

Thanks,
Ray

From mboxrd@z Thu Jan  1 00:00:00 1970
Return-Path: <linux-kernel-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-15.7 required=3.0 tests=BAYES_00,DKIM_SIGNED,
	DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,INCLUDES_CR_TRAILER,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,URIBL_BLOCKED
	autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id D5B0EC433EF
	for <linux-kernel@archiver.kernel.org>; Thu,  9 Sep 2021 10:13:52 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id B42EE611B0
	for <linux-kernel@archiver.kernel.org>; Thu,  9 Sep 2021 10:13:52 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230274AbhIIKPA (ORCPT <rfc822;linux-kernel@archiver.kernel.org>);
        Thu, 9 Sep 2021 06:15:00 -0400
Received: from mail-dm6nam11on2082.outbound.protection.outlook.com ([40.107.223.82]:52929
        "EHLO NAM11-DM6-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S229980AbhIIKO5 (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Thu, 9 Sep 2021 06:14:57 -0400
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=FOYOhFLVoekUFXeusZb0cXysqEUI+znZuUrm88KUM29HE2KU7FpB4hqYsb1ZLZj7CKHsN+lhs3KAj4v+HIgSn1mEBv1xQDvNYqPTRwg7Aa34Tp6hA4zxekPPY+0er92VFkBBD4MSEg2zYvPpLnvqiAHwu+DvWzsVS4QMV55dlx/fiB7sMt07Gl14AXNyiATNyS/LJwnOaBjY+gjQSjsRPMe4fiYfGkyMmZeK3t9To0txzT8U9rtCP/oEADvjW2yLiocKYkMZoOs0LT8/HGD58FYupllK99zKALwg2NYXHkR+RFjRPN1YKqDEGImMG0KFZPtgVEppctd98TKPfy7OJQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version;
 bh=w508ZaL1ZoIpEhRxkDCJ4Yu40WkhzNdXVU+J9ivvXaA=;
 b=bPQROX1UoZBXP+OUEqUE5f/m4rj3H5Xd0IHKkIu6IONF9SEc5fv6/0SIQAFrqc5JdZD4DcbMiYk56bC3TjVnMc5elU0SDf4fi2ICb5H3GmqtlYOXbT7umX+LGF2xidDIkJ59vojhWxPK83yfp6gbQf4/UqhJug828tbopUQ3Z1wXix+xZZYAyU080siLDz3tLAQu/Po1MAvI22VQmj/0kxYOGt355oqs39tJfyNiNpr700taFV05174jFDAi53UlcsZy2O0tfG6ezdMhAe2tJ9r5MWit6FmQI+jg2azjSEWTCzjhbmLZr3sDTE08oO1iHiuWjtvBMTyRIqNojWbAcg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass (sender ip is
 165.204.84.17) smtp.rcpttodomain=intel.com smtp.mailfrom=amd.com; dmarc=pass
 (p=quarantine sp=quarantine pct=100) action=none header.from=amd.com;
 dkim=none (message not signed); arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=amd.com; s=selector1;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=w508ZaL1ZoIpEhRxkDCJ4Yu40WkhzNdXVU+J9ivvXaA=;
 b=DqP6xztIcORwrwOb/8t2MvwEFnvRJD+5dhKctegR2U2zH7mcPCrMENTURiVErwe6jlrnAQXSbKUdF/Jm6ypvX1rDsLqjGDeM5aUxlcZ6hUi48g5n0X3eew47FELNBzYfYk0HAvOT9MTr8vE3r6qRe/kgQyJeNDz9YncUzDNfIHU=
Received: from DS7PR03CA0024.namprd03.prod.outlook.com (2603:10b6:5:3b8::29)
 by DM5PR12MB1338.namprd12.prod.outlook.com (2603:10b6:3:71::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4478.22; Thu, 9 Sep
 2021 10:13:47 +0000
Received: from DM6NAM11FT010.eop-nam11.prod.protection.outlook.com
 (2603:10b6:5:3b8:cafe::f1) by DS7PR03CA0024.outlook.office365.com
 (2603:10b6:5:3b8::29) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.4500.16 via Frontend
 Transport; Thu, 9 Sep 2021 10:13:47 +0000
X-MS-Exchange-Authentication-Results: spf=pass (sender IP is 165.204.84.17)
 smtp.mailfrom=amd.com; intel.com; dkim=none (message not signed)
 header.d=none;intel.com; dmarc=pass action=none header.from=amd.com;
Received-SPF: Pass (protection.outlook.com: domain of amd.com designates
 165.204.84.17 as permitted sender) receiver=protection.outlook.com;
 client-ip=165.204.84.17; helo=SATLEXMB04.amd.com;
Received: from SATLEXMB04.amd.com (165.204.84.17) by
 DM6NAM11FT010.mail.protection.outlook.com (10.13.172.222) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.20.4500.14 via Frontend Transport; Thu, 9 Sep 2021 10:13:47 +0000
Received: from hr-amd (10.180.168.240) by SATLEXMB04.amd.com (10.181.40.145)
 with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2308.8; Thu, 9 Sep 2021
 05:13:43 -0500
Date:   Thu, 9 Sep 2021 18:12:48 +0800
From:   Huang Rui <ray.huang@amd.com>
To:     "Fontenot, Nathan" <Nathan.Fontenot@amd.com>
CC:     "Rafael J . Wysocki" <rafael.j.wysocki@intel.com>,
        Viresh Kumar <viresh.kumar@linaro.org>,
        Shuah Khan <skhan@linuxfoundation.org>,
        "Borislav Petkov" <bp@suse.de>, Ingo Molnar <mingo@kernel.org>,
        "linux-pm@vger.kernel.org" <linux-pm@vger.kernel.org>,
        "Sharma, Deepak" <Deepak.Sharma@amd.com>,
        "Deucher, Alexander" <Alexander.Deucher@amd.com>,
        "Limonciello, Mario" <Mario.Limonciello@amd.com>,
        "Su, Jinzhou (Joe)" <Jinzhou.Su@amd.com>,
        "Du, Xiaojian" <Xiaojian.Du@amd.com>,
        "linux-kernel@vger.kernel.org" <linux-kernel@vger.kernel.org>,
        "x86@kernel.org" <x86@kernel.org>
Subject: Re: [PATCH 08/19] cpufreq: amd: add boost mode support for amd-pstate
Message-ID: <20210909101248.GE3702717@hr-amd>
References: <20210908150001.3702552-1-ray.huang@amd.com>
 <20210908150001.3702552-9-ray.huang@amd.com>
 <a2718365-5975-5c91-350f-fe9098b4de7b@amd.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="us-ascii"
Content-Disposition: inline
In-Reply-To: <a2718365-5975-5c91-350f-fe9098b4de7b@amd.com>
X-Originating-IP: [10.180.168.240]
X-ClientProxiedBy: SATLEXMB03.amd.com (10.181.40.144) To SATLEXMB04.amd.com
 (10.181.40.145)
X-EOPAttributedMessage: 0
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 520be7cd-dafa-4b79-acd1-08d9737a832d
X-MS-TrafficTypeDiagnostic: DM5PR12MB1338:
X-Microsoft-Antispam-PRVS: <DM5PR12MB1338720FE4087FC2A051209AECD59@DM5PR12MB1338.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:7219;
X-MS-Exchange-SenderADCheck: 1
X-MS-Exchange-AntiSpam-Relay: 0
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: IZ3Hb5wPH43w01HWNjfBkiVnuPDNSYGspv44i9fFYiP1gW6yA/mlaTy6SRYXOUqkzA/mVY4F8tD3G/IWomo89T0TjXHmv9M/Ku+HeXyfo60PFGLKg1le5lHtH7WV7Yllhr44HXJcPLnKvje/WFYyI3lWz5L6gzSkKgCiD/02ObPM3RpBYo2UZfFs/BoYigoldLaQLwIsZeej/LIlAqTjChQkRWGh6STRCCdVxvgIHaJM1E6IwbTT6RueUiSpz0LwbUM5W0TF6Kraj9Uu26yBmi3okqR4qz/qMHMi2aWFjIO/QYQtgrUYYaz5y1q+v499dbCHgUv0RaKF5W8uaRIO91TNZzLPJbehJmmYzhAcJfVpJ6zs6WLWeFqadNBrE3Gi9kkZhYmFCUEHRsSvcBn558hYnZl0M8IBtNb5kdpK/fZAGg2EXB7mpbXJ08isfLzTT898MPPo6OoYo2qSGHg8bmL1H56Q0S+NoiEVOPiHLe0zoMlenbg54R9qvjVLWbxBmOmIxcVYU4KiEoMpmsgEyfHV/ZUdBddMfZ02gKfBcCZP4bi5+ntr3bC2PUx7FLtZnAKCJYB/F4HQ3xvzmkOoRso6FONnwywEeTQszu/pfTFm222GFCNfHBt/nKV9e42SjUctHFdGO675SwP+bbkuLI0sBXBMdYDrqpfslPS+8nhmF/aVjypoWNmW3RgjHZXpC1gQj3GGLPqTAO3YbTd04WrEQqGjJ7tpKK4Tzz6KZP8=
X-Forefront-Antispam-Report: CIP:165.204.84.17;CTRY:US;LANG:en;SCL:1;SRV:;IPV:CAL;SFV:NSPM;H:SATLEXMB04.amd.com;PTR:InfoDomainNonexistent;CAT:NONE;SFS:(4636009)(346002)(39860400002)(376002)(136003)(396003)(36840700001)(46966006)(86362001)(33656002)(356005)(81166007)(2906002)(55016002)(36860700001)(8936002)(82740400003)(8676002)(426003)(336012)(1076003)(47076005)(316002)(33716001)(9686003)(54906003)(4326008)(6862004)(70586007)(82310400003)(70206006)(53546011)(16526019)(186003)(478600001)(6636002)(83380400001)(5660300002)(26005)(36900700001);DIR:OUT;SFP:1101;
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 09 Sep 2021 10:13:47.2729
 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 520be7cd-dafa-4b79-acd1-08d9737a832d
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d;Ip=[165.204.84.17];Helo=[SATLEXMB04.amd.com]
X-MS-Exchange-CrossTenant-AuthSource: DM6NAM11FT010.eop-nam11.prod.protection.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Anonymous
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM5PR12MB1338
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Thu, Sep 09, 2021 at 02:24:54AM +0800, Fontenot, Nathan wrote:
> On 9/8/2021 9:59 AM, Huang Rui wrote:
> > If the sbios supports the boost mode of amd-pstate, let's switch to
> > boost enabled by default.
> > 
> > Signed-off-by: Huang Rui <ray.huang@amd.com>
> > ---
> >  drivers/cpufreq/amd-pstate.c | 50 ++++++++++++++++++++++++++++++++++++
> >  1 file changed, 50 insertions(+)
> > 
> > diff --git a/drivers/cpufreq/amd-pstate.c b/drivers/cpufreq/amd-pstate.c
> > index ea965a122431..67a9a117f524 100644
> > --- a/drivers/cpufreq/amd-pstate.c
> > +++ b/drivers/cpufreq/amd-pstate.c
> > @@ -75,6 +75,8 @@ struct amd_cpudata {
> >  	u32	min_freq;
> >  	u32	nominal_freq;
> >  	u32	lowest_nonlinear_freq;
> > +
> > +	bool	boost_supported;
> >  };
> >  
> >  struct amd_pstate_perf_funcs {
> > @@ -229,6 +231,19 @@ amd_pstate_update(struct amd_cpudata *cpudata, u32 min_perf,
> >  				      max_perf, fast_switch);
> >  }
> >  
> > +static bool amd_pstate_boost_supported(struct amd_cpudata *cpudata)
> > +{
> > +	u32 highest_perf, nominal_perf;
> > +
> > +	highest_perf = READ_ONCE(cpudata->highest_perf);
> > +	nominal_perf = READ_ONCE(cpudata->nominal_perf);
> > +
> > +	if (highest_perf > nominal_perf)
> > +		return true;
> > +
> > +	return false;
> > +}
> > +
> >  static int amd_pstate_verify(struct cpufreq_policy_data *policy)
> >  {
> >  	cpufreq_verify_within_cpu_limits(policy);
> > @@ -402,6 +417,37 @@ static int amd_get_lowest_nonlinear_freq(struct amd_cpudata *cpudata)
> >  	return lowest_nonlinear_freq * 1000;
> >  }
> >  
> > +static int amd_pstate_set_boost(struct cpufreq_policy *policy, int state)
> > +{
> > +	struct amd_cpudata *cpudata = policy->driver_data;
> > +	int ret;
> > +
> > +	if (!cpudata->boost_supported) {
> > +		pr_err("Boost mode is not supported by this processor or SBIOS\n");
> > +		return -EINVAL;
> > +	}
> > +
> > +	if (state)
> > +		policy->cpuinfo.max_freq = cpudata->max_freq;
> > +	else
> > +		policy->cpuinfo.max_freq = cpudata->nominal_freq;
> > +
> > +	policy->max = policy->cpuinfo.max_freq;
> > +
> > +	ret = freq_qos_update_request(&cpudata->req[1],
> > +				      policy->cpuinfo.max_freq);
> > +	if (ret < 0)
> > +		return ret;
> > +
> > +	return 0;
> > +}
> > +
> > +static void amd_pstate_boost_init(struct amd_cpudata *cpudata)
> > +{
> > +	cpudata->boost_supported = true;
> > +	amd_pstate_driver.boost_enabled = true;
> > +}
> > +
> >  static int amd_pstate_init_freqs_in_cpudata(struct amd_cpudata *cpudata,
> >  					    u32 max_freq, u32 min_freq,
> >  					    u32 nominal_freq,
> > @@ -504,6 +550,9 @@ static int amd_pstate_cpu_init(struct cpufreq_policy *policy)
> >  
> >  	policy->driver_data = cpudata;
> >  
> > +	if (amd_pstate_boost_supported(cpudata))
> > +		amd_pstate_boost_init(cpudata);
> 
> Is there any reason to not merge amd_pstate_boost_supported() and
> amd_pstate_boost_init() into a single function? I don't see that
> amd_pstate_boost_supported() is called anywhere else.
> 

Sounds reasonable. Will update it in V2 as well.

Thanks,
Ray

